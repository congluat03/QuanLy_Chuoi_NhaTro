{% extends 'index/index_layout.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="pt-20 pb-16">
  <!-- Hero Section -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-16">
    <div class="max-w-screen-xl mx-auto px-6 text-center">
      <h1 class="text-4xl font-bold mb-4">T√¨m Ph√≤ng Tr·ªç L√Ω T∆∞·ªüng</h1>
      <p class="text-xl mb-8">H∆°n {{ total_phongs }} ph√≤ng tr·ªç ch·∫•t l∆∞·ª£ng ƒëang ch·ªù b·∫°n kh√°m ph√°</p>
    </div>
  </div>

  <div class="max-w-screen-xl mx-auto px-6 -mt-8">
    <!-- Search Filter Card -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <form method="GET" class="space-y-4" id="searchForm">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- T√™n ph√≤ng -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n ph√≤ng</label>
            <input type="text" name="ten_phong" value="{{ filters.ten_phong }}" 
                   placeholder="Nh·∫≠p t√™n ph√≤ng..."
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <!-- Khu v·ª±c -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Khu v·ª±c</label>
            <select name="khu_vuc" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">T·∫•t c·∫£ khu v·ª±c</option>
              {% for kv in khu_vucs %}
                <option value="{{ kv.MA_KHU_VUC }}" {% if filters.khu_vuc == kv.MA_KHU_VUC|stringformat:"s" %}selected{% endif %}>
                  {{ kv.TEN_KHU_VUC }} - {{ kv.MA_NHA_TRO.TEN_NHA_TRO }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Lo·∫°i ph√≤ng -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Lo·∫°i ph√≤ng</label>
            <select name="loai_phong" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="">T·∫•t c·∫£ lo·∫°i ph√≤ng</option>
              {% for lp in loai_phongs %}
                <option value="{{ lp.MA_LOAI_PHONG }}" {% if filters.loai_phong == lp.MA_LOAI_PHONG|stringformat:"s" %}selected{% endif %}>
                  {{ lp.TEN_LOAI_PHONG }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- N√∫t t√¨m ki·∫øm -->
          <div class="flex items-end">
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
              <i class="fas fa-search mr-2"></i>
              T√¨m ki·∫øm
            </button>
          </div>
        </div>

        <!-- Advanced Filters (Collapsible) -->
        <div x-data="{ open: false }" class="mt-4">
          <button type="button" @click="open = !open" class="text-blue-600 hover:text-blue-800 font-medium flex items-center">
            <span x-text="open ? '·∫®n b·ªô l·ªçc n√¢ng cao' : 'Hi·ªán b·ªô l·ªçc n√¢ng cao'"></span>
            <i class="fas fa-chevron-down ml-2 transform transition-transform" :class="{ 'rotate-180': open }"></i>
          </button>
          
          <div x-show="open" x-transition class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Tr·∫°ng th√°i ph√≤ng -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Tr·∫°ng th√°i ph√≤ng</label>
              <select name="trang_thai" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="Tr·ªëng" {% if filters.trang_thai == 'Tr·ªëng' %}selected{% endif %}>üü¢ C√≤n tr·ªëng</option>
                <option value="ƒê√£ thu√™" {% if filters.trang_thai == 'ƒê√£ thu√™' %}selected{% endif %}>üî¥ ƒê√£ thu√™</option>
                <option value="ƒê√£ c·ªçc" {% if filters.trang_thai == 'ƒê√£ c·ªçc' %}selected{% endif %}>üü° ƒê√£ c·ªçc</option>
                <option value="B·∫£o tr√¨" {% if filters.trang_thai == 'B·∫£o tr√¨' %}selected{% endif %}>‚ö´ B·∫£o tr√¨</option>
              </select>
            </div>

            <!-- Gi√° ph√≤ng -->
            <div class="lg:col-span-2">
              <label class="block text-sm font-semibold text-gray-700 mb-2">Kho·∫£ng gi√° (VNƒê)</label>
              <div class="flex space-x-2">
                <input type="number" name="gia_min" value="{{ filters.gia_min }}" 
                       placeholder="T·ª´" min="0" step="100000"
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <span class="flex items-center text-gray-500">-</span>
                <input type="number" name="gia_max" value="{{ filters.gia_max }}" 
                       placeholder="ƒê·∫øn" min="0" step="100000"
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>

            <!-- Di·ªán t√≠ch -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">Di·ªán t√≠ch (m¬≤)</label>
              <div class="flex space-x-2">
                <input type="number" name="dien_tich_min" value="{{ filters.dien_tich_min }}" 
                       placeholder="T·ª´" min="0" step="1"
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <span class="flex items-center text-gray-500">-</span>
                <input type="number" name="dien_tich_max" value="{{ filters.dien_tich_max }}" 
                       placeholder="ƒê·∫øn" min="0" step="1"
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Results Header -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">
        T√¨m th·∫•y {{ total_phongs }} ph√≤ng tr·ªç
      </h2>
      
      <!-- Clear filters if any are active -->
      {% if filters.ten_phong or filters.khu_vuc or filters.loai_phong or filters.gia_min or filters.gia_max or filters.dien_tich_min or filters.dien_tich_max %}
        <a href="{% url 'user_phongtro:tim_phong' %}" class="text-blue-600 hover:text-blue-800 font-medium">
          <i class="fas fa-times mr-1"></i>
          X√≥a b·ªô l·ªçc
        </a>
      {% endif %}
    </div>

    <!-- Results Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
      {% for phong in page_obj %}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 group">
          <!-- Room Image Placeholder -->
          <div class="h-48 bg-gradient-to-br from-blue-400 to-blue-600 relative overflow-hidden">
            <div class="absolute inset-0 flex items-center justify-center text-white">
              <i class="fas fa-home text-4xl opacity-50"></i>
            </div>
            <!-- Status Badge -->
            <div class="absolute top-3 left-3">
              <span class="px-3 py-1 rounded-full text-xs font-semibold
                {% if phong.TRANG_THAI_P == 'Tr·ªëng' %}bg-green-500 text-white
                {% elif phong.TRANG_THAI_P == 'ƒê√£ thu√™' %}bg-red-500 text-white
                {% elif phong.TRANG_THAI_P == 'ƒê√£ c·ªçc' %}bg-yellow-500 text-white
                {% elif phong.TRANG_THAI_P == 'B·∫£o tr√¨' %}bg-gray-500 text-white
                {% else %}bg-blue-500 text-white{% endif %}">
                <i class="fas {% if phong.TRANG_THAI_P == 'Tr·ªëng' %}fa-check-circle{% elif phong.TRANG_THAI_P == 'ƒê√£ thu√™' %}fa-times-circle{% elif phong.TRANG_THAI_P == 'ƒê√£ c·ªçc' %}fa-clock{% else %}fa-info-circle{% endif %} mr-1"></i>
                {{ phong.TRANG_THAI_P }}
              </span>
            </div>
          </div>

          <div class="p-4">
            <!-- Room Title -->
            <h3 class="font-bold text-lg text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">
              {{ phong.TEN_PHONG }}
            </h3>

            <!-- Location -->
            <p class="text-gray-600 text-sm mb-3 flex items-center">
              <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
              {{ phong.MA_KHU_VUC.TEN_KHU_VUC }}, {{ phong.MA_KHU_VUC.MA_NHA_TRO.TEN_NHA_TRO }}
            </p>

            <!-- Room Details -->
            <div class="space-y-2 text-sm text-gray-600 mb-4">
              <div class="flex justify-between">
                <span>Lo·∫°i ph√≤ng:</span>
                <span class="font-medium">{{ phong.MA_LOAI_PHONG.TEN_LOAI_PHONG|default:"Ch∆∞a ph√¢n lo·∫°i" }}</span>
              </div>
              <div class="flex justify-between">
                <span>Di·ªán t√≠ch:</span>
                <span class="font-medium">{{ phong.DIEN_TICH|default:"N/A" }} m¬≤</span>
              </div>
              <div class="flex justify-between">
                <span>S·ª©c ch·ª©a:</span>
                <span class="font-medium">{{ phong.SO_NGUOI_TOI_DA|default:"N/A" }} ng∆∞·ªùi</span>
              </div>
            </div>

            <!-- Price -->
            <div class="text-2xl font-bold text-blue-600 mb-4">
              {{ phong.GIA_PHONG|currency_vn }}
              <span class="text-sm font-normal text-gray-500">/th√°ng</span>
            </div>

            <!-- Action Buttons -->
            <div class="flex space-x-2">
              <a href="{% url 'user_phongtro:chi_tiet_phong' phong.MA_PHONG %}" 
                 class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-center py-2 px-3 rounded-lg transition duration-300 text-sm font-medium">
                Chi ti·∫øt
              </a>
              <a href="{% url 'user_phongtro:dat_phong' phong.MA_PHONG %}" 
                 class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-3 rounded-lg transition duration-300 text-sm font-medium">
                ƒê·∫∑t ph√≤ng
              </a>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="lg:col-span-4 text-center py-16">
          <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">Kh√¥ng t√¨m th·∫•y ph√≤ng tr·ªç n√†o</h3>
          <p class="text-gray-500 mb-4">H√£y th·ª≠ ƒëi·ªÅu ch·ªânh b·ªô l·ªçc t√¨m ki·∫øm c·ªßa b·∫°n</p>
          <a href="{% url 'user_phongtro:tim_phong' %}" class="text-blue-600 hover:text-blue-800 font-medium">
            X√≥a t·∫•t c·∫£ b·ªô l·ªçc
          </a>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
      <div class="flex justify-center">
        <nav class="inline-flex rounded-md shadow">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="px-3 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
              <i class="fas fa-chevron-left"></i>
            </a>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="px-3 py-2 border border-gray-300 bg-blue-600 text-sm font-medium text-white">
                {{ num }}
              </span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                 class="px-3 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                {{ num }}
              </a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
               class="px-3 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
              <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </nav>
      </div>
    {% endif %}
  </div>
</div>

<!-- Quick Actions FAB -->
<div class="fixed bottom-6 right-6 z-10">
  <div x-data="{ open: false }" class="relative">
    <button @click="open = !open" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg transition duration-300">
      <i class="fas fa-plus text-lg"></i>
    </button>
    
    <div x-show="open" x-transition class="absolute bottom-16 right-0 space-y-2">
      <a href="{% url 'user_phongtro:tra_cuu_dat_phong' %}" 
         class="flex items-center bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-lg transition duration-300 whitespace-nowrap">
        <i class="fas fa-search mr-2"></i>
        Tra c·ª©u ƒë·∫∑t ph√≤ng
      </a>
    </div>
  </div>
</div>
{% endblock %}