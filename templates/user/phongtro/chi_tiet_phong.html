{% extends 'index/index_layout.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<!-- External Libraries -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- Alpine.js Components -->
<script>
window.roomDetail = function() {
    return {
        showImageModal: false,
        currentImageIndex: 0,
        images: [],
        showContactModal: false,
        
        init() {
            // Initialize images array
            this.images = Array.from(document.querySelectorAll('.room-image')).map(img => ({
                src: img.src,
                alt: img.alt
            }));
        },
        
        openImageModal(index) {
            this.currentImageIndex = index;
            this.showImageModal = true;
            document.body.style.overflow = 'hidden';
        },
        
        closeImageModal() {
            this.showImageModal = false;
            document.body.style.overflow = 'auto';
        },
        
        nextImage() {
            this.currentImageIndex = (this.currentImageIndex + 1) % this.images.length;
        },
        
        prevImage() {
            this.currentImageIndex = this.currentImageIndex === 0 ? this.images.length - 1 : this.currentImageIndex - 1;
        },
        
        showContact() {
            this.showContactModal = true;
        },
        
        copyPhone(phone) {
            navigator.clipboard.writeText(phone).then(() => {
                this.showNotification('Đã sao chép số điện thoại');
            });
        },
        
        showNotification(message) {
            // Simple notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    };
};
</script>

<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<style>
:root {
    --primary-50: #eff6ff;
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-900: #111827;
}

.btn-primary {
    @apply bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md;
}

.btn-secondary {
    @apply bg-white hover:bg-gray-50 text-gray-700 font-medium py-3 px-6 rounded-lg border border-gray-300 transition-all duration-200;
}

.card {
    @apply bg-white rounded-xl shadow-sm border border-gray-100;
}

.badge {
    @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium;
}

.badge-green { @apply bg-green-100 text-green-800; }
.badge-blue { @apply bg-blue-100 text-blue-800; }
.badge-yellow { @apply bg-yellow-100 text-yellow-800; }
.badge-gray { @apply bg-gray-100 text-gray-800; }

/* Image Gallery Styling */
.swiper-button-next,
.swiper-button-prev {
    color: white !important;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    width: 40px !important;
    height: 40px !important;
    margin-top: -20px !important;
}

.swiper-button-next:after,
.swiper-button-prev:after {
    font-size: 16px !important;
}

.swiper-pagination-bullet {
    background: rgba(255, 255, 255, 0.7) !important;
}

.swiper-pagination-bullet-active {
    background: white !important;
}

/* Feature Icons */
.feature-item {
    @apply flex items-center p-3 bg-gray-50 rounded-lg;
}

.feature-icon {
    @apply w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0;
}

/* Responsive Image Modal */
.image-modal {
    @apply fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4;
}

.image-modal img {
    max-width: 90vw;
    max-height: 90vh;
    object-fit: contain;
}

/* Contact Sticky */
.contact-sticky {
    @apply sticky top-4;
}

@media (max-width: 768px) {
    .contact-sticky {
        @apply static;
    }
}
</style>

<div class="min-h-screen bg-gray-50" x-data="roomDetail()">
    <!-- Breadcrumb -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <nav class="flex items-center space-x-2 text-sm">
                <a href="{% url 'user_phongtro:tim_phong' %}" class="text-gray-500 hover:text-blue-600">Tìm phòng</a>
                <i class="fas fa-chevron-right text-gray-300"></i>
                <a href="{% url 'user_phongtro:tim_phong' %}?khu_vuc={{ phong.MA_KHU_VUC.MA_KHU_VUC }}" class="text-gray-500 hover:text-blue-600">{{ phong.MA_KHU_VUC.TEN_KHU_VUC }}</a>
                <i class="fas fa-chevron-right text-gray-300"></i>
                <span class="text-gray-900 font-medium">{{ tin_dang.TIEU_DE|default:phong.TEN_PHONG }}</span>
            </nav>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Title & Status -->
                <div class="card p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                                {{ tin_dang.TIEU_DE|default:phong.TEN_PHONG }}
                            </h1>
                            <div class="flex items-center text-gray-600 mb-3">
                                <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                                <span>{{ phong.MA_KHU_VUC.TEN_KHU_VUC }}, {{ phong.MA_KHU_VUC.MA_NHA_TRO.TEN_NHA_TRO }}</span>
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span><i class="fas fa-eye mr-1"></i>{{ tin_dang.LUOT_XEM }} lượt xem</span>
                                <span><i class="fas fa-calendar mr-1"></i>{{ tin_dang.NGAY_DANG|date:"d/m/Y" }}</span>
                                {% if tin_dang.NGAY_CAP_NHAT != tin_dang.NGAY_DANG %}
                                    <span><i class="fas fa-sync mr-1"></i>Cập nhật {{ tin_dang.NGAY_CAP_NHAT|date:"d/m/Y" }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="badge badge-green mb-2">
                                <i class="fas fa-check-circle mr-1"></i>
                                Đang cho thuê
                            </span>
                            {% if phong.MA_LOAI_PHONG %}
                                <span class="badge badge-blue">
                                    {{ phong.MA_LOAI_PHONG.TEN_LOAI_PHONG }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Price Display -->
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                        <div>
                            <div class="text-3xl font-bold text-blue-600">
                                {{ phong.GIA_PHONG|currency_vn }}
                                <span class="text-base font-normal text-blue-500">/tháng</span>
                            </div>
                            {% if phong.SO_TIEN_CAN_COC %}
                                <div class="text-sm text-gray-600 mt-1">
                                    Tiền cọc: <span class="font-semibold">{{ phong.SO_TIEN_CAN_COC|currency_vn }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-600 mb-2">Giá/m²</div>
                            {% if phong.DIEN_TICH %}
                                <div class="text-lg font-semibold text-gray-800">
                                    {{ phong.GIA_PHONG|div:phong.DIEN_TICH|floatformat:0|currency_vn }}/m²
                                </div>
                            {% else %}
                                <div class="text-lg font-semibold text-gray-400">N/A</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Image Gallery -->
                <div class="card overflow-hidden">
                    {% if tin_dang.hinh_anh.all %}
                        <div class="swiper room-gallery">
                            <div class="swiper-wrapper">
                                {% for hinh in tin_dang.hinh_anh.all %}
                                    <div class="swiper-slide">
                                        <div class="relative h-96 bg-gray-200 cursor-pointer" 
                                             @click="openImageModal({{ forloop.counter0 }})">
                                            <img src="{{ hinh.HINH_ANH.url }}" 
                                                 alt="Hình ảnh phòng {{ forloop.counter }}"
                                                 class="room-image w-full h-full object-cover">
                                            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 transition-all duration-300 flex items-center justify-center">
                                                <i class="fas fa-search-plus text-white text-2xl opacity-0 hover:opacity-100 transition-opacity duration-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-button-next"></div>
                            <div class="swiper-button-prev"></div>
                            <div class="swiper-pagination"></div>
                        </div>
                        
                        <!-- Thumbnail Gallery -->
                        <div class="p-4 bg-gray-50">
                            <div class="grid grid-cols-6 gap-2">
                                {% for hinh in tin_dang.hinh_anh.all %}
                                    <div class="aspect-square bg-gray-200 rounded-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity"
                                         @click="openImageModal({{ forloop.counter0 }})">
                                        <img src="{{ hinh.HINH_ANH.url }}" 
                                             alt="Thumbnail {{ forloop.counter }}"
                                             class="w-full h-full object-cover">
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="h-96 bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                            <div class="text-center text-white">
                                <i class="fas fa-home text-6xl mb-4 opacity-70"></i>
                                <p class="text-lg">Chưa có hình ảnh</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Room Features -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                        Thông tin phòng
                    </h2>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Diện tích</div>
                                <div class="font-semibold">{{ phong.DIEN_TICH|default:"N/A" }} m²</div>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Sức chứa</div>
                                <div class="font-semibold">{{ phong.SO_NGUOI_TOI_DA|default:"N/A" }} người</div>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-tag"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Loại phòng</div>
                                <div class="font-semibold">{{ phong.MA_LOAI_PHONG.TEN_LOAI_PHONG|default:"Chưa phân loại" }}</div>
                            </div>
                        </div>
                        
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600">Trạng thái</div>
                                <div class="font-semibold text-green-600">{{ phong.TRANG_THAI_P|default:"Sẵn sàng" }}</div>
                            </div>
                        </div>
                    </div>

                    {% if tin_dang.MO_TA_TIN or phong.MO_TA_P %}
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Mô tả chi tiết</h3>
                            <div class="prose max-w-none text-gray-700 leading-relaxed">
                                {{ tin_dang.MO_TA_TIN|default:phong.MO_TA_P|linebreaks }}
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Location Info -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                        Vị trí
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <i class="fas fa-building mr-3 text-gray-400"></i>
                            <div>
                                <div class="font-semibold">{{ phong.MA_KHU_VUC.MA_NHA_TRO.TEN_NHA_TRO }}</div>
                                <div class="text-gray-600">{{ phong.MA_KHU_VUC.MA_NHA_TRO.DIA_CHI }}</div>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <i class="fas fa-map mr-3 text-gray-400"></i>
                            <div>
                                <div class="font-semibold">Khu vực: {{ phong.MA_KHU_VUC.TEN_KHU_VUC }}</div>
                                {% if phong.MA_KHU_VUC.MO_TA_KV %}
                                    <div class="text-gray-600">{{ phong.MA_KHU_VUC.MO_TA_KV }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Map placeholder -->
                    <div class="mt-4 h-48 bg-gray-200 rounded-lg flex items-center justify-center">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-map text-2xl mb-2"></i>
                            <p>Bản đồ vị trí</p>
                            <p class="text-sm">(Sẽ được bổ sung)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="contact-sticky space-y-6">
                    <!-- Contact Card -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-phone mr-2 text-green-500"></i>
                            Thông tin liên hệ
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Phone -->
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-phone text-green-500 mr-3"></i>
                                    <div>
                                        <div class="font-semibold text-green-700">{{ tin_dang.SDT_LIEN_HE }}</div>
                                        <div class="text-sm text-green-600">Số điện thoại</div>
                                    </div>
                                </div>
                                <button @click="copyPhone('{{ tin_dang.SDT_LIEN_HE }}')" 
                                        class="text-green-500 hover:text-green-600 p-2">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            
                            <!-- Email -->
                            {% if tin_dang.EMAIL_LIEN_HE %}
                                <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                                    <i class="fas fa-envelope text-blue-500 mr-3"></i>
                                    <div>
                                        <div class="font-semibold text-blue-700">{{ tin_dang.EMAIL_LIEN_HE }}</div>
                                        <div class="text-sm text-blue-600">Email liên hệ</div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="space-y-3 mt-6">
                            <a href="tel:{{ tin_dang.SDT_LIEN_HE }}" 
                               class="btn-primary w-full text-center block"
                               onclick="incrementContactCount({{ tin_dang.MA_TIN_DANG }})">
                                <i class="fas fa-phone mr-2"></i>
                                Gọi ngay
                            </a>
                            
                            <a href="{% url 'user_phongtro:dat_phong' phong.MA_PHONG %}" 
                               class="btn-secondary w-full text-center block">
                                <i class="fas fa-calendar-check mr-2"></i>
                                Đặt phòng online
                            </a>
                            
                            <button @click="showContact()" 
                                    class="w-full text-center py-2 px-4 text-blue-600 hover:text-blue-700 font-medium">
                                <i class="fas fa-share-alt mr-2"></i>
                                Chia sẻ tin này
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Thống kê</h3>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Lượt xem</span>
                                <span class="font-semibold">{{ tin_dang.LUOT_XEM }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Lượt liên hệ</span>
                                <span class="font-semibold">{{ tin_dang.LUOT_LIEN_HE }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Ngày đăng</span>
                                <span class="font-semibold">{{ tin_dang.NGAY_DANG|date:"d/m/Y" }}</span>
                            </div>
                            {% if tin_dang.NGAY_HET_HANG_TIN %}
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600">Hết hạn</span>
                                    <span class="font-semibold text-orange-600">{{ tin_dang.NGAY_HET_HANG_TIN|date:"d/m/Y" }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Safety Tips -->
                    <div class="card p-6 bg-yellow-50 border-yellow-200">
                        <h3 class="text-lg font-bold text-yellow-800 mb-4">
                            <i class="fas fa-shield-alt mr-2"></i>
                            Lưu ý an toàn
                        </h3>
                        
                        <div class="space-y-2 text-sm text-yellow-700">
                            <p><i class="fas fa-check-circle mr-2"></i>Gặp mặt trực tiếp trước khi đặt cọc</p>
                            <p><i class="fas fa-check-circle mr-2"></i>Xem phòng thật trước khi quyết định</p>
                            <p><i class="fas fa-check-circle mr-2"></i>Đọc kỹ hợp đồng thuê phòng</p>
                            <p><i class="fas fa-check-circle mr-2"></i>Không chuyển tiền qua mạng</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div x-show="showImageModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="image-modal"
         @click.self="closeImageModal()"
         @keydown.escape.window="closeImageModal()">
        
        <div class="relative">
            <img :src="images[currentImageIndex]?.src" 
                 :alt="images[currentImageIndex]?.alt"
                 class="max-w-full max-h-full">
            
            <!-- Navigation -->
            <button @click="prevImage()" 
                    class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-3">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <button @click="nextImage()" 
                    class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-3">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Close -->
            <button @click="closeImageModal()" 
                    class="absolute top-4 right-4 text-white bg-black bg-opacity-50 hover:bg-opacity-70 rounded-full p-3">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Image Counter -->
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white bg-black bg-opacity-50 px-3 py-1 rounded-full text-sm">
                <span x-text="currentImageIndex + 1"></span> / <span x-text="images.length"></span>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize Swiper
document.addEventListener('DOMContentLoaded', function() {
    const swiper = new Swiper('.room-gallery', {
        loop: true,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        autoplay: {
            delay: 5000,
            disableOnInteraction: false,
        },
    });
});

function incrementContactCount(tinDangId) {
    fetch(`/api/tin-dang/${tinDangId}/tang-luot-lien-he/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
            'Content-Type': 'application/json',
        },
    }).catch(error => console.log('Error updating contact count:', error));
}
</script>

{% endblock %}