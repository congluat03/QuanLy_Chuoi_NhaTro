{% extends 'index/index_layout.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="pt-20 pb-16 bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto px-6">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Đặt Phòng Trọ</h1>
      <p class="text-gray-600">Vui lòng điền thông tin để đặt phòng</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Room Info Card -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden sticky top-24">
          <!-- Room Image Placeholder -->
          <div class="h-48 bg-gradient-to-br from-blue-400 to-blue-600 relative overflow-hidden">
            <div class="absolute inset-0 flex items-center justify-center text-white">
              <i class="fas fa-home text-4xl opacity-50"></i>
            </div>
          </div>

          <div class="p-6">
            <h3 class="font-bold text-xl text-gray-800 mb-2">{{ phong.TEN_PHONG }}</h3>
            
            <!-- Location -->
            <p class="text-gray-600 text-sm mb-4 flex items-center">
              <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
              {{ phong.MA_KHU_VUC.TEN_KHU_VUC }}, {{ phong.MA_KHU_VUC.MA_NHA_TRO.TEN_NHA_TRO }}
            </p>

            <!-- Room Details -->
            <div class="space-y-3 text-sm mb-6">
              <div class="flex justify-between py-2 border-b border-gray-100">
                <span class="text-gray-600">Loại phòng:</span>
                <span class="font-medium text-gray-800">{{ phong.MA_LOAI_PHONG.TEN_LOAI_PHONG|default:"Chưa phân loại" }}</span>
              </div>
              <div class="flex justify-between py-2 border-b border-gray-100">
                <span class="text-gray-600">Diện tích:</span>
                <span class="font-medium text-gray-800">{{ phong.DIEN_TICH|default:"N/A" }} m²</span>
              </div>
              <div class="flex justify-between py-2 border-b border-gray-100">
                <span class="text-gray-600">Sức chứa:</span>
                <span class="font-medium text-gray-800">{{ phong.SO_NGUOI_TOI_DA|default:"N/A" }} người</span>
              </div>
              <div class="flex justify-between py-2 border-b border-gray-100">
                <span class="text-gray-600">Tiền cọc đề xuất:</span>
                <span class="font-medium text-blue-600">{{ phong.SO_TIEN_CAN_COC|currency_vn }}</span>
              </div>
            </div>

            <!-- Price -->
            <div class="text-center p-4 bg-blue-50 rounded-lg">
              <div class="text-3xl font-bold text-blue-600 mb-1">
                {{ phong.GIA_PHONG|currency_vn }}
              </div>
              <div class="text-sm text-gray-600">/ tháng</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Booking Form -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-6">Thông tin đặt phòng</h2>
          
          <!-- Messages Alert -->
          {% if messages %}
            {% for message in messages %}
              <div class="mb-4 p-4 rounded-lg border 
                {% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-700
                {% elif message.tags == 'success' %}bg-green-50 border-green-200 text-green-700
                {% elif message.tags == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-700
                {% else %}bg-blue-50 border-blue-200 text-blue-700{% endif %}">
                <div class="flex items-center">
                  <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% elif message.tags == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} mr-2"></i>
                  {{ message }}
                </div>
              </div>
            {% endfor %}
          {% endif %}
          
          <form method="POST" class="space-y-6">
            {% csrf_token %}
            
            <!-- Personal Information -->
            <div>
              <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-user mr-2 text-blue-500"></i>
                Thông tin cá nhân
              </h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="ho_ten" class="block text-sm font-semibold text-gray-700 mb-2">
                    Họ và tên <span class="text-red-500">*</span>
                  </label>
                  <input type="text" id="ho_ten" name="ho_ten" required
                         value="{{ request.POST.ho_ten|default:'' }}"
                         class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                         placeholder="Nhập họ và tên của bạn">
                </div>
                
                <div>
                  <label for="so_dien_thoai" class="block text-sm font-semibold text-gray-700 mb-2">
                    Số điện thoại <span class="text-red-500">*</span>
                  </label>
                  <input type="tel" id="so_dien_thoai" name="so_dien_thoai" required
                         value="{{ request.POST.so_dien_thoai|default:'' }}"
                         class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                         placeholder="Nhập số điện thoại">
                </div>
              </div>
              
              <div class="mt-4">
                <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                  Email (tùy chọn)
                </label>
                <input type="email" id="email" name="email"
                       value="{{ request.POST.email|default:'' }}"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="Nhập email của bạn">
              </div>
            </div>

            <!-- Booking Details -->
            <div>
              <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                Thông tin đặt phòng
              </h3>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="ngay_bat_dau_thue" class="block text-sm font-semibold text-gray-700 mb-2">
                    Ngày dự kiến nhận phòng <span class="text-red-500">*</span>
                  </label>
                  <input type="date" id="ngay_bat_dau_thue" name="ngay_bat_dau_thue" required
                         value="{{ request.POST.ngay_bat_dau_thue|default:'' }}"
                         class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                         min="{{ today|date:'Y-m-d' }}">
                </div>
                
                <div>
                  <label for="so_tien_coc" class="block text-sm font-semibold text-gray-700 mb-2">
                    Số tiền cọc (VNĐ) <span class="text-red-500">*</span>
                  </label>
                  <input type="number" id="so_tien_coc" name="so_tien_coc" required
                         min="100000" step="100000" 
                         value="{{ request.POST.so_tien_coc|default:phong.SO_TIEN_CAN_COC|default:'1000000' }}"
                         class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                         placeholder="Nhập số tiền cọc">
                </div>
              </div>
            </div>

            <!-- Additional Notes -->
            <div>
              <label for="ghi_chu" class="block text-sm font-semibold text-gray-700 mb-2">
                Ghi chú (tùy chọn)
              </label>
              <textarea id="ghi_chu" name="ghi_chu" rows="4"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Nhập ghi chú hoặc yêu cầu đặc biệt...">{{ request.POST.ghi_chu|default:'' }}</textarea>
            </div>

            <!-- Terms and Conditions -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h4 class="font-semibold text-yellow-800 mb-2">
                <i class="fas fa-info-circle mr-2"></i>
                Lưu ý quan trọng:
              </h4>
              <ul class="text-sm text-yellow-700 space-y-1">
                <li>• Đây chỉ là đơn đăng ký đặt phòng, chưa phải hợp đồng chính thức</li>
                <li>• Chúng tôi sẽ liên hệ với bạn trong vòng 24h để xác nhận</li>
                <li>• Sau khi xác nhận, bạn cần đến xem phòng và hoàn tất thủ tục</li>
                <li>• Tiền cọc sẽ được thanh toán khi ký hợp đồng chính thức</li>
              </ul>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
              <a href="{% url 'user_phongtro:chi_tiet_phong' phong.MA_PHONG %}" 
                 class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-center py-3 px-6 rounded-lg transition duration-300 font-medium">
                <i class="fas fa-arrow-left mr-2"></i>
                Quay lại
              </a>
              <button type="submit" 
                      class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg transition duration-300 font-medium">
                <i class="fas fa-paper-plane mr-2"></i>
                Đặt phòng ngay
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to tomorrow
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const dateInput = document.getElementById('ngay_bat_dau_thue');
    dateInput.min = tomorrow.toISOString().split('T')[0];
    
    // Validate date selection
    dateInput.addEventListener('change', function(e) {
        const selectedDate = new Date(e.target.value);
        if (selectedDate <= today) {
            alert('Ngày bắt đầu thuê phải từ ngày mai trở đi.');
            e.target.value = '';
        }
    });
    
    // Format currency input
    const cocInput = document.getElementById('so_tien_coc');
    cocInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value) {
            value = parseInt(value).toLocaleString('vi-VN');
            // Remove the formatted value and keep only numbers for form submission
            e.target.setAttribute('data-value', e.target.value.replace(/\D/g, ''));
        }
    });
});
</script>
{% endblock %}