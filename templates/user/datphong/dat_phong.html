{% extends 'index/index_layout.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<!-- External Libraries -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Alpine.js Components -->
<script>
window.bookingForm = function() {
    return {
        step: 1,
        totalSteps: 2,
        formData: {
            ho_ten: '{{ khach_thue.HO_TEN_KT|default:"" }}',
            so_dien_thoai: '{{ khach_thue.SDT_KT|default:"" }}',
            email: '{{ khach_thue.EMAIL_KT|default:"" }}',
            ngay_du_kien_vao: '',
            tien_coc: {{ phong.SO_TIEN_CAN_COC|default:"0"|floatformat:"0" }},
            ghi_chu: '',
            phuong_thuc_thanh_toan: 'tien_mat'
        },
        errors: {},
        isSubmitting: false,
        
        init() {
            // Initialize date picker
            const dateInput = document.getElementById('ngayVaoInput');
            if (dateInput) {
                flatpickr('#ngayVaoInput', {
                    dateFormat: 'Y-m-d',
                    minDate: 'today',
                    locale: 'vi',
                    onChange: (selectedDates, dateStr) => {
                        this.formData.ngay_du_kien_vao = dateStr;
                        this.validateField('ngay_du_kien_vao');
                    }
                });
            }
            
            // Debug log to check initialization
            console.log('Form initialized with data:', this.formData);
        },
        
        nextStep() {
            console.log('Current step:', this.step);
            console.log('Form data:', this.formData);
            console.log('Errors:', this.errors);
            
            // Clear any existing browser validation messages
            const currentStepElement = document.querySelector(`[x-show="step === ${this.step}"]`);
            if (currentStepElement) {
                const inputs = currentStepElement.querySelectorAll('input');
                inputs.forEach(input => {
                    input.setCustomValidity(''); // Clear custom validity
                });
            }
            
            if (this.validateCurrentStep()) {
                if (this.step < this.totalSteps) {
                    this.step++;
                    console.log('Moving to step:', this.step);
                }
            } else {
                console.log('Validation failed for step:', this.step);
            }
        },
        
        prevStep() {
            if (this.step > 1) {
                this.step--;
            }
        },
        
        validateCurrentStep() {
            this.errors = {};
            let isValid = true;
            
            if (this.step === 1) {
                // Step 1: Validate thông tin cá nhân và thông tin đặt phòng
                
                // Validate thông tin cá nhân (đã có sẵn từ đăng nhập)
                if (!this.formData.ho_ten || !this.formData.ho_ten.trim()) {
                    this.errors.ho_ten = 'Thông tin khách thuê không đầy đủ';
                    isValid = false;
                }
                
                if (!this.formData.so_dien_thoai || !this.formData.so_dien_thoai.trim()) {
                    this.errors.so_dien_thoai = 'Thông tin khách thuê không đầy đủ';
                    isValid = false;
                }
                
                // Validate thông tin đặt phòng
                if (!this.formData.ngay_du_kien_vao) {
                    this.errors.ngay_du_kien_vao = 'Vui lòng chọn ngày dự kiến vào';
                    isValid = false;
                }
                
                // Validate tiền cọc
                if (this.formData.tien_coc <= 0) {
                    this.errors.tien_coc = 'Phòng này chưa thiết lập tiền cọc. Vui lòng liên hệ quản lý.';
                    isValid = false;
                }
            }
            
            if (this.step === 2) {
                // Step 2: Chỉ validate phương thức thanh toán
                console.log('Validating step 2 - payment method:', this.formData.phuong_thuc_thanh_toan);
                
                if (!this.formData.phuong_thuc_thanh_toan) {
                    this.errors.phuong_thuc_thanh_toan = 'Vui lòng chọn phương thức thanh toán';
                    isValid = false;
                }
                
                // Đảm bảo thông tin từ bước 1 vẫn hợp lệ (fail-safe)
                if (!this.formData.ngay_du_kien_vao) {
                    this.errors.general = 'Vui lòng quay lại bước 1 để nhập ngày dự kiến vào';
                    isValid = false;
                }
                
                if (this.formData.tien_coc <= 0) {
                    this.errors.general = 'Có lỗi với tiền cọc phòng. Vui lòng quay lại bước 1';
                    isValid = false;
                }
            }
            
            return isValid;
        },
        
        validateField(fieldName) {
            // Clear browser validation for this field
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                field.setCustomValidity('');
            }
            
            if (this.errors[fieldName]) {
                delete this.errors[fieldName];
                this.validateCurrentStep();
            }
        },
        
        formatCurrency(value) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(value);
        },
        
        async submitForm() {
            if (!this.validateCurrentStep()) {
                return;
            }
            
            this.isSubmitting = true;
            
            try {
                const formData = new FormData();
                for (const [key, value] of Object.entries(this.formData)) {
                    formData.append(key, value);
                }
                
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                // Server sẽ luôn trả về JSON với AJAX request
                const result = await response.json();
                
                if (result.success) {
                    this.showSuccess(result.message || 'Đặt phòng thành công!');              
                } else {
                    // Handle validation errors
                    if (result.errors) {
                        this.errors = result.errors;
                        this.step = 1; // Go back to first step to show errors
                    }
                    this.showError(result.message || 'Có lỗi xảy ra khi đặt phòng.');
                }
            } catch (error) {
                this.showError('Có lỗi xảy ra. Vui lòng thử lại sau.');
                console.error('Booking error:', error);
            } finally {
                this.isSubmitting = false;
            }
        },
        
        showSuccess(message = 'Đặt phòng thành công! Chúng tôi sẽ liên hệ với bạn sớm nhất.') {
            this.showNotification(message, 'success');
        },
        
        showError(message) {
            this.showNotification(message, 'error');
        },
        
        showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-sm`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    };
};
</script>

<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<style>
:root {
    --primary-50: #eff6ff;
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #10b981;
    --error-500: #ef4444;
}

.btn-primary {
    @apply bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed;
}

.btn-secondary {
    @apply bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 px-6 rounded-lg border border-gray-300 transition-all duration-200;
}

.card {
    @apply bg-white rounded-xl shadow-sm border border-gray-100;
}

.form-input {
    @apply w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200;
}

.form-input.error {
    @apply border-red-500 focus:ring-red-500;
}

.form-label {
    @apply block text-sm font-semibold text-gray-700 mb-2;
}

.step-indicator {
    @apply flex items-center justify-center w-10 h-10 rounded-full border-2 transition-all duration-300;
}

.step-indicator.active {
    @apply bg-blue-600 border-blue-600 text-white;
}

.step-indicator.completed {
    @apply bg-green-500 border-green-500 text-white;
}

.step-indicator.inactive {
    @apply bg-gray-100 border-gray-300 text-gray-400;
}

.step-line {
    @apply flex-1 h-0.5 mx-4 transition-all duration-300;
}

.step-line.completed {
    @apply bg-green-500;
}

.step-line.inactive {
    @apply bg-gray-200;
}

/* Animation for step transitions */
.step-content {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Payment method styles */
.payment-method {
    @apply border-2 border-gray-200 rounded-lg p-4 cursor-pointer transition-all duration-200 hover:border-blue-300;
}

.payment-method.selected {
    @apply border-blue-500 bg-blue-50;
}

.payment-method input[type="radio"] {
    @apply sr-only;
}
</style>

<div class="min-h-screen bg-gray-50" x-data="bookingForm()">
    <!-- Header -->
    <div class="bg-white border-b">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Breadcrumb -->
            <nav class="flex items-center space-x-2 text-sm mb-4">
                <a href="{% url 'user_phongtro:tim_phong' %}" class="text-gray-500 hover:text-blue-600">Tìm phòng</a>
                <i class="fas fa-chevron-right text-gray-300"></i>
                <a href="{% url 'user_phongtro:chi_tiet_phong' phong.MA_PHONG %}" class="text-gray-500 hover:text-blue-600">{{ phong.TEN_PHONG }}</a>
                <i class="fas fa-chevron-right text-gray-300"></i>
                <span class="text-gray-900 font-semibold">Đặt phòng</span>
            </nav>
            
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Đặt Phòng Online</h1>
                <p class="text-gray-600">Hoàn thành thông tin để đặt phòng trực tuyến</p>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Form -->
            <div class="lg:col-span-2">
                <!-- Progress Steps -->
                <div class="card p-6 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <!-- Step 1 -->
                        <div class="flex items-center">
                            <div class="step-indicator" 
                                 :class="step >= 1 ? (step > 1 ? 'completed' : 'active') : 'inactive'">
                                <i class="fas" :class="step > 1 ? 'fa-check' : 'fa-user-edit'"></i>
                            </div>
                            <div class="ml-3 hidden sm:block">
                                <div class="text-sm font-semibold text-gray-900">Xác nhận thông tin & Đặt phòng</div>
                                <div class="text-xs text-gray-500">Thông tin cá nhân, ngày vào, ghi chú</div>
                            </div>
                        </div>
                        
                        <div class="step-line" :class="step > 1 ? 'completed' : 'inactive'"></div>
                        
                        <!-- Step 2 -->
                        <div class="flex items-center">
                            <div class="step-indicator" 
                                 :class="step >= 2 ? 'active' : 'inactive'">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="ml-3 hidden sm:block">
                                <div class="text-sm font-semibold text-gray-900">Thanh toán</div>
                                <div class="text-xs text-gray-500">Chọn phương thức thanh toán</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Steps -->
                <div class="card p-6">
                    <form @submit.prevent="submitForm()" novalidate>
                        {% csrf_token %}
                        
                        <!-- Step 1: Personal Information & Booking Details -->
                        <div x-show="step === 1" class="step-content">
                            <h2 class="text-xl font-bold text-gray-900 mb-6">
                                <i class="fas fa-user-edit mr-2 text-blue-500"></i>
                                Xác nhận thông tin & Đặt phòng
                            </h2>
                            
                            <!-- Personal Information Section -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                                <div class="flex items-center mb-4">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <h3 class="font-semibold text-green-800 text-lg">Thông tin khách thuê</h3>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">Họ tên:</span>
                                        <span class="font-medium ml-2">{{ khach_thue.HO_TEN_KT }}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Số điện thoại:</span>
                                        <span class="font-medium ml-2">{{ khach_thue.SDT_KT }}</span>
                                    </div>
                                    {% if khach_thue.EMAIL_KT %}
                                    <div class="md:col-span-2">
                                        <span class="text-gray-600">Email:</span>
                                        <span class="font-medium ml-2">{{ khach_thue.EMAIL_KT }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-3 pt-3 border-t border-green-200 flex items-center justify-between">
                                    <p class="text-sm text-green-700">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Thông tin được lấy từ tài khoản đã đăng nhập
                                    </p>
                                    <a href="{% url 'dungchung:profile' %}" class="text-blue-600 hover:text-blue-700 text-sm">
                                        <i class="fas fa-edit mr-1"></i>Cập nhật thông tin
                                    </a>
                                </div>
                            </div>

                            <!-- Booking Details Section -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-blue-900 mb-4">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    Thông tin đặt phòng
                                </h3>
                                
                                <div class="space-y-4">
                                    <!-- Move-in Date -->
                                    <div>
                                        <label class="form-label">
                                            Ngày dự kiến vào ở <span class="text-red-500">*</span>
                                        </label>
                                        <input type="date" 
                                               id="ngayVaoInput"
                                               name="ngay_du_kien_vao"
                                               x-model="formData.ngay_du_kien_vao"
                                               @input="validateField('ngay_du_kien_vao')"
                                               class="form-input"
                                               :class="errors.ngay_du_kien_vao ? 'error' : ''"
                                               :required="step === 1"
                                               placeholder="Chọn ngày">
                                        <div x-show="errors.ngay_du_kien_vao" class="text-red-500 text-sm mt-1" x-text="errors.ngay_du_kien_vao"></div>
                                        <div class="text-gray-500 text-sm mt-1">
                                            Chọn ngày bạn dự định chuyển đến ở
                                        </div>
                                    </div>
                                    
                                    <!-- Deposit Amount -->
                                    <div>
                                        <label class="form-label">
                                            Tiền cọc phòng
                                        </label>
                                        <div class="bg-white border border-blue-300 rounded-lg px-4 py-3">
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-700">Số tiền cần cọc:</span>
                                                <span class="text-xl font-bold text-blue-600">{{ phong.SO_TIEN_CAN_COC|currency_vn|default:"Chưa thiết lập" }}</span>
                                            </div>
                                        </div>
                                        <div class="text-gray-500 text-sm mt-1">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Số tiền cọc được thiết lập bởi chủ nhà trọ
                                        </div>
                                        <!-- Hidden input để gửi giá trị -->
                                        <input type="hidden" name="tien_coc" :value="formData.tien_coc">
                                    </div>
                                    
                                    <!-- Notes -->
                                    <div>
                                        <label class="form-label">
                                            Ghi chú thêm
                                        </label>
                                        <textarea x-model="formData.ghi_chu"
                                                  name="ghi_chu"
                                                  class="form-input h-24 resize-none"
                                                  placeholder="Ghi chú về yêu cầu đặc biệt, thời gian thuận tiện liên hệ..."></textarea>
                                        <div class="text-gray-500 text-sm mt-1">
                                            Mọi yêu cầu đặc biệt hoặc câu hỏi bạn muốn gửi đến chủ trọ
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Payment -->
                        <div x-show="step === 2" class="step-content">
                            <h2 class="text-xl font-bold text-gray-900 mb-6">
                                <i class="fas fa-credit-card mr-2 text-green-500"></i>
                                Thanh toán đặt phòng
                            </h2>
                            
                            <!-- Booking Summary -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                                <h3 class="text-lg font-semibold text-blue-900 mb-4">
                                    <i class="fas fa-clipboard-list mr-2"></i>
                                    Tóm tắt đặt phòng
                                </h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Phòng:</span>
                                            <span class="font-medium">{{ phong.TEN_PHONG }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Khách thuê:</span>
                                            <span class="font-medium">{{ khach_thue.HO_TEN_KT }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Số điện thoại:</span>
                                            <span class="font-medium">{{ khach_thue.SDT_KT }}</span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Ngày vào:</span>
                                            <span class="font-medium" x-text="formData.ngay_du_kien_vao ? new Date(formData.ngay_du_kien_vao).toLocaleDateString('vi-VN') : 'Chưa chọn'"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Tiền cọc:</span>
                                            <span class="font-medium text-blue-600">{{ phong.SO_TIEN_CAN_COC|currency_vn }}</span>
                                        </div>
                                        <div class="flex justify-between" x-show="formData.ghi_chu">
                                            <span class="text-gray-600">Ghi chú:</span>
                                            <span class="font-medium" x-text="formData.ghi_chu"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Method Section -->
                            <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
                                <h3 class="text-xl font-bold text-gray-900 mb-6">
                                    <i class="fas fa-credit-card mr-2 text-blue-500"></i>
                                    Chọn phương thức thanh toán
                                </h3>
                                
                                <div class="space-y-4 mb-6">
                                    <!-- Tiền mặt -->
                                    <label class="payment-method block cursor-pointer" :class="formData.phuong_thuc_thanh_toan === 'tien_mat' ? 'selected' : ''">
                                        <input type="radio" 
                                               name="phuong_thuc_thanh_toan" 
                                               value="tien_mat"
                                               x-model="formData.phuong_thuc_thanh_toan"
                                               @change="validateField('phuong_thuc_thanh_toan')"
                                               class="sr-only">
                                        <div class="flex items-center">
                                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                                <i class="fas fa-money-bills text-green-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-gray-900">Tiền mặt</div>
                                                <div class="text-sm text-gray-600">Thanh toán trực tiếp bằng tiền mặt khi gặp mặt</div>
                                            </div>
                                            <div class="text-right flex items-center">
                                                <span class="text-green-600 font-medium mr-3 text-sm">Khuyến nghị</span>
                                                <i class="fas fa-check-circle text-green-500 text-xl transition-opacity duration-200" 
                                                   :class="formData.phuong_thuc_thanh_toan === 'tien_mat' ? 'opacity-100' : 'opacity-0'"></i>
                                            </div>
                                        </div>
                                    </label>
                                    
                                    <!-- Chuyển khoản -->
                                    <label class="payment-method block cursor-pointer" :class="formData.phuong_thuc_thanh_toan === 'chuyen_khoan' ? 'selected' : ''">
                                        <input type="radio" 
                                               name="phuong_thuc_thanh_toan" 
                                               value="chuyen_khoan"
                                               x-model="formData.phuong_thuc_thanh_toan"
                                               @change="validateField('phuong_thuc_thanh_toan')"
                                               class="sr-only">
                                        <div class="flex items-center">
                                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                                <i class="fas fa-university text-blue-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-gray-900">Chuyển khoản ngân hàng</div>
                                                <div class="text-sm text-gray-600">Chuyển khoản qua ngân hàng hoặc ví điện tử</div>
                                            </div>
                                            <div class="text-right">
                                                <i class="fas fa-check-circle text-green-500 text-xl transition-opacity duration-200" 
                                                   :class="formData.phuong_thuc_thanh_toan === 'chuyen_khoan' ? 'opacity-100' : 'opacity-0'"></i>
                                            </div>
                                        </div>
                                    </label>
                                    
                                    <!-- Thẻ ATM -->
                                    <label class="payment-method block cursor-pointer" :class="formData.phuong_thuc_thanh_toan === 'online' ? 'selected' : ''">
                                        <input type="radio" 
                                               name="phuong_thuc_thanh_toan" 
                                               value="online"
                                               x-model="formData.phuong_thuc_thanh_toan"
                                               @change="validateField('phuong_thuc_thanh_toan')"
                                               class="sr-only">
                                        <div class="flex items-center">
                                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                                                <i class="fas fa-credit-card text-purple-600 text-xl"></i>
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-gray-900">Thẻ ATM/Visa</div>
                                                <div class="text-sm text-gray-600">Thanh toán qua thẻ ATM hoặc thẻ tín dụng</div>
                                            </div>
                                            <div class="text-right">
                                                <i class="fas fa-check-circle text-green-500 text-xl transition-opacity duration-200" 
                                                   :class="formData.phuong_thuc_thanh_toan === 'online' ? 'opacity-100' : 'opacity-0'"></i>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                
                                <div x-show="errors.phuong_thuc_thanh_toan" class="text-red-500 text-sm mt-2" x-text="errors.phuong_thuc_thanh_toan"></div>
                                <div x-show="errors.general" class="text-red-500 text-sm mt-2 p-3 bg-red-50 border border-red-200 rounded-lg" x-text="errors.general"></div>
                            </div>

                            <!-- Terms & Conditions -->
                            <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-4">
                                <h3 class="font-semibold text-yellow-800 mb-3">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Lưu ý quan trọng
                                </h3>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li class="flex items-start">
                                        <i class="fas fa-check mr-2 mt-0.5 flex-shrink-0"></i>
                                        Việc thanh toán này chỉ là cam kết đặt phòng
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check mr-2 mt-0.5 flex-shrink-0"></i>
                                        Chủ trọ sẽ liên hệ xác nhận trong vòng 24h
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check mr-2 mt-0.5 flex-shrink-0"></i>
                                        Vui lòng gặp mặt trực tiếp để ký hợp đồng chính thức
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check mr-2 mt-0.5 flex-shrink-0"></i>
                                        Có thể được hoàn tiền nếu không phù hợp
                                    </li>
                                </ul>
                            </div>
                        </div>


                        <!-- Navigation Buttons -->
                        <div class="flex justify-between mt-8 pt-6 border-t">
                            <button type="button" 
                                    @click="prevStep()"
                                    x-show="step > 1"
                                    class="btn-secondary">
                                <i class="fas fa-arrow-left mr-2"></i>
                                Quay lại
                            </button>
                            
                            <div class="ml-auto">
                                <button type="button" 
                                        @click="nextStep()"
                                        x-show="step < totalSteps"
                                        class="btn-primary">
                                    Tiếp tục
                                    <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                                
                                <button type="submit" 
                                        x-show="step === totalSteps"
                                        :disabled="isSubmitting"
                                        class="btn-primary">
                                    <span x-show="!isSubmitting">
                                        <i class="fas fa-credit-card mr-2"></i>
                                        Xác nhận đặt phòng & Thanh toán
                                    </span>
                                    <span x-show="isSubmitting">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>
                                        Đang xử lý...
                                    </span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="sticky top-4 space-y-6">
                    <!-- Room Summary -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Thông tin phòng</h3>
                        
                        <div class="space-y-4">
                            <!-- Room Image -->
                            <div class="h-32 bg-gray-200 rounded-lg overflow-hidden">
                                {% if phong.tin_dang.hinh_anh_dai_dien %}
                                    <img src="{{ phong.tin_dang.hinh_anh_dai_dien.HINH_ANH.url }}" 
                                         alt="{{ phong.TEN_PHONG }}"
                                         class="w-full h-full object-cover">
                                {% else %}
                                    <div class="w-full h-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center">
                                        <i class="fas fa-home text-2xl text-white opacity-70"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Room Details -->
                            <div>
                                <h4 class="font-bold text-gray-900 mb-2">{{ phong.TEN_PHONG }}</h4>
                                <p class="text-gray-600 text-sm flex items-center mb-2">
                                    <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>
                                    {{ phong.MA_KHU_VUC.TEN_KHU_VUC }}, {{ phong.MA_KHU_VUC.MA_NHA_TRO.TEN_NHA_TRO }}
                                </p>
                                
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div class="flex items-center">
                                        <i class="fas fa-expand-arrows-alt mr-2 text-gray-400"></i>
                                        <span>{{ phong.DIEN_TICH|default:"N/A" }} m²</span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-users mr-2 text-gray-400"></i>
                                        <span>{{ phong.SO_NGUOI_TOI_DA|default:"N/A" }} người</span>
                                    </div>
                                    {% if phong.MA_LOAI_PHONG %}
                                        <div class="flex items-center col-span-2">
                                            <i class="fas fa-tag mr-2 text-gray-400"></i>
                                            <span>{{ phong.MA_LOAI_PHONG.TEN_LOAI_PHONG }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="card p-6 bg-blue-50 border-blue-200">
                        <h3 class="text-lg font-bold text-blue-900 mb-4">Chi phí</h3>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-blue-700">Giá thuê/tháng</span>
                                <span class="font-bold text-blue-900">{{ phong.GIA_PHONG|currency_vn }}</span>
                            </div>
                            {% if phong.SO_TIEN_CAN_COC %}
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-700">Tiền cọc đề xuất</span>
                                    <span class="font-bold text-blue-900">{{ phong.SO_TIEN_CAN_COC|currency_vn }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Booking Progress (step 1) -->
                    <div x-show="step === 1" class="card p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-clipboard-check mr-2 text-blue-500"></i>
                            Tiến trình đặt phòng
                        </h3>
                        
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Chọn phòng</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-circle text-blue-500 mr-2"></i>
                                <span class="font-medium">Nhập thông tin đặt phòng</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-circle text-gray-300 mr-2"></i>
                                <span class="text-gray-500">Thanh toán</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Summary (step 2) -->
                    <div x-show="step === 2" class="card p-6 mb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">
                            <i class="fas fa-receipt mr-2 text-green-500"></i>
                            Hóa đơn thanh toán
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Customer Info -->
                            <div class="border-b border-gray-200 pb-4">
                                <h4 class="font-semibold text-gray-900 mb-2">Thông tin khách thuê</h4>
                                <div class="text-sm space-y-1">
                                    <p><span class="text-gray-600">Họ tên:</span> {{ khach_thue.HO_TEN_KT }}</p>
                                    <p><span class="text-gray-600">SĐT:</span> {{ khach_thue.SDT_KT }}</p>
                                    <p x-show="formData.ngay_du_kien_vao"><span class="text-gray-600">Ngày vào:</span> <span x-text="formData.ngay_du_kien_vao ? new Date(formData.ngay_du_kien_vao).toLocaleDateString('vi-VN') : ''"></span></p>
                                </div>
                            </div>
                            
                            <!-- Payment Details -->
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">Chi phí</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Tiền cọc phòng:</span>
                                        <span class="font-medium">{{ phong.SO_TIEN_CAN_COC|currency_vn }}</span>
                                    </div>
                                    <div class="border-t border-gray-200 pt-2 mt-3">
                                        <div class="flex justify-between items-center">
                                            <span class="font-semibold text-gray-900">Tổng thanh toán:</span>
                                            <span class="font-bold text-xl text-green-600">{{ phong.SO_TIEN_CAN_COC|currency_vn }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="card p-6 bg-blue-50 border-blue-200">
                        <h3 class="text-lg font-bold text-blue-900 mb-4">
                            <i class="fas fa-headset mr-2"></i>
                            Hỗ trợ khách hàng
                        </h3>
                        
                        <div class="space-y-3 text-sm text-blue-700">
                            <p class="flex items-center">
                                <i class="fas fa-phone mr-2"></i>
                                <span>{{ phong.tin_dang.SDT_LIEN_HE|default:"0123456789" }}</span>
                            </p>
                            <p class="flex items-center">
                                <i class="fas fa-envelope mr-2"></i>
                                <span>{{ phong.tin_dang.EMAIL_LIEN_HE|default:"support@nhatro.com" }}</span>
                            </p>
                            <p class="flex items-center">
                                <i class="fas fa-clock mr-2"></i>
                                <span>24/7 - Luôn sẵn sàng hỗ trợ</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}