{% extends 'admin/admin_layout.html' %}
{% load static %}

{% block title %}ƒêƒÉng tin ph√≤ng m·ªõi{% endblock %}

{% block content_body %}
<div class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-plus-circle text-green-600 mr-3"></i>
                        ƒêƒÉng tin ph√≤ng m·ªõi
                    </h1>
                    <p class="text-gray-600">Ch·ªçn ph√≤ng tr·ªëng v√† upload h√¨nh ·∫£nh ƒë·ªÉ ƒëƒÉng tin</p>
                </div>
                <a href="{% url 'admin_phongtro:dang_tin_list' %}" 
                   class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Quay l·∫°i
                </a>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="max-w-screen-xl mx-auto flex h-screen">
            <!-- Left Sidebar - 30% -->
            <div class="w-[30%] bg-white border-r border-gray-200 flex flex-col rounded-l-xl shadow-lg">
                <!-- Filter Section -->
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
                        </svg>
                        Danh s√°ch ph√≤ng
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="searchRoom" class="block text-sm font-medium text-gray-700 mb-2">
                                T√¨m ki·∫øm ph√≤ng
                            </label>
                            <input type="text" id="searchRoom" placeholder="Nh·∫≠p t√™n ph√≤ng..."
                                   class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-sm">
                        </div>
                        
                        <div>
                            <label for="filterKhuVuc" class="block text-sm font-medium text-gray-700 mb-2">
                                Khu v·ª±c
                            </label>
                            <select id="filterKhuVuc" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-sm">
                                <option value="">T·∫•t c·∫£ khu v·ª±c</option>
                                {% for khu_vuc in khu_vucs %}
                                <option value="{{ khu_vuc.MA_KHU_VUC }}">{{ khu_vuc.TEN_KHU_VUC }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Room List -->
                <div class="flex-1 overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h4 class="text-sm font-medium text-gray-700 uppercase tracking-wide">Ph√≤ng c√≥ th·ªÉ ƒëƒÉng tin</h4>
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn ph√≤ng ƒë·ªÉ ƒëƒÉng tin</p>
                    </div>
                    
                    <div id="room_list_container" class="flex-1 overflow-y-auto">
                        <div id="room_list" class="p-4">
                            {% if phong_chua_dang %}
                                {% for phong in phong_chua_dang %}
                                <div class="room-card bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:border-blue-300 hover:shadow-md transition-all duration-200 cursor-pointer"
                                     data-ma-phong="{{ phong.MA_PHONG }}"
                                     data-khu-vuc="{{ phong.MA_KHU_VUC.MA_KHU_VUC }}"
                                     data-ten-phong="{{ phong.TEN_PHONG|lower }}"
                                     onclick="selectRoom({{ phong.MA_PHONG }}, '{{ phong.TEN_PHONG }}', {{ phong.GIA_PHONG }}, '{{ phong.MA_KHU_VUC.TEN_KHU_VUC }}', '{{ phong.MA_LOAI_PHONG.TEN_LOAI_PHONG }}', {{ phong.DIEN_TICH }})">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-gray-900">{{ phong.TEN_PHONG }}</h4>
                                                <p class="text-sm text-gray-500">{{ phong.MA_KHU_VUC.TEN_KHU_VUC }}</p>
                                            </div>
                                        </div>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></span>
                                            {{ phong.TRANG_THAI_P }}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div class="flex items-center">
                                            <i class="fas fa-tag text-blue-500 w-4 mr-1"></i>
                                            <span>{{ phong.MA_LOAI_PHONG.TEN_LOAI_PHONG }}</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-money-bill-wave text-green-500 w-4 mr-1"></i>
                                            <span>{{ phong.GIA_PHONG|floatformat:0 }} VNƒê/th√°ng</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fas fa-expand-arrows-alt text-purple-500 w-4 mr-1"></i>
                                            <span>{{ phong.DIEN_TICH }} m¬≤</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="text-center py-12 text-gray-500">
                                <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                <p class="text-sm">Kh√¥ng c√≥ ph√≤ng n√†o ƒë·ªÉ ƒëƒÉng tin</p>
                                <p class="text-xs text-gray-400 mt-1">Ph√≤ng c·∫ßn c√≥ tr·∫°ng th√°i "Tr·ªëng"</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Content - 70% -->
            <div class="w-[70%] bg-gray-50 flex flex-col overflow-auto rounded-r-xl shadow-lg">
                <!-- Content Header -->
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Form ƒëƒÉng tin ph√≤ng</h3>
                            <p class="text-sm text-gray-600" id="selected_room_info">Ch∆∞a ch·ªçn ph√≤ng</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="room_info_badge" class="hidden px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                                Ph√≤ng ch∆∞a ch·ªçn
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Form Content -->
                <div class="flex-1 overflow-y-auto">
                    <form method="POST" enctype="multipart/form-data" id="dangTinForm" class="h-full">
                        {% csrf_token %}
                        <input type="hidden" id="ma_phong" name="ma_phong" value="">
                        
                        <div id="main_content" class="p-6">
                            <!-- Empty State -->
                            <div id="empty_state" class="flex flex-col items-center justify-center h-96 text-gray-500">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Ch∆∞a ch·ªçn ph√≤ng</h3>
                                <p class="text-sm text-gray-600 text-center max-w-md">
                                    Vui l√≤ng ch·ªçn m·ªôt ph√≤ng t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu t·∫°o tin ƒëƒÉng
                                </p>
                            </div>

                            <!-- Posting Form -->
                            <div id="posting_form" class="hidden space-y-6">
                                <!-- Room Info Display -->
                                <div id="room_display" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-900 mb-2">Th√¥ng tin ph√≤ng ƒë√£ ch·ªçn</h4>
                                    <div id="room_details" class="text-sm text-blue-800">
                                        <!-- Room details will be filled by JavaScript -->
                                    </div>
                                </div>

                                <!-- Posting Information -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-edit text-blue-500 mr-2"></i>
                                        Th√¥ng tin tin ƒëƒÉng
                                    </h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Ti√™u ƒë·ªÅ tin ƒëƒÉng <span class="text-red-500">*</span>
                                            </label>
                                            <input type="text" name="tieu_de" required maxlength="200"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Nh·∫≠p ti√™u ƒë·ªÅ h·∫•p d·∫´n cho tin ƒëƒÉng (t·ªëi thi·ªÉu 10 k√Ω t·ª±)">
                                            <p class="text-xs text-gray-500 mt-1">Ti√™u ƒë·ªÅ n√™n ng·∫Øn g·ªçn, s√∫c t√≠ch v√† h·∫•p d·∫´n</p>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-align-left text-purple-500 mr-2"></i>
                                                M√¥ t·∫£ chi ti·∫øt
                                            </label>
                                            
                                            <!-- Rich Text Editor Container -->
                                            <div class="bg-white border border-gray-300 rounded-lg overflow-hidden">
                                                <div class="border-b border-gray-200 bg-gray-50 px-4 py-2">
                                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                                        <i class="fas fa-info-circle text-blue-500"></i>
                                                        <span class="font-medium">G·ª£i √Ω n·ªôi dung:</span>
                                                        <span class="hidden lg:inline">Di·ªán t√≠ch, ti·ªán nghi, v·ªã tr√≠, gi√° ƒëi·ªán n∆∞·ªõc, quy ƒë·ªãnh...</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="relative">
                                                    <textarea id="mo_ta_tin_editor" name="mo_ta_tin" 
                                                              class="w-full min-h-[300px] border-0 focus:ring-0 resize-none"
                                                              placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ ph√≤ng tr·ªç c·ªßa b·∫°n..."></textarea>
                                                </div>
                                                
                                                <!-- Quick Insert Templates -->
                                                <div class="border-t border-gray-200 bg-gray-50 p-3">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <span class="text-xs font-medium text-gray-600 uppercase tracking-wide">M·∫´u n·ªôi dung nhanh</span>
                                                        <button type="button" id="toggle-templates" class="text-xs text-blue-600 hover:text-blue-800">
                                                            <i class="fas fa-chevron-down mr-1"></i>Xem m·∫´u
                                                        </button>
                                                    </div>
                                                    
                                                    <div id="content-templates" class="hidden space-y-2">
                                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                            <button type="button" class="template-btn bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg p-2 text-left text-xs transition-colors"
                                                                    data-template="room-info">
                                                                <div class="font-medium text-blue-800">üìè Th√¥ng tin ph√≤ng</div>
                                                                <div class="text-blue-600">Di·ªán t√≠ch, n·ªôi th·∫•t, ti·ªán nghi...</div>
                                                            </button>
                                                            
                                                            <button type="button" class="template-btn bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg p-2 text-left text-xs transition-colors"
                                                                    data-template="location">
                                                                <div class="font-medium text-green-800">üìç V·ªã tr√≠ & Giao th√¥ng</div>
                                                                <div class="text-green-600">ƒê·ªãa ch·ªâ, g·∫ßn tr∆∞·ªùng h·ªçc, b·ªánh vi·ªán...</div>
                                                            </button>
                                                            
                                                            <button type="button" class="template-btn bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 rounded-lg p-2 text-left text-xs transition-colors"
                                                                    data-template="utilities">
                                                                <div class="font-medium text-yellow-800">üí° Ti·ªán √≠ch & D·ªãch v·ª•</div>
                                                                <div class="text-yellow-600">Internet, gi·∫∑t ·ªßi, b·∫£o v·ªá...</div>
                                                            </button>
                                                            
                                                            <button type="button" class="template-btn bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg p-2 text-left text-xs transition-colors"
                                                                    data-template="rules">
                                                                <div class="font-medium text-purple-800">üìã Quy ƒë·ªãnh & Ch√≠nh s√°ch</div>
                                                                <div class="text-purple-600">Gi·ªù gi·∫•c, th√∫ c∆∞ng, kh√°ch...</div>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Character Counter -->
                                            <div class="flex items-center justify-between mt-2">
                                                <p class="text-xs text-gray-500">M√¥ t·∫£ chi ti·∫øt gi√∫p thu h√∫t nhi·ªÅu kh√°ch thu√™ h∆°n</p>
                                                <span id="char-count" class="text-xs text-gray-400">0 k√Ω t·ª±</span>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Ng√†y h·∫øt h·∫°n tin
                                            </label>
                                            <input type="date" name="ngay_het_hang_tin"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <p class="text-xs text-gray-500 mt-1">ƒê·ªÉ tr·ªëng s·∫Ω t·ª± ƒë·ªông ƒë·∫∑t h·∫°n 30 ng√†y</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Information -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-phone text-green-500 mr-2"></i>
                                        Th√¥ng tin li√™n h·ªá
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                S·ªë ƒëi·ªán tho·∫°i <span class="text-red-500">*</span>
                                            </label>
                                            <input type="tel" name="sdt_lien_he" required
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                Email li√™n h·ªá
                                            </label>
                                            <input type="email" name="email_lien_he"
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   placeholder="Nh·∫≠p email (t√πy ch·ªçn)">
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Images -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-images text-purple-500 mr-2"></i>
                                        H√¨nh ·∫£nh ph√≤ng <span class="text-red-500">*</span>
                                    </h4>
                                    <p class="text-gray-500 text-sm mb-4">Ch·ªçn nhi·ªÅu h√¨nh ·∫£nh ƒë·ªÉ hi·ªÉn th·ªã ph√≤ng m·ªôt c√°ch t·ªët nh·∫•t. H√¨nh ƒë·∫ßu ti√™n s·∫Ω l√†m ·∫£nh ƒë·∫°i di·ªán.</p>
                                    
                                    <!-- Drop zone -->
                                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer">
                                        <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-4"></i>
                                        <p class="text-gray-600 mb-2">K√©o th·∫£ h√¨nh ·∫£nh v√†o ƒë√¢y ho·∫∑c <span class="text-blue-600 font-semibold">nh·∫•p ƒë·ªÉ ch·ªçn</span></p>
                                        <p class="text-gray-500 text-sm">H·ªó tr·ª£: JPG, PNG, WEBP. T·ªëi ƒëa 5MB m·ªói ·∫£nh.</p>
                                        <input type="file" id="fileInput" name="hinh_anh" multiple accept="image/*" class="hidden" required>
                                    </div>
                                    
                                    <!-- Preview container -->
                                    <div id="imagePreview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Sticky Footer -->
                        <div id="form_footer" class="hidden bg-white border-t border-gray-200 px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    ƒêƒÉng tin ph√≤ng tr·ªç l√™n giao di·ªán t√¨m ph√≤ng
                                </div>
                                <div class="flex gap-4">
                                    <button type="button" onclick="history.back()" 
                                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                                        H·ªßy
                                    </button>
                                    <button type="submit" id="submitBtn" disabled
                                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        <i class="fas fa-paper-plane mr-2"></i>
                                        ƒêƒÉng tin
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- TinyMCE from official CDN - more reliable -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js"></script>

<script>
// Global variables
let selectedFiles = [];
let currentSelectedRoom = null;

// Content templates for quick insertion
const contentTemplates = {
    'room-info': `
<h3>üè† Th√¥ng tin ph√≤ng</h3>
<ul>
<li><strong>Di·ªán t√≠ch:</strong> [ƒêi·ªÅn di·ªán t√≠ch] m¬≤</li>
<li><strong>N·ªôi th·∫•t:</strong> [Gi∆∞·ªùng, t·ªß, b√†n gh·∫ø, t·ªß l·∫°nh, m√°y l·∫°nh...]</li>
<li><strong>Ti·ªán nghi:</strong> [WC ri√™ng, ban c√¥ng, c·ª≠a s·ªï l·ªõn...]</li>
<li><strong>T√¨nh tr·∫°ng:</strong> [M·ªõi x√¢y, ƒë√£ qua s·ª≠ d·ª•ng, ƒë∆∞·ª£c tu s·ª≠a...]</li>
</ul>`,
    
    'location': `
<h3>üìç V·ªã tr√≠ & Giao th√¥ng</h3>
<ul>
<li><strong>ƒê·ªãa ch·ªâ:</strong> [ƒê·ªãa ch·ªâ c·ª• th·ªÉ]</li>
<li><strong>G·∫ßn tr∆∞·ªùng h·ªçc:</strong> [T√™n tr∆∞·ªùng, kho·∫£ng c√°ch]</li>
<li><strong>G·∫ßn b·ªánh vi·ªán:</strong> [T√™n b·ªánh vi·ªán, kho·∫£ng c√°ch]</li>
<li><strong>Giao th√¥ng c√¥ng c·ªông:</strong> [Xe bus, t√†u ƒëi·ªán, xe √¥m...]</li>
<li><strong>Ch·ª£, si√™u th·ªã:</strong> [C√°c ƒëi·ªÉm mua s·∫Øm g·∫ßn ƒë√≥]</li>
</ul>`,
    
    'utilities': `
<h3>üí° Ti·ªán √≠ch & D·ªãch v·ª•</h3>
<ul>
<li><strong>Internet:</strong> [WiFi mi·ªÖn ph√≠, t·ªëc ƒë·ªô cao]</li>
<li><strong>ƒêi·ªán n∆∞·ªõc:</strong> [Gi√° ƒëi·ªán/s·ªë, gi√° n∆∞·ªõc/s·ªë]</li>
<li><strong>D·ªãch v·ª• gi·∫∑t ·ªßi:</strong> [C√≥/kh√¥ng, gi√° c·∫£]</li>
<li><strong>B·∫£o v·ªá 24/7:</strong> [C√≥/kh√¥ng]</li>
<li><strong>Camera an ninh:</strong> [C√≥/kh√¥ng]</li>
<li><strong>Ch·ªó ƒë·ªÉ xe:</strong> [C√≥/kh√¥ng, gi√° c·∫£]</li>
</ul>`,
    
    'rules': `
<h3>üìã Quy ƒë·ªãnh & Ch√≠nh s√°ch</h3>
<ul>
<li><strong>Gi·ªù gi·∫•c:</strong> [Gi·ªù v√†o ra, gi·ªù im l·∫∑ng]</li>
<li><strong>Th√∫ c∆∞ng:</strong> [C√≥ ƒë∆∞·ª£c nu√¥i hay kh√¥ng]</li>
<li><strong>Kh√°ch ƒë·∫øn thƒÉm:</strong> [Quy ƒë·ªãnh v·ªÅ kh√°ch]</li>
<li><strong>Ti·ªÅn c·ªçc:</strong> [S·ªë ti·ªÅn, ch√≠nh s√°ch ho√†n tr·∫£]</li>
<li><strong>H·ª£p ƒë·ªìng:</strong> [Th·ªùi h·∫°n t·ªëi thi·ªÉu]</li>
<li><strong>Thanh to√°n:</strong> [H√†ng th√°ng, ƒë·ªãnh k·ª≥]</li>
</ul>`
};

// Character counter function - Define before TinyMCE init
function updateCharCount() {
    let charCount = 0;
    const maxChars = 5000;
    
    // Try TinyMCE first
    const editor = tinymce.get('mo_ta_tin_editor');
    if (editor) {
        const content = editor.getContent({ format: 'text' });
        charCount = content.length;
    } else {
        // Fallback to textarea
        const textarea = $('#mo_ta_tin_editor');
        if (textarea.length) {
            charCount = textarea.val().length;
        }
    }
    
    $('#char-count').text(`${charCount.toLocaleString()} / ${maxChars.toLocaleString()} k√Ω t·ª±`);
    
    // Color coding based on usage
    if (charCount > maxChars * 0.9) {
        $('#char-count').removeClass('text-gray-400 text-yellow-500').addClass('text-red-500');
    } else if (charCount > maxChars * 0.7) {
        $('#char-count').removeClass('text-gray-400 text-red-500').addClass('text-yellow-500');
    } else {
        $('#char-count').removeClass('text-red-500 text-yellow-500').addClass('text-gray-400');
    }
}

// Form validation function - Define before TinyMCE init
function checkFormValid() {
    const tieuDe = $('input[name="tieu_de"]').val() || '';
    const isValid = currentSelectedRoom && selectedFiles.length > 0 && tieuDe.trim().length >= 10;
    $('#submitBtn').prop('disabled', !isValid);
}

// Try alternative CDN if first one fails
function loadTinyMCEFallback() {
    console.log('Loading TinyMCE from alternative CDN...');
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/tinymce@7/tinymce.min.js';
    script.onload = function() {
        console.log('TinyMCE loaded from alternative CDN');
        setTimeout(initTinyMCE, 100);
    };
    script.onerror = function() {
        console.error('Failed to load TinyMCE from alternative CDN, using fallback editor');
        initFallbackEditor();
    };
    document.head.appendChild(script);
}

// Initialize TinyMCE
function initTinyMCE() {
    if (typeof tinymce === 'undefined') {
        console.error('TinyMCE not loaded from primary CDN. Trying alternative...');
        loadTinyMCEFallback();
        return;
    }
    
    // Suppress TinyMCE deprecation warnings in development
    const originalWarn = console.warn;
    console.warn = function(message) {
        if (typeof message === 'string' && message.includes('-ms-high-contrast')) {
            return; // Suppress this specific warning
        }
        originalWarn.apply(console, arguments);
    };
    
    // Clear any existing TinyMCE instances
    tinymce.remove('#mo_ta_tin_editor');

    tinymce.init({
        selector: '#mo_ta_tin_editor',
        height: 350,
        menubar: false,
        branding: false,
        resize: true,
        readonly: false,
        disabled: false,
        
        // Fix for read-only issue
        init_instance_callback: function(editor) {
            // TinyMCE 6.x doesn't use setMode, ensure editor is not readonly
            if (editor.getParam('readonly')) {
                editor.setParam('readonly', false);
            }
        },
        
        // Plugins for rich functionality
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
            'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'table', 'wordcount'
        ],
        
        // Simplified toolbar to avoid conflicts
        toolbar: 'undo redo | formatselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright | bullist numlist | outdent indent | removeformat | code fullscreen',
        
        // Content formatting
        formats: {
            h1: { block: 'h1', styles: { fontSize: '24px', fontWeight: 'bold', color: '#111827', marginBottom: '12px' } },
            h2: { block: 'h2', styles: { fontSize: '20px', fontWeight: '600', color: '#1f2937', marginBottom: '8px' } },
            h3: { block: 'h3', styles: { fontSize: '18px', fontWeight: '500', color: '#374151', marginBottom: '8px' } },
        },
        
        // Content styles - Updated for modern CSS
        content_style: `
            body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                font-size: 14px; 
                line-height: 1.6;
                color: #374151;
                padding: 15px;
                background-color: white;
            }
            h1, h2, h3 { margin-top: 20px; margin-bottom: 10px; }
            ul, ol { margin: 10px 0; padding-left: 30px; }
            li { margin: 5px 0; }
            p { margin: 10px 0; }
            strong { font-weight: 600; color: #1f2937; }
            
            /* Modern high contrast support */
            @media (forced-colors: active) {
                body { color: CanvasText; background: Canvas; }
                strong { color: CanvasText; }
                h1, h2, h3 { color: CanvasText; }
            }
        `,
        
        // Setup callback
        setup: function(editor) {
            editor.on('init', function() {
                // TinyMCE 6.x: Ensure editor is not readonly instead of setMode
                if (editor.getParam('readonly')) {
                    editor.setParam('readonly', false);
                }
                editor.focus();
                updateCharCount();
            });
            
            editor.on('keyup change paste', function() {
                updateCharCount();
                checkFormValid();
            });
        },
        
        // Paste settings
        paste_auto_cleanup_on_paste: true,
        paste_remove_styles: false,
        
        // Remove read-only restrictions
        forced_root_block: 'p',
        force_br_newlines: false,
        convert_urls: false
    }).catch(function(error) {
        console.error('TinyMCE initialization failed:', error);
        initFallbackEditor();
    });
}

// Fallback editor if TinyMCE fails
function initFallbackEditor() {
    console.log('Using fallback textarea editor');
    
    const textarea = $('#mo_ta_tin_editor');
    textarea.removeClass('hidden').show();
    
    // Add basic formatting buttons
    const toolbar = $(`
        <div class="tinymce-fallback-toolbar border-b p-2 bg-gray-50 flex gap-2 flex-wrap">
            <button type="button" class="format-btn px-2 py-1 text-xs border rounded hover:bg-gray-100" data-format="bold">
                <strong>B</strong>
            </button>
            <button type="button" class="format-btn px-2 py-1 text-xs border rounded hover:bg-gray-100" data-format="italic">
                <em>I</em>
            </button>
            <button type="button" class="format-btn px-2 py-1 text-xs border rounded hover:bg-gray-100" data-format="h3">
                H3
            </button>
            <button type="button" class="format-btn px-2 py-1 text-xs border rounded hover:bg-gray-100" data-format="ul">
                ‚Ä¢ List
            </button>
        </div>
    `);
    
    textarea.parent().prepend(toolbar);
    
    // Handle formatting buttons
    $('.format-btn').click(function(e) {
        e.preventDefault();
        const format = $(this).data('format');
        const textArea = document.getElementById('mo_ta_tin_editor');
        const start = textArea.selectionStart;
        const end = textArea.selectionEnd;
        const selectedText = textArea.value.substring(start, end);
        
        let replacement = '';
        switch(format) {
            case 'bold':
                replacement = `**${selectedText || 'text'}**`;
                break;
            case 'italic':
                replacement = `*${selectedText || 'text'}*`;
                break;
            case 'h3':
                replacement = `### ${selectedText || 'Ti√™u ƒë·ªÅ'}`;
                break;
            case 'ul':
                replacement = `‚Ä¢ ${selectedText || 'M·ª•c danh s√°ch'}`;
                break;
        }
        
        textArea.setRangeText(replacement, start, end, 'end');
        textArea.focus();
        updateCharCount();
    });
    
    // Update character count for fallback
    textarea.on('input keyup paste', updateCharCount);
    updateCharCount();
}

// Initialize main functionality
function initializeDangTin() {
    // Check jQuery
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded. Retrying in 100ms...');
        setTimeout(initializeDangTin, 100);
        return;
    }

    console.log('jQuery loaded successfully');
    $(document).ready(function() {
    // Define DOM elements first
    const fileInput = $('#fileInput')[0];
    const dropZone = $('#dropZone')[0];
    const imagePreview = $('#imagePreview')[0];
    
    // Define functions first
    function filterRooms() {
        const searchTerm = $('#searchRoom').val().toLowerCase();
        const selectedKhuVuc = $('#filterKhuVuc').val();
        
        $('.room-card').each(function() {
            const roomName = $(this).data('ten-phong');
            const khuVuc = $(this).data('khu-vuc').toString();
            
            const matchesSearch = !searchTerm || roomName.includes(searchTerm);
            const matchesKhuVuc = !selectedKhuVuc || khuVuc === selectedKhuVuc;
            
            if (matchesSearch && matchesKhuVuc) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }
    
    // Search and filter event listeners
    $('#searchRoom').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        filterRooms();
    });
    
    $('#filterKhuVuc').on('change', function() {
        filterRooms();
    });
    
    // Define image handling functions first
    function updateImagePreview() {
        $(imagePreview).html('');
        if (selectedFiles.length > 0) {
            $(imagePreview).removeClass('hidden');
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = $(`
                        <div class="relative group">
                            <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg border">
                            <button type="button" onclick="removeImage(${index})" 
                                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 transition-colors">
                                √ó
                            </button>
                            ${index === 0 ? '<div class="absolute bottom-1 left-1 bg-green-500 text-white px-1 py-0.5 rounded text-xs">·∫¢nh ƒë·∫°i di·ªán</div>' : ''}
                        </div>
                    `);
                    $(imagePreview).append(div);
                };
                reader.readAsDataURL(file);
            });
        } else {
            $(imagePreview).addClass('hidden');
        }
    }
    
    function handleFiles(files) {
        selectedFiles = Array.from(files);
        updateImagePreview();
        checkFormValid();
    }

    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }
    
    // Global function to remove image
    window.removeImage = function(index) {
        selectedFiles.splice(index, 1);
        updateFileInput();
        updateImagePreview();
        checkFormValid();
    }
    
    // Global function to select room
    window.selectRoom = function(maPhong, tenPhong, giaPhong, khuVuc, loaiPhong, dienTich) {
        // Remove previous selection
        $('.room-card').removeClass('border-blue-500 bg-blue-50');
        
        // Add selection to current room
        $(`.room-card[data-ma-phong="${maPhong}"]`).addClass('border-blue-500 bg-blue-50');
        
        // Update hidden input
        $('#ma_phong').val(maPhong);
        currentSelectedRoom = { maPhong, tenPhong, giaPhong, khuVuc, loaiPhong, dienTich };
        
        // Update UI
        $('#selected_room_info').text(`ƒê√£ ch·ªçn: ${tenPhong}`);
        $('#room_info_badge').removeClass('hidden').text(tenPhong);
        
        // Show form content
        $('#empty_state').addClass('hidden');
        $('#posting_form').removeClass('hidden');
        $('#form_footer').removeClass('hidden');
        
        // Update room display
        $('#room_details').html(`
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><strong>T√™n ph√≤ng:</strong> ${tenPhong}</div>
                <div><strong>Khu v·ª±c:</strong> ${khuVuc}</div>
                <div><strong>Lo·∫°i ph√≤ng:</strong> ${loaiPhong}</div>
                <div><strong>Di·ªán t√≠ch:</strong> ${dienTich} m¬≤</div>
                <div class="col-span-2"><strong>Gi√° ph√≤ng:</strong> ${formatCurrency(giaPhong)}/th√°ng</div>
            </div>
        `);
        
        checkFormValid();
    };
    
    // Drop zone events
    $('#dropZone').on('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        $(dropZone).addClass('border-blue-500 bg-blue-50');
    });
    
    dropZone.addEventListener('dragleave', () => {
        $(dropZone).removeClass('border-blue-500 bg-blue-50');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        $(dropZone).removeClass('border-blue-500 bg-blue-50');
        handleFiles(e.dataTransfer.files);
    });
    
    $(fileInput).on('change', (e) => {
        handleFiles(e.target.files);
    });
    
    // Real-time validation for title
    $(document).on('input', 'input[name="tieu_de"]', function() {
        const value = $(this).val();
        const parent = $(this).parent();
        
        // Remove existing validation message
        parent.find('.validation-message').remove();
        
        if (value.length > 0 && value.length < 10) {
            $(this).addClass('border-red-500');
            parent.append('<p class="validation-message text-xs text-red-500 mt-1">Ti√™u ƒë·ªÅ ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±</p>');
        } else if (value.length >= 10) {
            $(this).removeClass('border-red-500').addClass('border-green-500');
            parent.append('<p class="validation-message text-xs text-green-500 mt-1">Ti√™u ƒë·ªÅ h·ª£p l·ªá</p>');
        } else {
            $(this).removeClass('border-red-500 border-green-500');
        }
        
        checkFormValid();
    });
    
    // Set minimum date for expiry date
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    $('input[name="ngay_het_hang_tin"]').attr('min', tomorrow.toISOString().split('T')[0]);
    
    // Initialize TinyMCE
    initTinyMCE();
    
    // Template functionality
    $('#toggle-templates').click(function() {
        const $templates = $('#content-templates');
        const $icon = $(this).find('i');
        
        $templates.toggleClass('hidden');
        
        if ($templates.hasClass('hidden')) {
            $icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            $(this).find('span').text('Xem m·∫´u');
        } else {
            $icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            $(this).find('span').text('·∫®n m·∫´u');
        }
    });
    
    // Template insertion
    $('.template-btn').click(function() {
        const template = $(this).data('template');
        const content = contentTemplates[template];
        
        if (content && tinymce.get('mo_ta_tin_editor')) {
            const editor = tinymce.get('mo_ta_tin_editor');
            const currentContent = editor.getContent();
            
            // Add template content
            if (currentContent.trim()) {
                editor.setContent(currentContent + '<br><br>' + content);
            } else {
                editor.setContent(content);
            }
            
            // Focus editor
            editor.focus();
            
            // Update character count
            updateCharCount();
            
            // Visual feedback
            $(this).addClass('bg-gray-100 scale-95').removeClass('hover:bg-blue-100 hover:bg-green-100 hover:bg-yellow-100 hover:bg-purple-100');
            setTimeout(() => {
                $(this).removeClass('bg-gray-100 scale-95');
                // Re-add appropriate hover class based on template type
                const templateType = $(this).data('template');
                if (templateType === 'room-info') $(this).addClass('hover:bg-blue-100');
                else if (templateType === 'location') $(this).addClass('hover:bg-green-100');
                else if (templateType === 'utilities') $(this).addClass('hover:bg-yellow-100');
                else if (templateType === 'rules') $(this).addClass('hover:bg-purple-100');
            }, 200);
        }
    });
    
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(amount);
    }
    
    // Form validation before submit
    $('#dangTinForm').submit(function(e) {
        if (!currentSelectedRoom) {
            e.preventDefault();
            alert('Vui l√≤ng ch·ªçn ph√≤ng tr∆∞·ªõc khi ƒëƒÉng tin.');
            return;
        }
        
        if (selectedFiles.length === 0) {
            e.preventDefault();
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh.');
            return;
        }
        
        // Sync TinyMCE content to textarea before submit
        const editor = tinymce.get('mo_ta_tin_editor');
        if (editor) {
            editor.save(); // This saves the content to the original textarea
            
            // Check content length
            const content = editor.getContent({ format: 'text' });
            if (content.length > 5000) {
                e.preventDefault();
                alert('M√¥ t·∫£ qu√° d√†i. Vui l√≤ng gi·∫£m xu·ªëng d∆∞·ªõi 5,000 k√Ω t·ª±.');
                return;
            }
        }
        
        // Show loading state
        $('#submitBtn').prop('disabled', true).html(`
            <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            ƒêang ƒëƒÉng tin...
        `);
    });
    });
}

// Kh·ªüi t·∫°o khi DOM loaded ho·∫∑c khi jQuery s·∫µn s√†ng
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDangTin);
} else {
    initializeDangTin();
}
</script>
{% endblock %}