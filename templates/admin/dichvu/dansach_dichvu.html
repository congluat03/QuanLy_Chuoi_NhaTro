{% extends 'admin/admin_layout.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content_body %}
<div class="w-full px-4 sm:px-8">
  <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-8">
        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-10 gap-4 sm:gap-6">
            <h4 class="text-3xl font-extrabold text-gray-800 flex items-center">
                <svg class="w-8 h-8 text-blue-700 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Qu·∫£n l√Ω D·ªãch v·ª•
            </h4>
            <div class="flex flex-wrap sm:flex-nowrap items-center gap-3">
                <button onclick="showModalDichVu('themMoi')"
                        class="inline-flex items-center px-5 py-2.5 bg-blue-600 text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition duration-300 shadow">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    Th√™m d·ªãch v·ª• m·ªõi
                </button>
            </div>
        </div>

        <!-- Th√¥ng b√°o -->
        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="p-4 mb-2 rounded {% if message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Danh s√°ch d·ªãch v·ª• v√† th·ªëng k√™ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
            <!-- Danh s√°ch d·ªãch v·ª• -->
            <div class="md:col-span-1">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Danh s√°ch d·ªãch v·ª•</h4>
                <div class="space-y-4 max-h-[500px] overflow-y-auto">
                    {% for service in dich_vus %}
                        <div class="border rounded-lg p-4 shadow flex gap-4 items-start">
                            <div class="text-2xl text-indigo-500">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <div class="flex-1">
                                <div class="font-medium">{{ service.TEN_DICH_VU }}</div>
                                <p class="text-sm text-gray-600">
                                    {{ service.GIA_DICH_VU|floatformat:0 }} ‚Ç´ / {{ service.DON_VI_TINH }}
                                </p>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button onclick="showModalDichVu('chiSua', {{ service.MA_DICH_VU }})"
                                        class="text-blue-500 hover:text-blue-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </button>
                                <form action="{% url 'dichvu:xoa_dich_vu' service.MA_DICH_VU %}" method="POST" 
                                    onsubmit="return confirm('D·ªãch v·ª• n√†y {% if service.is_applied %}ƒëang ƒë∆∞·ª£c √°p d·ª•ng v√†o khu v·ª±c. {% endif %}B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d·ªãch v·ª• v√† t·∫•t c·∫£ c√°c √°p d·ª•ng li√™n quan kh√¥ng?')">
                                    {% csrf_token %}
                                    <input type="hidden" name="confirm_delete" value="true">
                                    <button type="submit" class="text-red-500 hover:text-red-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4m-4 4v12m4-12v12"></path>
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Th·ªëng k√™ -->
            <div class="md:col-span-4 md:pl-1">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold text-gray-700">Th·ªëng k√™ m·ªói th√°ng</h4>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 w-full">
                    <!-- Ti√™u ƒë·ªÅ v√† n√∫t ·ªü c√πng h√†ng -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-lg font-semibold text-gray-800">üîç B·ªô l·ªçc th·ªëng k√™ d·ªãch v·ª•</h2>

                        <div class="flex gap-3">
                        <button type="button"
                                class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition duration-300 shadow"
                                onclick="fetchThongKeDichVu()">
                            üìä Th·ªëng k√™
                        </button>

                        <button type="button"
                                class="bg-green-600 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-green-700 transition duration-300 shadow flex items-center"
                                onclick="exportExcel()">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Xu·∫•t Excel
                        </button>
                        </div>
                    </div>

                    <!-- B·ªô l·ªçc -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5 mb-6">
                        <!-- Khu v·ª±c -->
                        <div>
                        <label for="khuVuc" class="block text-sm font-medium text-gray-700 mb-1">Khu v·ª±c</label>
                        <select id="khuVuc" name="khuVuc"
                                class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                            <option value="" disabled selected>Ch·ªçn khu v·ª±c</option>
                            <option value="all">T·∫•t c·∫£ khu v·ª±c</option>
                            {% for khu_vuc in khu_vucs %}
                            <option value="{{ khu_vuc.MA_KHU_VUC }}">{{ khu_vuc.TEN_KHU_VUC }}</option>
                            {% endfor %}
                        </select>
                        </div>
                        <div>
                        <label for="phongTro" class="block text-sm font-medium text-gray-700 mb-1">Ph√≤ng tr·ªç</label>
                        <select id="phongTro" name="phongTro"
                                class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                            <option value="all">T·∫•t c·∫£ ph√≤ng</option>
                            {% for phong in phong_tros %}
                            <option value="{{ phong.MA_PHONG }}">{{ phong.TEN_PHONG }}</option>
                            {% endfor %}
                        </select>
                        </div>

                        <!-- Th√°ng -->
                        <!-- Th√°ng -->
                        <div>
                            <label for="month" class="block text-sm font-medium text-gray-700 mb-1">Th√°ng</label>

                            <div class="flex items-center rounded-lg border border-gray-300 overflow-hidden shadow-sm focus-within:ring-2 focus-within:ring-blue-500">
                                <!-- Input th√°ng -->
                                <input type="month" id="month" name="month"
                                class="w-full px-4 py-2 text-sm text-gray-700 focus:outline-none focus:ring-0 border-r border-gray-300"
                                value="{% now 'Y-m' %}">

                                <!-- Checkbox t·∫•t c·∫£ th√°ng -->
                                <label for="all_months"
                                class="flex items-center px-3 py-2 bg-gray-50 text-sm text-gray-600 whitespace-nowrap"
                                    title="T·∫•t c·∫£ c√°c th√°ng">
                                <input type="checkbox" id="all_months" onchange="toggleMonthInput(this)"
                                        class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </label>
                            </div>
                        </div>



                        <!-- Lo·∫°i d·ªãch v·ª• -->
                        <div>
                            <label for="loaiDichVu" class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i d·ªãch v·ª•</label>
                            <select id="loaiDichVu" name="loaiDichVu"
                                    class="w-full rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                                <option value="" disabled selected>Ch·ªçn lo·∫°i d·ªãch v·ª•</option>
                                <option value="all">T·∫•t c·∫£ lo·∫°i d·ªãch v·ª•</option>
                                <option value="C·ªë ƒë·ªãnh">C·ªë ƒë·ªãnh</option>
                                <option value="T√≠nh theo ch·ªâ s·ªë">T√≠nh theo ch·ªâ s·ªë</option>
                            </select>
                        </div>
                        <!-- Ph√≤ng tr·ªç -->
                        
                    </div>

                    <!-- K·∫øt qu·∫£ th·ªëng k√™ -->
                    <div id="table_thongke_dichvu" class="overflow-auto max-h-[440px] rounded-lg border border-gray-100 shadow-inner bg-gray-50">
                        <!-- N·ªôi dung th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal Th√™m/S·ª≠a d·ªãch v·ª• -->
<div id="serviceModal" tabindex="-1" aria-modal="true" role="dialog"
    class="fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300 ease-in-out"
    onclick="if(event.target === this) toggleServiceModal(false)">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl mx-4 max-h-[92vh] overflow-y-auto">
        <!-- Header -->
        <div class="flex items-center justify-center relative px-6 py-4 bg-blue-600 rounded-t-xl">
            <h5 id="serviceModalLabel" class="text-white text-xl font-semibold text-center flex-grow">
                <!-- Ti√™u ƒë·ªÅ s·∫Ω thay ƒë·ªïi theo mode -->
            </h5>
            <button type="button" aria-label="Close"
                    class="absolute right-6 top-1/2 transform -translate-y-1/2 text-white text-3xl font-bold leading-none hover:text-blue-300 focus:outline-none"
                    onclick="toggleServiceModal(false)">
                √ó
            </button>
        </div>
        <!-- Body -->
        <div id="serviceModalContent" class="px-10 py-8">
            <!-- N·ªôi dung s·∫Ω load ƒë·ªông ·ªü ƒë√¢y -->
        </div>
    </div>
</div>
   
<script>
  document.addEventListener('DOMContentLoaded', function () {
    new Choices('#phongTro1', {
      removeItemButton: true,
      placeholder: true,
      placeholderValue: 'Ch·ªçn ph√≤ng tr·ªç',
      searchEnabled: true
    });
    new Choices('#dichVu1', {
      removeItemButton: true,
      placeholder: true,
      placeholderValue: 'Ch·ªçn d·ªãch v·ª•',
      searchEnabled: true
    });
  });
  function toggleMonthInput(checkbox) {
    const monthInput = document.getElementById('month');
    if (checkbox.checked) {
      monthInput.disabled = true;
      monthInput.name = ""; // ƒë·ªÉ kh√¥ng submit gi√° tr·ªã th√°ng
      // B·∫°n c√≥ th·ªÉ th√™m hidden input n·∫øu mu·ªën g·ª≠i gi√° tr·ªã "all"
      if (!document.getElementById("month_hidden")) {
        const input = document.createElement("input");
        input.type = "hidden";
        input.id = "month_hidden";
        input.name = "month";
        input.value = "all";
        monthInput.parentNode.appendChild(input);
      }
    } else {
      monthInput.disabled = false;
      monthInput.name = "month";
      const hidden = document.getElementById("month_hidden");
      if (hidden) hidden.remove();
    }
  }
</script>
<script src="{% static 'js/admin/dichvu/dichvu.js' %}"></script>
<script src="{% static 'js/admin/dichvu/themsua_dichvu.js' %}"></script>
{% endblock %}