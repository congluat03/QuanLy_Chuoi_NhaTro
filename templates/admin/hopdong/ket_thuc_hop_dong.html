{% extends 'admin/admin_layout.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Kết thúc Hợp đồng {{ hop_dong.MA_HOP_DONG }}{% endblock %}

{% block content_body %}
<div class="min-h-screen bg-gray-100 py-6">
    {% csrf_token %}
    <div class="max-w-6xl mx-auto px-4">
        
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-stop-circle text-red-600 mr-3"></i>
                        Kết thúc Hợp đồng #{{ hop_dong.MA_HOP_DONG }}
                    </h1>
                    <p class="text-gray-600 mt-2">
                        Phòng {{ hop_dong.MA_PHONG.TEN_PHONG }} - {{ hop_dong.MA_PHONG.MA_KHU_VUC.TEN_KHU_VUC }}
                    </p>
                </div>
                <a href="{% url 'admin_hopdong:hopdong_list' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Quay lại danh sách
                </a>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-center space-x-8">
                <div class="flex items-center space-x-3" id="step-indicator-1">
                    <div class="w-10 h-10 rounded-full bg-red-600 text-white font-bold flex items-center justify-center">1</div>
                    <span class="text-red-600 font-medium">Xác nhận thông tin</span>
                </div>
                <div class="flex-1 h-1 bg-gray-300 mx-4">
                    <div class="h-full bg-gray-300 transition-all duration-500" id="progress-1" style="width: 0%"></div>
                </div>
                <div class="flex items-center space-x-3" id="step-indicator-2">
                    <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-500 font-bold flex items-center justify-center">2</div>
                    <span class="text-gray-500 font-medium">Xử lý công nợ</span>
                </div>
                <div class="flex-1 h-1 bg-gray-300 mx-4">
                    <div class="h-full bg-gray-300 transition-all duration-500" id="progress-2" style="width: 0%"></div>
                </div>
                <div class="flex items-center space-x-3" id="step-indicator-3">
                    <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-500 font-bold flex items-center justify-center">3</div>
                    <span class="text-gray-500 font-medium">Hóa đơn kết thúc</span>
                </div>
            </div>
        </div>

        <!-- Step Content -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            
            <!-- Bước 1: Xác nhận thông tin -->
            <div id="step-content-1" class="p-8">
                <div class="bg-blue-50 rounded-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-blue-800 mb-3">
                        <i class="fas fa-info-circle mr-3"></i>
                        Bước 1: Xác nhận thông tin hợp đồng
                    </h2>
                    <p class="text-blue-700">Vui lòng kiểm tra và xác nhận thông tin hợp đồng trước khi tiến hành kết thúc.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Thông tin hợp đồng hiện tại -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-file-contract text-blue-600 mr-2"></i>
                            Thông tin hợp đồng hiện tại
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Mã hợp đồng:</span>
                                <span class="font-semibold">{{ hop_dong.MA_HOP_DONG }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Phòng:</span>
                                <span class="font-semibold">{{ hop_dong.MA_PHONG.TEN_PHONG }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Khu vực:</span>
                                <span class="font-semibold">{{ hop_dong.MA_PHONG.MA_KHU_VUC.TEN_KHU_VUC }}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Ngày nhận phòng:</span>
                                <span class="font-semibold text-green-600">
                                    {% if hop_dong.NGAY_NHAN_PHONG %}{{ hop_dong.NGAY_NHAN_PHONG|date:"d/m/Y" }}{% else %}-{% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Ngày trả phòng dự kiến:</span>
                                <span class="font-semibold text-orange-600">
                                    {% if hop_dong.NGAY_TRA_PHONG %}{{ hop_dong.NGAY_TRA_PHONG|date:"d/m/Y" }}{% else %}-{% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                <span class="text-gray-600">Giá thuê:</span>
                                <span class="font-semibold text-blue-600">
                                    {% if hop_dong.GIA_THUE %}{{ hop_dong.GIA_THUE|floatformat:0 }} VNĐ{% else %}-{% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-600">Tiền cọc:</span>
                                <span class="font-semibold text-purple-600">
                                    {% if hop_dong.GIA_COC_HD %}{{ hop_dong.GIA_COC_HD|floatformat:0 }} VNĐ{% else %}-{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Form chọn ngày kết thúc -->
                    <div class="bg-yellow-50 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">
                            <i class="fas fa-calendar-alt text-yellow-600 mr-2"></i>
                            Ngày kết thúc thực tế
                        </h3>
                        <form id="form-step-1" class="space-y-4">
                            {% csrf_token %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Chọn ngày kết thúc <span class="text-red-500">*</span>
                                </label>
                                <input type="date" 
                                       id="ngay_ket_thuc_thuc_te" 
                                       name="ngay_ket_thuc_thuc_te"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                       required>
                                <div class="text-sm text-gray-500 mt-1">
                                    Ngày kết thúc không thể nhỏ hơn ngày hôm nay
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Lý do kết thúc
                                </label>
                                <textarea id="ly_do_ket_thuc" 
                                         name="ly_do_ket_thuc"
                                         rows="4" 
                                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                         placeholder="Nhập lý do kết thúc hợp đồng (không bắt buộc)..."></textarea>
                            </div>
                            
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                                    <div class="text-sm text-red-700">
                                        <strong>Lưu ý:</strong> Việc kết thúc hợp đồng sẽ:
                                        <ul class="mt-2 space-y-1 list-disc list-inside ml-4">                                            
                                            <li>Tạo hóa đơn kết thúc với tính toán theo ngày</li>
                                            <li>Xử lý hoàn trả tiền cọc</li>
                                            <li>Không thể hoàn tác sau khi thực hiện</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="flex justify-end mt-8 space-x-4">
                    <a href="{% url 'admin_hopdong:hopdong_list' %}" 
                       class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-medium">
                        Hủy bỏ
                    </a>
                    <button type="button" 
                            onclick="chuyenSangBuoc2()"
                            class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                        Tiếp tục <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Bước 2: Xử lý công nợ -->
            <div id="step-content-2" class="p-8 hidden">
                <div class="bg-orange-50 rounded-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-orange-800 mb-3">
                        <i class="fas fa-exclamation-triangle mr-3"></i>
                        Bước 2: Xử lý công nợ
                    </h2>
                    <p class="text-orange-700">Kiểm tra và xử lý toàn bộ công nợ của hợp đồng trước khi kết thúc.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Danh sách hóa đơn chưa thanh toán -->
                    <div class="bg-red-50 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-red-800 mb-4">
                            <i class="fas fa-file-invoice-dollar mr-2"></i>
                            Hóa đơn chưa thanh toán
                        </h3>
                        <div id="danh_sach_cong_no" class="space-y-3">
                            <!-- Sẽ được load bằng JavaScript -->
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-red-600 mx-auto mb-3"></div>
                                <p class="text-gray-500">Đang tải dữ liệu...</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-red-100 rounded-lg border border-red-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-red-800 text-lg">Tổng công nợ:</span>
                                <span id="tong_cong_no" class="font-bold text-red-900 text-xl">0 VNĐ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Xác nhận thanh toán -->
                    <div class="bg-green-50 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-green-800 mb-4">
                            <i class="fas fa-credit-card mr-2"></i>
                            Xác nhận thanh toán
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-lg border border-green-200">
                                <div class="flex items-start space-x-3">
                                    <input type="checkbox" 
                                           id="xac_nhan_da_thu_no" 
                                           class="mt-1 rounded border-gray-300 text-green-600 focus:ring-green-500 w-5 h-5">
                                    <label for="xac_nhan_da_thu_no" class="text-sm font-medium text-gray-700">
                                        <span class="text-green-700 font-semibold">Xác nhận đã thu hết công nợ</span>
                                        <p class="text-gray-600 mt-1">
                                            Tôi xác nhận khách thuê đã thanh toán đầy đủ tất cả các khoản nợ 
                                            trước khi kết thúc hợp đồng.
                                        </p>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="flex items-start space-x-2">
                                    <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                                    <div class="text-sm text-blue-700">
                                        <strong>Quan trọng:</strong> 
                                        <p class="mt-1">
                                            Chỉ được tiếp tục khi đã thu hết công nợ. Nếu còn nợ, hãy tạo phiếu thu 
                                            hoặc yêu cầu khách thanh toán trước.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button type="button" 
                            onclick="chuyenSangBuoc1()"
                            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-medium">
                        <i class="fas fa-arrow-left mr-2"></i> Quay lại
                    </button>
                    <button type="button" 
                            id="btn_tiep_tuc_buoc_3"
                            onclick="chuyenSangBuoc3()"
                            disabled
                            class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Tiếp tục <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Bước 3: Lập hóa đơn kết thúc -->
            <div id="step-content-3" class="p-8 hidden">
                <div class="bg-green-50 rounded-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-green-800 mb-3">
                        <i class="fas fa-file-invoice mr-3"></i>
                        Bước 3: Lập hóa đơn kết thúc
                    </h2>
                    <p class="text-green-700">Tạo hóa đơn kết thúc bao gồm tiền phòng theo ngày, dịch vụ, hoàn trả cọc và khấu trừ.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Dịch vụ -->
                    <div class="bg-purple-50 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-purple-800 mb-4">
                            <i class="fas fa-concierge-bell mr-2"></i>
                            Nhập chỉ số dịch vụ
                        </h3>
                        <div id="danh_sach_dich_vu" class="space-y-4">
                            <!-- Sẽ được load bằng JavaScript -->
                            <div class="text-center py-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-purple-600 mx-auto mb-3"></div>
                                <p class="text-gray-500">Đang tải dịch vụ...</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-purple-100 rounded-lg border border-purple-300">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-purple-800">Tổng tiền dịch vụ:</span>
                                <span id="tong_tien_dich_vu" class="font-bold text-purple-900 text-lg">0 VNĐ</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chi tiết tính toán -->
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-blue-800 mb-4">
                            <i class="fas fa-calculator mr-2"></i>
                            Chi tiết tính toán
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Tiền phòng theo ngày -->
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-medium text-gray-700">Tiền phòng (theo ngày):</span>
                                    <span id="tien_phong_theo_ngay" class="font-bold text-blue-600">0 VNĐ</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    Từ <span id="tu_ngay" class="font-medium">-</span> 
                                    đến <span id="den_ngay" class="font-medium">-</span>
                                    (<span id="so_ngay" class="font-medium">0</span> ngày)
                                </div>
                            </div>
                            
                            <!-- Tiền dịch vụ -->
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Tiền dịch vụ:</span>
                                    <span id="tien_dich_vu" class="font-bold text-blue-600">0 VNĐ</span>
                                </div>
                            </div>
                            
                            <!-- Hoàn trả cọc -->
                            <div class="bg-white p-4 rounded-lg border border-green-200">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Hoàn trả tiền cọc:</span>
                                    <span id="tien_coc_hoan_tra" class="font-bold text-green-600">0 VNĐ</span>
                                </div>
                            </div>
                            
                            <!-- Khấu trừ -->
                            <div class="bg-white p-4 rounded-lg border border-red-200">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-700">Khấu trừ:</span>
                                    <span id="tien_khau_tru_display" class="font-bold text-red-600">0 VNĐ</span>
                                </div>
                            </div>
                            
                            <!-- Tổng cộng -->
                            <div class="bg-yellow-100 p-4 rounded-lg border-2 border-yellow-300">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-yellow-800 text-lg">Tổng cần thanh toán:</span>
                                    <span id="tong_tien_ket_thuc" class="font-bold text-2xl">0 VNĐ</span>
                                </div>
                                <div class="text-sm text-yellow-700 mt-1">
                                    <span id="loai_thanh_toan">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form nhập bổ sung -->
                    <div class="bg-yellow-50 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-yellow-800 mb-4">
                            <i class="fas fa-edit mr-2"></i>
                            Thông tin bổ sung
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Khấu trừ (nếu có)
                                </label>
                                <input type="number" 
                                       id="so_tien_khau_tru" 
                                       min="0" 
                                       step="1000" 
                                       value="0"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                       placeholder="Nhập số tiền khấu trừ">
                                <div class="text-sm text-gray-600 mt-1">
                                    VD: Hư hỏng tài sản, điện nước thừa, vi phạm hợp đồng...
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Lý do khấu trừ
                                </label>
                                <textarea id="ghi_chu_khau_tru" 
                                         rows="3" 
                                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                         placeholder="Nhập lý do khấu trừ (nếu có)..."></textarea>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border-2 border-red-300">
                                <div class="flex items-start space-x-3">
                                    <input type="checkbox" 
                                           id="xac_nhan_ket_thuc" 
                                           class="mt-1 rounded border-gray-300 text-red-600 focus:ring-red-500 w-5 h-5">
                                    <label for="xac_nhan_ket_thuc" class="text-sm text-gray-700">
                                        <span class="font-semibold text-red-700">Tôi xác nhận:</span>
                                        <ul class="mt-2 space-y-1 list-disc list-inside ml-2 text-sm">
                                            <li>Đã kiểm tra tình trạng phòng</li>
                                            <li>Thông tin tính toán là chính xác</li>
                                            <li>Đồng ý tạo hóa đơn kết thúc hợp đồng</li>
                                            <li>Hiểu rằng không thể hoàn tác sau khi thực hiện</li>
                                        </ul>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between mt-8">
                    <button type="button" 
                            onclick="chuyenSangBuoc2FromStep3()"
                            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-medium">
                        <i class="fas fa-arrow-left mr-2"></i> Quay lại
                    </button>
                    <button type="button" 
                            id="btn_ket_thuc_hop_dong"
                            onclick="thucHienKetThucHopDong()"
                            disabled
                            class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-check-circle mr-2"></i> Kết thúc hợp đồng
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
let currentStep = 1;
let contractData = {
    ma_hop_dong: '{{ hop_dong.MA_HOP_DONG }}',
    ngay_nhan_phong: '{% if hop_dong.NGAY_NHAN_PHONG %}{{ hop_dong.NGAY_NHAN_PHONG|date:"Y-m-d" }}{% endif %}',
    gia_thue: {% if hop_dong.GIA_THUE %}{{ hop_dong.GIA_THUE|floatformat:"0" }}{% else %}0{% endif %},
    gia_coc: {% if hop_dong.GIA_COC_HD %}{{ hop_dong.GIA_COC_HD|floatformat:"0" }}{% else %}0{% endif %}
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('ngay_ket_thuc_thuc_te').value = today;
    document.getElementById('ngay_ket_thuc_thuc_te').min = today;
    
    // Event listeners
    document.getElementById('xac_nhan_da_thu_no').addEventListener('change', kiemTraDieuKienBuoc2);
    document.getElementById('xac_nhan_ket_thuc').addEventListener('change', kiemTraDieuKienBuoc3);
    document.getElementById('so_tien_khau_tru').addEventListener('input', capNhatTinhToan);
});

// Chuyển sang bước 2
function chuyenSangBuoc2() {
    const ngayKetThuc = document.getElementById('ngay_ket_thuc_thuc_te').value;
    
    if (!ngayKetThuc) {
        alert('Vui lòng chọn ngày kết thúc!');
        return;
    }
    
    // Lưu thông tin
    contractData.ngay_ket_thuc = ngayKetThuc;
    contractData.ly_do = document.getElementById('ly_do_ket_thuc').value;
    
    // Chuyển bước và load dữ liệu
    chuyenBuoc(2);
    loadCongNoData();
}

// Chuyển sang bước 3
function chuyenSangBuoc3() {
    if (!document.getElementById('xac_nhan_da_thu_no').checked) {
        alert('Vui lòng xác nhận đã thu hết công nợ!');
        return;
    }
    
    chuyenBuoc(3);
    tinhToanHoaDonKetThuc();
    loadDichVuData();
}

// Chuyển về bước 1
function chuyenSangBuoc1() {
    chuyenBuoc(1);
}

// Chuyển về bước 2
function chuyenSangBuoc2FromStep3() {
    chuyenBuoc(2);
}

// Chuyển bước
function chuyenBuoc(buoc) {
    // Ẩn tất cả content
    for (let i = 1; i <= 3; i++) {
        document.getElementById(`step-content-${i}`).classList.add('hidden');
    }
    
    // Hiện content hiện tại
    document.getElementById(`step-content-${buoc}`).classList.remove('hidden');
    
    // Cập nhật progress
    capNhatProgress(buoc);
    currentStep = buoc;
}

// Cập nhật progress indicators
function capNhatProgress(buoc) {
    for (let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`step-indicator-${i}`);
        const circle = indicator.querySelector('div');
        const text = indicator.querySelector('span');
        const progress = document.getElementById(`progress-${i}`);
        
        if (i < buoc) {
            // Completed
            circle.className = 'w-10 h-10 rounded-full bg-green-500 text-white font-bold flex items-center justify-center';
            circle.innerHTML = '<i class="fas fa-check"></i>';
            text.className = 'text-green-600 font-medium';
            if (progress) progress.style.width = '100%';
            if (progress) progress.classList.remove('bg-gray-300');
            if (progress) progress.classList.add('bg-green-500');
        } else if (i === buoc) {
            // Current
            circle.className = 'w-10 h-10 rounded-full bg-red-600 text-white font-bold flex items-center justify-center';
            circle.textContent = i;
            text.className = 'text-red-600 font-medium';
        } else {
            // Future
            circle.className = 'w-10 h-10 rounded-full bg-gray-300 text-gray-500 font-bold flex items-center justify-center';
            circle.textContent = i;
            text.className = 'text-gray-500 font-medium';
            if (progress) progress.style.width = '0%';
            if (progress) progress.classList.remove('bg-green-500');
            if (progress) progress.classList.add('bg-gray-300');
        }
    }
}

// Load dữ liệu công nợ
async function loadCongNoData() {
    try {
        const response = await fetch(`/admin/hopdong/api/cong-no/${contractData.ma_hop_dong}/`);
        const data = await response.json();
        
        const container = document.getElementById('danh_sach_cong_no');
        container.innerHTML = '';
        
        if (data.success && data.hoa_don_chua_thanh_toan && data.hoa_don_chua_thanh_toan.length > 0) {
            data.hoa_don_chua_thanh_toan.forEach(hd => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-lg border border-red-200 flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <div class="font-semibold text-gray-800">${hd.ma_hoa_don}</div>
                        <div class="text-sm text-gray-600">${hd.loai_hoa_don}</div>
                        <div class="text-xs text-gray-500">${hd.ngay_lap}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-red-600 text-lg">${formatCurrency(hd.so_tien_con_no)}</div>
                        <div class="text-xs text-red-500">Chưa thanh toán</div>
                    </div>
                `;
                container.appendChild(item);
            });
            
            document.getElementById('tong_cong_no').textContent = formatCurrency(data.tong_cong_no);
        } else {
            container.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                    <i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i>
                    <h4 class="text-lg font-semibold text-green-800">Không có công nợ</h4>
                    <p class="text-green-700 mt-1">Hợp đồng này không có hóa đơn nào chưa thanh toán</p>
                </div>
            `;
            document.getElementById('tong_cong_no').textContent = '0 VNĐ';
            
            // Auto check nếu không có nợ
            document.getElementById('xac_nhan_da_thu_no').checked = true;
            kiemTraDieuKienBuoc2();
        }
    } catch (error) {
        console.error('Lỗi load công nợ:', error);
        document.getElementById('danh_sach_cong_no').innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-3"></i>
                <h4 class="text-lg font-semibold text-red-800">Lỗi tải dữ liệu</h4>
                <p class="text-red-700 mt-1">Không thể tải thông tin công nợ</p>
            </div>
        `;
    }
}

// Tính toán hóa đơn kết thúc
async function tinhToanHoaDonKetThuc() {
    try {
        const response = await fetch(`/admin/hopdong/api/tinh-toan-ket-thuc/${contractData.ma_hop_dong}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                ngay_ket_thuc: contractData.ngay_ket_thuc,
                dich_vu_data: collectDichVuData()
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            contractData.tinhToan = data;
            
            // Cập nhật hiển thị
            document.getElementById('tien_phong_theo_ngay').textContent = formatCurrency(data.tien_phong_theo_ngay);
            document.getElementById('tu_ngay').textContent = data.tu_ngay;
            document.getElementById('den_ngay').textContent = data.den_ngay;
            document.getElementById('so_ngay').textContent = data.so_ngay;
            document.getElementById('tien_dich_vu').textContent = formatCurrency(data.tien_dich_vu);
            document.getElementById('tien_coc_hoan_tra').textContent = formatCurrency(data.tien_coc_hoan_tra);
            
            capNhatTinhToan();
        } else {
            alert('Lỗi tính toán: ' + data.message);
        }
    } catch (error) {
        console.error('Lỗi tính toán:', error);
        alert('Lỗi kết nối khi tính toán hóa đơn');
    }
}

// Cập nhật tính toán khi thay đổi khấu trừ
function capNhatTinhToan() {
    if (!contractData.tinhToan) return;
    
    const khauTru = parseFloat(document.getElementById('so_tien_khau_tru').value) || 0;
    const tienPhong = contractData.tinhToan.tien_phong_theo_ngay || 0;
    const tienDichVu = contractData.tinhToan.tien_dich_vu || 0;
    const tienCoc = contractData.tinhToan.tien_coc_hoan_tra || 0;
    
    const tongTien = tienPhong + tienDichVu - tienCoc - khauTru;
    
    document.getElementById('tien_khau_tru_display').textContent = formatCurrency(khauTru);
    document.getElementById('tong_tien_ket_thuc').textContent = formatCurrency(Math.abs(tongTien));
    
    const loaiThanhToan = document.getElementById('loai_thanh_toan');
    const tongElement = document.getElementById('tong_tien_ket_thuc');
    
    if (tongTien > 0) {
        loaiThanhToan.textContent = 'Khách cần thanh toán thêm';
        tongElement.className = 'font-bold text-2xl text-red-600';
    } else if (tongTien < 0) {
        loaiThanhToan.textContent = 'Cần hoàn trả cho khách';
        tongElement.className = 'font-bold text-2xl text-green-600';
    } else {
        loaiThanhToan.textContent = 'Không phát sinh thêm phí';
        tongElement.className = 'font-bold text-2xl text-gray-600';
    }
}

// Kiểm tra điều kiện bước 2
function kiemTraDieuKienBuoc2() {
    const checked = document.getElementById('xac_nhan_da_thu_no').checked;
    document.getElementById('btn_tiep_tuc_buoc_3').disabled = !checked;
}

// Kiểm tra điều kiện bước 3
function kiemTraDieuKienBuoc3() {
    const checked = document.getElementById('xac_nhan_ket_thuc').checked;
    document.getElementById('btn_ket_thuc_hop_dong').disabled = !checked;
}

// Thực hiện kết thúc hợp đồng
async function thucHienKetThucHopDong() {
    if (!confirm('Bạn có chắc chắn muốn kết thúc hợp đồng này? Hành động này không thể hoàn tác!')) {
        return;
    }
    
    const btn = document.getElementById('btn_ket_thuc_hop_dong');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';
    
    try {
        const response = await fetch(`/admin/hopdong/ket-thuc-hop-dong/${contractData.ma_hop_dong}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                ngay_ket_thuc: contractData.ngay_ket_thuc,
                ly_do: contractData.ly_do,
                khau_tru: parseFloat(document.getElementById('so_tien_khau_tru').value) || 0,
                ghi_chu_khau_tru: document.getElementById('ghi_chu_khau_tru').value,
                dich_vu_data: collectDichVuData()
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Kết thúc hợp đồng thành công!\n' + data.message);
            
            // Redirect về danh sách
            setTimeout(() => {
                window.location.href = '{% url "admin_hopdong:hopdong_list" %}';
            }, 1000);
        } else {
            alert('Lỗi: ' + data.message);
        }
    } catch (error) {
        console.error('Lỗi kết thúc hợp đồng:', error);
        alert('Có lỗi xảy ra khi kết thúc hợp đồng!');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Kết thúc hợp đồng';
    }
}

// Load dữ liệu dịch vụ
async function loadDichVuData() {
    try {
        const response = await fetch(`/admin/hopdong/api/dich-vu/${contractData.ma_hop_dong}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        });
        const data = await response.json();
        
        const container = document.getElementById('danh_sach_dich_vu');
        container.innerHTML = '';
        
        if (data.success && data.dich_vu_list && data.dich_vu_list.length > 0) {
            data.dich_vu_list.forEach(dv => {
                const item = document.createElement('div');
                item.className = 'bg-white p-4 rounded-lg border border-purple-200';
                
                if (dv.loai_dich_vu === 'Theo chỉ số') {
                    item.innerHTML = `
                        <div class="mb-3">
                            <div class="font-semibold text-gray-800">${dv.ten_dich_vu}</div>
                            <div class="text-sm text-gray-600">${dv.don_vi_tinh} - ${formatCurrency(dv.gia_dich_vu)}/${dv.don_vi_tinh}</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Chỉ số cũ</label>
                                <input type="number" value="${dv.chi_so_cu}" readonly 
                                       class="w-full px-2 py-1 border bg-gray-100 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Chỉ số mới</label>
                                <input type="number" min="${dv.chi_so_cu}" value="${dv.chi_so_cu}"
                                       data-dv-id="${dv.ma_dich_vu}" data-gia="${dv.gia_dich_vu}"
                                       onchange="tinhTienDichVu()"
                                       class="w-full px-2 py-1 border rounded text-sm focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        <div class="mt-2 text-right">
                            <span class="text-sm font-medium text-purple-700">Thành tiền: </span>
                            <span class="font-bold text-purple-800" id="thanh-tien-${dv.ma_dich_vu}">0 VNĐ</span>
                        </div>
                    `;
                } else {
                    // Dịch vụ cố định
                    item.innerHTML = `
                        <div class="mb-3">
                            <div class="font-semibold text-gray-800">${dv.ten_dich_vu}</div>
                            <div class="text-sm text-gray-600">${dv.don_vi_tinh} - ${formatCurrency(dv.gia_dich_vu)}/${dv.don_vi_tinh}</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Số lượng cũ</label>
                                <input type="number" value="${dv.so_luong_cu}" readonly 
                                       class="w-full px-2 py-1 border bg-gray-100 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Số lượng sử dụng</label>
                                <input type="number" min="0" value="${dv.so_luong_cu}"
                                       data-dv-id="${dv.ma_dich_vu}" data-gia="${dv.gia_dich_vu}"
                                       onchange="tinhTienDichVu()"
                                       class="w-full px-2 py-1 border rounded text-sm focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        <div class="mt-2 text-right">
                            <span class="text-sm font-medium text-purple-700">Thành tiền: </span>
                            <span class="font-bold text-purple-800" id="thanh-tien-${dv.ma_dich_vu}">0 VNĐ</span>
                        </div>
                    `;
                }
                
                container.appendChild(item);
            });
            
            // Tính tiền dịch vụ ban đầu
            tinhTienDichVu();
        } else {
            container.innerHTML = `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
                    <i class="fas fa-info-circle text-gray-400 text-2xl mb-3"></i>
                    <h4 class="text-lg font-semibold text-gray-600">Không có dịch vụ</h4>
                    <p class="text-gray-500 mt-1">Hợp đồng này không có dịch vụ nào</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Lỗi load dịch vụ:', error);
        document.getElementById('danh_sach_dich_vu').innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mb-3"></i>
                <h4 class="text-lg font-semibold text-red-600">Lỗi tải dịch vụ</h4>
                <p class="text-red-500 mt-1">Không thể tải danh sách dịch vụ</p>
            </div>
        `;
    }
}

// Thu thập dữ liệu dịch vụ để gửi API
function collectDichVuData() {
    const dichVuData = [];
    const dichVuInputs = document.querySelectorAll('[data-dv-id]');
    
    dichVuInputs.forEach(input => {
        const maDichVu = input.getAttribute('data-dv-id');
        const giaDichVu = parseFloat(input.getAttribute('data-gia')) || 0;
        const soMoi = parseFloat(input.value) || 0;
        
        // Tìm chỉ số cũ
        const chiSoCuInput = input.closest('.grid').querySelector('input[readonly]');
        const chiSoCu = parseFloat(chiSoCuInput.value) || 0;
        
        let thanhTien = 0;
        if (input.closest('.bg-white').innerHTML.includes('Chỉ số mới')) {
            // Dịch vụ theo chỉ số
            thanhTien = (soMoi - chiSoCu) * giaDichVu;
        } else {
            // Dịch vụ cố định
            thanhTien = soMoi * giaDichVu;
        }
        
        dichVuData.push({
            ma_dich_vu: maDichVu,
            chi_so_cu: chiSoCu,
            chi_so_moi: soMoi,
            thanh_tien: Math.max(0, thanhTien)
        });
    });
    
    return dichVuData;
}

// Tính tiền dịch vụ
function tinhTienDichVu() {
    let tongTienDichVu = 0;
    
    // Lặp qua tất cả input chỉ số dịch vụ
    const dichVuInputs = document.querySelectorAll('[data-dv-id]');
    
    dichVuInputs.forEach(input => {
        const maDichVu = input.getAttribute('data-dv-id');
        const giaDichVu = parseFloat(input.getAttribute('data-gia')) || 0;
        const soMoi = parseFloat(input.value) || 0;
        
        let thanhTien = 0;
        
        // Tìm chỉ số cũ
        const chiSoCuInput = input.closest('.grid').querySelector('input[readonly]');
        const chiSoCu = parseFloat(chiSoCuInput.value) || 0;
        
        // Tính thành tiền
        if (input.closest('.bg-white').innerHTML.includes('Chỉ số mới')) {
            // Dịch vụ theo chỉ số
            thanhTien = (soMoi - chiSoCu) * giaDichVu;
        } else {
            // Dịch vụ cố định
            thanhTien = soMoi * giaDichVu;
        }
        
        // Cập nhật hiển thị thành tiền
        const thanhTienElement = document.getElementById(`thanh-tien-${maDichVu}`);
        if (thanhTienElement) {
            thanhTienElement.textContent = formatCurrency(Math.max(0, thanhTien));
        }
        
        tongTienDichVu += Math.max(0, thanhTien);
    });
    
    // Cập nhật tổng tiền dịch vụ
    document.getElementById('tong_tien_dich_vu').textContent = formatCurrency(tongTienDichVu);
    document.getElementById('tien_dich_vu').textContent = formatCurrency(tongTienDichVu);
    
    // Cập nhật lại tính toán tổng
    if (contractData.tinhToan) {
        contractData.tinhToan.tien_dich_vu = tongTienDichVu;
        capNhatTinhToan();
    }
}

// Utility function
function formatCurrency(amount) {
    if (!amount && amount !== 0) return '0 VNĐ';
    return new Intl.NumberFormat('vi-VN').format(amount) + ' VNĐ';
}
</script>

{% endblock %}