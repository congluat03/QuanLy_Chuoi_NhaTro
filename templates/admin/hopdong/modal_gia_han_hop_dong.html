<!-- Modal Gia hạn Hợp đồng -->
<div id="modalGiaHanHopDong" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-emerald-600 to-teal-700 text-white p-6 rounded-t-2xl">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-calendar-plus text-2xl"></i>
                    <div>
                        <h3 class="text-xl font-bold tracking-tight">Gia hạn Hợp đồng</h3>
                        <p class="text-emerald-100 text-sm mt-1">Hợp đồng #<span id="modalHopDongId"></span></p>
                    </div>
                </div>
                <button type="button" onclick="dongModalGiaHan()" class="text-white hover:text-red-200 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Form Content -->
        <form id="formGiaHanHopDong" class="space-y-6">
            <input type="hidden" id="hiddenHopDongId" name="ma_hop_dong">
            
            <div class="p-6 space-y-6">
                <!-- Ngày gia hạn đến -->
                <div class="space-y-3">
                    <label for="ngayTraPhongMoi" class="block text-sm font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-calendar-alt text-emerald-600 mr-2"></i>
                        Gia hạn đến ngày <span class="text-red-500">*</span>
                    </label>
                    <input type="date" 
                           id="ngayTraPhongMoi" 
                           name="ngay_tra_phong_moi" 
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200 bg-gray-50 hover:bg-white focus:outline-none"
                           required>
                    <p class="text-xs text-gray-600 flex items-center bg-gray-50 p-2 rounded-lg">
                        <i class="fas fa-info-circle text-emerald-600 mr-2"></i>
                        Chọn ngày kết thúc hợp đồng mới
                    </p>
                </div>

                <!-- Lý do gia hạn -->
                <div class="space-y-3">
                    <label for="lyDoGiaHan" class="block text-sm font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-comment-alt text-blue-600 mr-2"></i>
                        Lý do gia hạn <span class="text-red-500">*</span>
                    </label>
                    <textarea id="lyDoGiaHan" 
                              name="ly_do_gia_han" 
                              rows="4" 
                              placeholder="Nhập lý do gia hạn hợp đồng..."
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all duration-200 bg-gray-50 hover:bg-white resize-none focus:outline-none"
                              required></textarea>
                    <p class="text-xs text-gray-600 flex items-center bg-gray-50 p-2 rounded-lg">
                        <i class="fas fa-edit text-blue-600 mr-2"></i>
                        Ví dụ: Khách thuê yêu cầu tiếp tục thuê thêm 6 tháng
                    </p>
                </div>

               
                <!-- Thông báo lỗi -->
                <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-xl p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                        <span class="text-red-700 font-medium"></span>
                    </div>
                </div>
            </div>

            <!-- Footer với buttons -->
            <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex flex-col sm:flex-row justify-end gap-3">
                <button type="button" 
                        onclick="dongModalGiaHan()" 
                        class="px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 transition-all duration-200 font-medium flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i>Hủy bỏ
                </button>
                <button type="submit" 
                        id="btnGiaHanSubmit"
                        class="px-6 py-3 bg-gradient-to-r from-emerald-600 to-teal-700 text-white rounded-xl hover:from-emerald-700 hover:to-teal-800 transition-all duration-200 font-medium flex items-center justify-center shadow-lg">
                    <i class="fas fa-calendar-check mr-2"></i>
                    <span>Xác nhận gia hạn</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Hiển thị modal gia hạn
function hienThiModalGiaHan(hopDongData) {
    // Set thông tin hợp đồng
    const modalHopDongId = document.getElementById('modalHopDongId');
    const hiddenHopDongId = document.getElementById('hiddenHopDongId');
    
    if (modalHopDongId) {
        modalHopDongId.textContent = hopDongData.MA_HOP_DONG;
    }
    if (hiddenHopDongId) {
        hiddenHopDongId.value = hopDongData.MA_HOP_DONG;
    }
    
    // Hiển thị thông tin hiện tại (nếu có elements)
    const currentEndDate = document.getElementById('currentEndDate');
    const currentPrice = document.getElementById('currentPrice');
    
    if (currentEndDate && hopDongData.NGAY_TRA_PHONG) {
        currentEndDate.textContent = hopDongData.NGAY_TRA_PHONG;
    }
    if (currentPrice && hopDongData.GIA_THUE) {
        currentPrice.textContent = new Intl.NumberFormat('vi-VN').format(hopDongData.GIA_THUE);
    }
    
    // Set min date cho input (phải sau ngày hiện tại)
    const dateInput = document.getElementById('ngayTraPhongMoi');
    if (dateInput && hopDongData.NGAY_TRA_PHONG) {
        const currentEndDate = new Date(hopDongData.NGAY_TRA_PHONG);
        const minDate = new Date(currentEndDate);
        minDate.setDate(minDate.getDate() + 1);
        dateInput.min = minDate.toISOString().split('T')[0];
    }
    
    // Reset form và ẩn lỗi
    const form = document.getElementById('formGiaHanHopDong');
    if (form) {
        form.reset();
        if (hiddenHopDongId) {
            hiddenHopDongId.value = hopDongData.MA_HOP_DONG;
        }
    }
    
    const errorDiv = document.getElementById('errorMessage');
    if (errorDiv) {
        errorDiv.classList.add('hidden');
    }
    
    // Hiển thị modal
    const modal = document.getElementById('modalGiaHanHopDong');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

// Đóng modal
function dongModalGiaHan() {
    const modal = document.getElementById('modalGiaHanHopDong');
    const form = document.getElementById('formGiaHanHopDong');
    const errorDiv = document.getElementById('errorMessage');
    
    if (modal) {
        modal.classList.add('hidden');
    }
    if (form) {
        form.reset();
    }
    if (errorDiv) {
        errorDiv.classList.add('hidden');
    }
}

// Hiển thị lỗi
function hienThiLoi(message) {
    const errorDiv = document.getElementById('errorMessage');
    if (errorDiv) {
        const spanElement = errorDiv.querySelector('span');
        if (spanElement) {
            spanElement.textContent = message;
        }
        errorDiv.classList.remove('hidden');
    } else {
        alert(message); // Fallback nếu không có error div
    }
}

// Setup khi DOM ready
document.addEventListener('DOMContentLoaded', function() {
    // Xử lý form submit
    const form = document.getElementById('formGiaHanHopDong');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const maHopDong = document.getElementById('hiddenHopDongId')?.value;
            
            // Validate form
            const ngayGiaHan = document.getElementById('ngayTraPhongMoi')?.value;
            const lyDo = document.getElementById('lyDoGiaHan')?.value?.trim();
            
            if (!ngayGiaHan) {
                hienThiLoi('Vui lòng chọn ngày gia hạn');
                return;
            }
            
            if (!lyDo) {
                hienThiLoi('Vui lòng nhập lý do gia hạn');
                return;
            }
            
            if (!maHopDong) {
                hienThiLoi('Không tìm thấy mã hợp đồng');
                return;
            }
            
            // Submit form
            const submitButton = document.getElementById('btnGiaHanSubmit');
            if (submitButton) {
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Đang xử lý...';
                submitButton.disabled = true;
                
                fetch(`/admin/hopdong/gia-han/${maHopDong}/`, {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (response.ok) {
                        alert('Gia hạn hợp đồng thành công!');
                        dongModalGiaHan();
                        window.location.reload(); // Reload trang để cập nhật thông tin
                    } else {
                        return response.text().then(text => {
                            console.error('Server response:', text);
                            hienThiLoi('Có lỗi xảy ra khi gia hạn hợp đồng');
                        });
                    }
                }).catch(error => {
                    console.error('Fetch error:', error);
                    hienThiLoi('Lỗi kết nối: ' + error.message);
                }).finally(() => {
                    if (submitButton) {
                        submitButton.innerHTML = originalText;
                        submitButton.disabled = false;
                    }
                });
            }
        });
    }

    // Đóng modal khi click overlay
    const modal = document.getElementById('modalGiaHanHopDong');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                dongModalGiaHan();
            }
        });
    }
});
</script>