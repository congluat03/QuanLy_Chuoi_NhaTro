{% extends 'admin/admin_layout.html' %}
{% load static %}

{% block title %}
    {% if manager %}Chỉnh sửa thông tin quản lý{% else %}Thêm quản lý mới{% endif %}
{% endblock %}

{% block content_body %}
<div class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-user-plus text-green-600 mr-3"></i>
                            {% if manager %}Chỉnh sửa thông tin quản lý{% else %}Thêm quản lý mới{% endif %}
                        </h1>
                        <p class="text-gray-600">Quản lý thông tin quản lý và khu vực phụ trách</p>
                    </div>
                </div>
                <a href="{% url 'thanhvien:nhanvien_list' %}" 
                   class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Quay lại
                </a>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="px-6 py-4">
                {% for message in messages %}
                    <div class="p-4 mb-3 rounded-lg border-l-4 {% if message.tags == 'error' %}bg-red-50 border-red-400 text-red-800{% else %}bg-green-50 border-green-400 text-green-800{% endif %}">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                {% if message.tags == 'error' %}
                                    <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                {% else %}
                                    <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                {% endif %}
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium">{{ message }}</p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Main Container -->
        <div class="bg-white rounded-xl shadow-xl overflow-hidden">
            {% if manager %}
            <!-- Edit Manager - Single Form Layout -->
            <div class="p-6">
                <!-- Section Title -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Thông tin cá nhân</h3>
                    <p class="text-gray-600">Chỉnh sửa thông tin cá nhân của nhân viên</p>
                </div>

                <!-- Manager Info Form -->
                <form action="{% url 'thanhvien:edit_manager' manager.MA_QUAN_LY %}" 
                      method="POST" enctype="multipart/form-data" id="managerForm">
                    {% csrf_token %}
                    <input type="hidden" name="_method" value="PUT">
                    
                    <!-- Personal Information Section -->
                    <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-user mr-2 text-blue-600"></i>
                            Thông tin cá nhân
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Họ tên quản lý -->
                            <div>
                                <label for="TEN_QUAN_LY" class="block text-sm font-medium text-gray-700 mb-2">Họ Tên <span class="text-red-500">*</span></label>
                                <input type="text" name="TEN_QUAN_LY" id="TEN_QUAN_LY"
                                       value="{% if form_data.TEN_QUAN_LY %}{{ form_data.TEN_QUAN_LY }}{% else %}{{ manager.TEN_QUAN_LY|default_if_none:'' }}{% endif %}"
                                       required
                                       class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400"
                                       placeholder="Nhập họ tên">
                                {% if form_errors.TEN_QUAN_LY %}
                                    <p class="text-sm text-red-600 mt-1">{{ form_errors.TEN_QUAN_LY }}</p>
                                {% endif %}
                            </div>

                            <!-- Ngày sinh -->
                            <div>
                                <label for="NGAY_SINH_QL" class="block text-sm font-medium text-gray-700 mb-2">Ngày Sinh <span class="text-red-500">*</span></label>
                                <input type="date" name="NGAY_SINH_QL" id="NGAY_SINH_QL"
                                       value="{% if form_data.NGAY_SINH_QL %}{{ form_data.NGAY_SINH_QL }}{% else %}{{ manager.NGAY_SINH_QL|date:'Y-m-d'|default_if_none:'' }}{% endif %}"
                                       required
                                       class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900">
                                {% if form_errors.NGAY_SINH_QL %}
                                    <p class="text-sm text-red-600 mt-1">{{ form_errors.NGAY_SINH_QL }}</p>
                                {% endif %}
                            </div>

                            <!-- Giới tính -->
                            <div>
                                <label for="GIOI_TINH_QL" class="block text-sm font-medium text-gray-700 mb-2">Giới Tính <span class="text-red-500">*</span></label>
                                <select name="GIOI_TINH_QL" id="GIOI_TINH_QL" required
                                        class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900">
                                    <option value="" disabled>Chọn giới tính</option>
                                    <option value="Nam" {% if form_data.GIOI_TINH_QL == 'Nam' or manager.GIOI_TINH_QL == 'Nam' %}selected{% endif %}>Nam</option>
                                    <option value="Nữ" {% if form_data.GIOI_TINH_QL == 'Nữ' or manager.GIOI_TINH_QL == 'Nữ' %}selected{% endif %}>Nữ</option>
                                </select>
                                {% if form_errors.GIOI_TINH_QL %}
                                    <p class="text-sm text-red-600 mt-1">{{ form_errors.GIOI_TINH_QL }}</p>
                                {% endif %}
                            </div>

                            <!-- Số điện thoại -->
                            <div>
                                <label for="SDT_QUAN_LY" class="block text-sm font-medium text-gray-700 mb-2">Số Điện Thoại <span class="text-red-500">*</span></label>
                                <input type="text" name="SDT_QUAN_LY" id="SDT_QUAN_LY"
                                       value="{% if form_data.SDT_QUAN_LY %}{{ form_data.SDT_QUAN_LY }}{% else %}{{ manager.SDT_QUAN_LY|default_if_none:'' }}{% endif %}"
                                       placeholder="Nhập số điện thoại (10-11 chữ số)"
                                       pattern="[0-9]{10,11}" maxlength="11"
                                       title="Số điện thoại phải gồm 10-11 chữ số" required
                                       class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400">
                                {% if form_errors.SDT_QUAN_LY %}
                                    <p class="text-sm text-red-600 mt-1">{{ form_errors.SDT_QUAN_LY }}</p>
                                {% endif %}
                            </div>

                            <!-- Địa chỉ -->
                            <div class="col-span-1 md:col-span-2">
                                <label for="DIA_CHI_QL" class="block text-sm font-medium text-gray-700 mb-2">Địa Chỉ</label>
                                <textarea name="DIA_CHI_QL" id="DIA_CHI_QL"
                                          class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400"
                                          rows="3" placeholder="Nhập địa chỉ">{% if form_data.DIA_CHI_QL %}{{ form_data.DIA_CHI_QL }}{% else %}{{ manager.DIA_CHI_QL|default_if_none:'' }}{% endif %}</textarea>
                                {% if form_errors.DIA_CHI_QL %}
                                    <p class="text-sm text-red-600 mt-1">{{ form_errors.DIA_CHI_QL }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Management History Display (Read-only) -->
                    <div class="bg-blue-50 rounded-lg p-6 mb-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-history mr-2 text-blue-600"></i>
                            Lịch sử quản lý khu vực
                            <span class="ml-2 text-sm text-gray-500">(Chỉ xem - Không thể chỉnh sửa)</span>
                        </h4>
                        
                        {% if current_lich_su %}
                        <div class="bg-white rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Khu vực hiện tại</label>
                                    <p class="text-gray-900 font-medium">{{ current_lich_su.MA_KHU_VUC.TEN_KHU_VUC }}</p>
                                    <p class="text-sm text-gray-500">Mã: {{ current_lich_su.MA_KHU_VUC.MA_KHU_VUC }}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Vị trí công việc</label>
                                    <p class="text-gray-900">{{ current_lich_su.VI_TRI_CONG_VIEC|default:"Chưa cập nhật" }}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ngày bắt đầu</label>
                                    <p class="text-gray-900">{{ current_lich_su.NGAY_BAT_DAU_QL|date:"d/m/Y"|default:"Chưa cập nhật" }}</p>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Để thay đổi khu vực quản lý hoặc vị trí công việc, vui lòng liên hệ quản trị viên hệ thống.
                                </p>
                            </div>
                        </div>
                        {% else %}
                        <div class="bg-white rounded-lg p-4">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-exclamation-triangle text-3xl text-orange-400 mb-3"></i>
                                <p class="text-lg font-medium text-gray-900 mb-2">Chưa có lịch sử quản lý</p>
                                <p class="text-sm">Nhân viên này chưa được phân công khu vực quản lý nào.</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-4">
                        <a href="{% url 'thanhvien:nhanvien_list' %}" 
                           class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-times mr-2"></i>Hủy
                        </a>
                        <button type="submit" 
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>Cập nhật thông tin
                        </button>
                    </div>
                </form>
            </div>

            {% else %}
            <!-- Add New Manager - Layout with sidebar -->
            <div class="flex">
                <!-- Left Sidebar - 30% (Danh sách khu vực) -->
                <div class="w-[30%] bg-gray-50 border-r border-gray-200 flex flex-col">
                    <!-- Filter Section -->
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
                            </svg>
                            Danh sách khu vực
                        </h3>
                        <div id="khu_vuc_list" class="space-y-3">
                            {% for kv in khu_vucs %}
                                <div class="khu-vuc-card bg-white border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-md transition-all duration-200 cursor-pointer"
                                     data-ma-khu-vuc="{{ kv.MA_KHU_VUC }}"
                                     onclick="selectKhuVuc('{{ kv.MA_KHU_VUC }}', '{{ kv.TEN_KHU_VUC }}')">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-gray-900">{{ kv.TEN_KHU_VUC }}</h4>
                                                <p class="text-sm text-gray-500">Mã: {{ kv.MA_KHU_VUC }}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></span>
                                                Hoạt động
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="text-center py-8 text-gray-500">
                                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    <p class="text-sm">Không có khu vực nào</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Right Content - 70% (Form nhập liệu) -->
                <div class="w-[70%] bg-white flex flex-col overflow-auto">
                    <!-- Content Header -->
                    <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">
                                    Form thêm nhân viên
                                </h3>
                                <p class="text-sm text-gray-600" id="selected_khu_vuc_info">
                                    Chưa chọn khu vực
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Form Content -->
                    <div class="flex-1 overflow-y-auto">
                        <form action="{% url 'thanhvien:add_manager' %}" 
                              method="POST" enctype="multipart/form-data" class="p-6" id="managerForm">
                            {% csrf_token %}
                            <input type="hidden" id="ma_khu_vuc" name="MA_KHU_VUC" value="">

                            <!-- Empty State -->
                            <div id="empty_state" class="flex flex-col items-center justify-center h-96 text-gray-500">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Chưa chọn khu vực</h3>
                                <p class="text-sm text-gray-600 text-center max-w-md">
                                    Vui lòng chọn một khu vực từ danh sách bên trái để bắt đầu nhập thông tin quản lý
                                </p>
                            </div>

                        <!-- Manager Form -->
                        <div id="manager_form" class="hidden space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Họ tên quản lý -->
                                <div>
                                    <label for="TEN_QUAN_LY" class="block text-sm font-medium text-gray-700 mb-2">Họ Tên Quản Lý <span class="text-red-500">*</span></label>
                                    <input type="text" name="TEN_QUAN_LY" id="TEN_QUAN_LY"
                                           value="{% if form_data.TEN_QUAN_LY %}{{ form_data.TEN_QUAN_LY }}{% elif manager %}{{ manager.TEN_QUAN_LY|default_if_none:'' }}{% endif %}"
                                           required
                                           class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400"
                                           placeholder="Nhập họ tên">
                                    {% if form_errors.TEN_QUAN_LY %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.TEN_QUAN_LY }}</p>
                                    {% endif %}
                                </div>

                                <!-- Ngày sinh -->
                                <div>
                                    <label for="NGAY_SINH_QL" class="block text-sm font-medium text-gray-700 mb-2">Ngày Sinh <span class="text-red-500">*</span></label>
                                    <input type="date" name="NGAY_SINH_QL" id="NGAY_SINH_QL"
                                           value="{% if form_data.NGAY_SINH_QL %}{{ form_data.NGAY_SINH_QL }}{% elif manager %}{{ manager.NGAY_SINH_QL|date:'Y-m-d'|default_if_none:'' }}{% endif %}"
                                           required
                                           class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900">
                                    {% if form_errors.NGAY_SINH_QL %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.NGAY_SINH_QL }}</p>
                                    {% endif %}
                                </div>

                                <!-- Giới tính -->
                                <div>
                                    <label for="GIOI_TINH_QL" class="block text-sm font-medium text-gray-700 mb-2">Giới Tính <span class="text-red-500">*</span></label>
                                    <select name="GIOI_TINH_QL" id="GIOI_TINH_QL" required
                                            class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900">
                                        <option value="" disabled {% if not form_data.GIOI_TINH_QL and not manager %}selected{% endif %}>Chọn giới tính</option>
                                        <option value="Nam" {% if form_data.GIOI_TINH_QL == 'Nam' or manager and manager.GIOI_TINH_QL == 'Nam' %}selected{% endif %}>Nam</option>
                                        <option value="Nữ" {% if form_data.GIOI_TINH_QL == 'Nữ' or manager and manager.GIOI_TINH_QL == 'Nữ' %}selected{% endif %}>Nữ</option>
                                    </select>
                                    {% if form_errors.GIOI_TINH_QL %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.GIOI_TINH_QL }}</p>
                                    {% endif %}
                                </div>

                                <!-- Số điện thoại -->
                                <div>
                                    <label for="SDT_QUAN_LY" class="block text-sm font-medium text-gray-700 mb-2">Số Điện Thoại <span class="text-red-500">*</span></label>
                                    <input type="text" name="SDT_QUAN_LY" id="SDT_QUAN_LY"
                                           value="{% if form_data.SDT_QUAN_LY %}{{ form_data.SDT_QUAN_LY }}{% elif manager %}{{ manager.SDT_QUAN_LY|default_if_none:'' }}{% endif %}"
                                           placeholder="Nhập số điện thoại (10-11 chữ số)"
                                           pattern="[0-9]{10,11}" maxlength="11"
                                           title="Số điện thoại phải gồm 10-11 chữ số" required
                                           class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400">
                                    {% if form_errors.SDT_QUAN_LY %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.SDT_QUAN_LY }}</p>
                                    {% endif %}
                                </div>

                                <!-- Ngày bắt đầu -->
                                <div>
                                    <label for="NGAY_BAT_DAU" class="block text-sm font-medium text-gray-700 mb-2">Ngày Bắt Đầu <span class="text-red-500">*</span></label>
                                    <input type="date" name="NGAY_BAT_DAU" id="NGAY_BAT_DAU"
                                           value="{% if form_data.NGAY_BAT_DAU %}{{ form_data.NGAY_BAT_DAU }}{% elif manager and current_lich_su %}{{ current_lich_su.NGAY_BAT_DAU_QL|date:'Y-m-d'|default_if_none:'' }}{% endif %}"
                                           required
                                           class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900">
                                    {% if form_errors.NGAY_BAT_DAU %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.NGAY_BAT_DAU }}</p>
                                    {% endif %}
                                </div>

                                <!-- Vị trí công việc -->
                                <div>
                                    <label for="VI_TRI_CONG_VIEC" class="block text-sm font-medium text-gray-700 mb-2">Vị Trí Công Việc <span class="text-red-500">*</span></label>
                                    <input type="text" name="VI_TRI_CONG_VIEC" id="VI_TRI_CONG_VIEC"
                                           value="{% if form_data.VI_TRI_CONG_VIEC %}{{ form_data.VI_TRI_CONG_VIEC }}{% elif manager and current_lich_su %}{{ current_lich_su.VI_TRI_CONG_VIEC|default_if_none:'' }}{% endif %}"
                                           required
                                           class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400"
                                           placeholder="Nhập vị trí công việc">
                                    {% if form_errors.VI_TRI_CONG_VIEC %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.VI_TRI_CONG_VIEC }}</p>
                                    {% endif %}
                                </div>

                                <!-- Địa chỉ -->
                                <div class="col-span-1 md:col-span-2">
                                    <label for="DIA_CHI_QL" class="block text-sm font-medium text-gray-700 mb-2">Địa Chỉ</label>
                                    <textarea name="DIA_CHI_QL" id="DIA_CHI_QL"
                                              class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400"
                                              rows="4" placeholder="Nhập địa chỉ">{% if form_data.DIA_CHI_QL %}{{ form_data.DIA_CHI_QL }}{% elif manager %}{{ manager.DIA_CHI_QL|default_if_none:'' }}{% endif %}</textarea>
                                    {% if form_errors.DIA_CHI_QL %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.DIA_CHI_QL }}</p>
                                    {% endif %}
                                </div>

                                <!-- Tài khoản (chỉ hiển thị khi thêm mới) -->
                                {% if not manager %}
                                <div>
                                    <label for="TAI_KHOAN" class="block text-sm font-medium text-gray-700 mb-2">Tài Khoản <span class="text-red-500">*</span></label>
                                    <input type="text" name="TAI_KHOAN" id="TAI_KHOAN"
                                           value="{% if form_data.TAI_KHOAN %}{{ form_data.TAI_KHOAN }}{% endif %}"
                                           required
                                           class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400"
                                           placeholder="Nhập tên tài khoản">
                                    {% if form_errors.TAI_KHOAN %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.TAI_KHOAN }}</p>
                                    {% endif %}
                                </div>

                                <!-- Mật khẩu (chỉ hiển thị khi thêm mới) -->
                                <div>
                                    <label for="MAT_KHAU" class="block text-sm font-medium text-gray-700 mb-2">Mật Khẩu <span class="text-red-500">*</span></label>
                                    <input type="password" name="MAT_KHAU" id="MAT_KHAU"
                                           required
                                           class="block w-full rounded-lg border border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-gray-900 placeholder-gray-400"
                                           placeholder="Nhập mật khẩu">
                                    {% if form_errors.MAT_KHAU %}
                                        <p class="text-sm text-red-600 mt-1">{{ form_errors.MAT_KHAU }}</p>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sticky Footer -->
                        <div id="form_footer" class="hidden bg-white border-t border-gray-200 px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <span id="selected_khu_vuc_count">0</span> khu vực được chọn
                                </div>
                                <div class="flex gap-4">
                                    <button type="button" onclick="history.back()" 
                                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                                        Hủy
                                    </button>
                                    <button type="submit" id="btn_luu" disabled
                                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        <i class="fas fa-save mr-2"></i>
                                        {% if manager %}Cập Nhật{% else %}Lưu{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    {% if not manager %}
    // Code cho thêm mới nhân viên (có sidebar chọn khu vực)
    let currentSelectedKhuVuc = null;

    // Khi chọn khu vực
    window.selectKhuVuc = function(maKhuVuc, tenKhuVuc) {
        // Remove previous selection
        $('.khu-vuc-card').removeClass('border-blue-500 bg-blue-50');
        
        // Add selection to current khu vực
        $(`.khu-vuc-card[data-ma-khu-vuc="${maKhuVuc}"]`).addClass('border-blue-500 bg-blue-50');
        
        // Update hidden input
        $('#ma_khu_vuc').val(maKhuVuc);
        currentSelectedKhuVuc = { maKhuVuc, tenKhuVuc };
        
        // Update UI
        $('#selected_khu_vuc_info').text(`Đã chọn: ${tenKhuVuc}`);
        $('#empty_state').addClass('hidden');
        $('#manager_form').removeClass('hidden');
        $('#form_footer').removeClass('hidden');
        $('#selected_khu_vuc_count').text('1');
        
        // Enable save button
        $('#btn_luu').prop('disabled', false);
    };

    // Validation form trước khi submit
    $('#managerForm').submit(function(e) {
        if (!currentSelectedKhuVuc) {
            e.preventDefault();
            showNotification('Vui lòng chọn khu vực trước khi lưu.', 'error');
            return;
        }

        // Show loading state
        $('#btn_luu').prop('disabled', true).html(`
            <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Đang lưu...
        `);
    });

    function showNotification(message, type = 'success') {
        const alertClass = type === 'error' ? 'bg-red-50 border-red-400 text-red-800' : 'bg-green-50 border-green-400 text-green-800';
        const iconClass = type === 'error' ? 'text-red-400' : 'text-green-400';
        const iconPath = type === 'error' ? 
            'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z' :
            'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z';
        
        const notification = $(`
            <div class="p-4 mb-3 rounded-lg border-l-4 ${alertClass}">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 ${iconClass}" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                </div>
            </div>
        `);
        
        // Remove existing notifications
        $('.border-l-4').remove();
        
        // Add new notification
        $('.min-h-screen > .px-6').first().after(`<div class="px-6 py-4">${notification.prop('outerHTML')}</div>`);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            $('.border-l-4').parent().fadeOut();
        }, 5000);
    }
    {% else %}
    // Code cho chỉnh sửa nhân viên (form đơn giản)
    $('#managerForm').submit(function(e) {
        // Show loading state cho nút submit
        $('button[type="submit"]').prop('disabled', true).html(`
            <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Đang cập nhật...
        `);
    });
    {% endif %}
});
</script>
{% endblock %}