{% extends 'admin/admin_layout.html' %}
{% load static %}
{% load custom_filters %}

{% block content_body %}

<div class="max-w-7xl mx-auto">
    <div class="bg-white shadow-xl rounded-xl p-6 sm:p-8">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-10 gap-4 sm:gap-6">
            <h4 class="text-3xl font-extrabold text-blue-900 flex items-center whitespace-nowrap">
                <i class="fas fa-file-invoice-dollar mr-3 text-blue-700 text-2xl" aria-hidden="true"></i>
                Qu·∫£n l√Ω H√≥a ƒë∆°n
            </h4>
            <div class="flex flex-wrap sm:flex-nowrap items-center gap-3">
                <a href="{% url 'hoadon:them_hoa_don' 1 %}" class="inline-flex items-center px-5 py-2.5 bg-blue-700 text-white text-sm font-semibold rounded-lg hover:bg-blue-800 transition duration-300 shadow-md whitespace-nowrap">
                    <i class="fas fa-plus-circle mr-2" aria-hidden="true"></i> Th√™m h√≥a ƒë∆°n m·ªõi
                </a>
                <button class="inline-flex items-center px-5 py-2.5 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition duration-300 shadow-md whitespace-nowrap" type="button">
                    <i class="fas fa-file-export mr-2" aria-hidden="true"></i> Xu·∫•t Excel
                </button>
            </div>
        </div>

        <!-- Statistics Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium">T·ªïng h√≥a ƒë∆°n</p>
                        <p class="text-2xl font-bold">{{ total_invoices }}</p>
                    </div>
                    <div class="bg-blue-400 bg-opacity-50 rounded-full p-3">
                        <i class="fas fa-file-invoice-dollar text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium">ƒê√£ thu ti·ªÅn</p>
                        <p class="text-2xl font-bold">{{ paid_invoices_count|default:0 }}</p>
                    </div>
                    <div class="bg-green-400 bg-opacity-50 rounded-full p-3">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm font-medium">Ch∆∞a thanh to√°n</p>
                        <p class="text-2xl font-bold">{{ unpaid_invoices_count|default:0 }}</p>
                    </div>
                    <div class="bg-red-400 bg-opacity-50 rounded-full p-3">
                        <i class="fas fa-exclamation-circle text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-yellow-100 text-sm font-medium">ƒêang n·ª£</p>
                        <p class="text-2xl font-bold">{{ overdue_invoices_count|default:0 }}</p>
                    </div>
                    <div class="bg-yellow-400 bg-opacity-50 rounded-full p-3">
                        <i class="fas fa-clock text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Month & Year Selector -->
        <div class="w-full mb-6">
            <div class="flex justify-center items-center gap-1 flex-wrap">
                <a href="?year={{ year|add:-1 }}&month={{ current_month|slice:'0:2' }}" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium shadow-sm">
                    ‚Üê {{ year|add:-1 }}
                </a>
                {% for month in months %}
                    <a href="?year={{ month.year }}&month={{ month.month }}" class="px-3 py-2 text-sm rounded-lg font-medium transition {% if month.active %}bg-blue-600 text-white shadow-sm{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-300{% endif %}">
                        {{ month.short_name }}
                    </a>
                {% endfor %}
                <a href="?year={{ year|add:1 }}&month={{ current_month|slice:'0:2' }}" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 font-medium shadow-sm">
                    {{ year|add:1 }} ‚Üí
                </a>
            </div>
        </div>

        <!-- Advanced Filter Section -->
        <div class="bg-white shadow-lg rounded-xl border border-gray-200 mb-6">
            <!-- Filter Header -->
            <div class="border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-filter text-white text-sm"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">B·ªô l·ªçc h√≥a ƒë∆°n</h3>
                            <p class="text-sm text-gray-500">T√¨m ki·∫øm v√† l·ªçc h√≥a ƒë∆°n theo ti√™u ch√≠</p>
                        </div>
                    </div>
                    <button id="toggleFilter" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors duration-200 text-sm font-medium text-gray-700">
                        <i class="fas fa-chevron-down transition-transform duration-200" id="filterIcon"></i>
                        <span class="ml-2">Thu g·ªçn</span>
                    </button>
                </div>
            </div>
            
            
        </div>
        
       

        <!-- Table Section -->
        <div class="w-full">
            <table class="w-full table-auto border-collapse text-sm font-sans" id="table_khachthue">
                <thead class="sticky top-0 bg-blue-50 text-blue-800">
                    <tr class="bg-blue-100 text-blue-900">
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[12%]">T√™n ph√≤ng</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[10%]">Ti·ªÅn ph√≤ng</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[8%]">Ti·ªÅn ƒëi·ªán</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[8%]">Ti·ªÅn n∆∞·ªõc</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[12%]">D·ªãch v·ª• kh√°c</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[10%]">Thu/tr·∫£ c·ªçc</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[12%]">C·ªông th√™m/Gi·∫£m tr·ª´</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[10%]">T·ªïng c·ªông</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[10%]">C·∫ßn thu</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[10%]">Tr·∫°ng th√°i</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[8%]"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for hoa_don in hoa_dons %}
                        <tr class="hover:bg-gray-100 transition duration-200 border-b border-gray-200">
                            <td class="text-center p-3">
                                <strong class="text-gray-800 block">{{ hoa_don.phong_info.TEN_PHONG }}</strong>
                                <span class="text-green-600 font-medium text-sm">{{ hoa_don.LOAI_HOA_DON }}</span><br>
                                <span class="text-gray-500 text-sm">({{ hoa_don.NGAY_LAP_HDON|date:"d/m/Y" }})</span>
                            </td>
                            <td class="text-center p-3">{{ hoa_don.tien_phong|currency_vn }}</td>
                            <td class="text-center p-3">{{ hoa_don.tien_dien|currency_vn }}</td>
                            <td class="text-center p-3">{{ hoa_don.tien_nuoc|currency_vn }}</td>
                            <td class="text-center p-3">{{ hoa_don.tien_dich_vu_khac|currency_vn }}</td>
                            <td class="text-center p-3">{{ hoa_don.tien_coc|currency_vn }}</td>
                            <td class="text-center p-3">{{ hoa_don.tong_khau_tru|currency_vn }}</td>
                            <td class="text-center p-3 font-semibold">{{ hoa_don.TONG_TIEN|currency_vn }}</td>
                            <td class="text-center p-3">
                                <span class="{{ status_mapping.hoa_don.TRANG_THAI_HDON.color }} text-white font-medium px-3 py-1.5 rounded-full text-sm min-w-[120px] inline-block transition duration-300 hover:shadow-sm">
                                    {{ status_mapping.hoa_don.TRANG_THAI_HDON.text }}
                                </span>
                            </td>
                           <td class="p-3 relative">
                            <!-- N√∫t m·ªü menu -->
                            <div class="inline-flex items-center justify-center w-8 h-8 bg-gray-200 rounded-full cursor-pointer hover:bg-gray-300 transition tooltipHoaDon" 
                                onclick="toggleMenuHoaDon({{ hoa_don.MA_HOA_DON }})">
                                <i class="fas fa-ellipsis-v text-gray-600" aria-hidden="true"></i>
                            </div>

                            <!-- Menu -->
                            <div id="menuHoaDon-{{ hoa_don.MA_HOA_DON }}" 
                                onmouseleave="hideMenuHoaDon({{ hoa_don.MA_HOA_DON }})" 
                                class="absolute right-0 mt-2 w-64 origin-top-right bg-white border border-gray-200 rounded-xl shadow-lg z-20 hidden">
                                
                                <a href="{% url 'hoadon:hoadon_detail' hoa_don.MA_HOA_DON %}" 
                                class="block px-4 py-2 text-gray-700 text-sm hover:bg-gray-100 rounded flex items-center">
                                    <i class="fas fa-file-invoice mr-2"></i> Xem chi ti·∫øt h√≥a ƒë∆°n
                                </a>                          
                                <a href="#" 
                                class="block px-4 py-2 text-gray-700 text-sm hover:bg-gray-100 rounded flex items-center"
                                onclick="toggleShareInvoiceModal(true, '/admin/hoadon/chitiet-hoadon/{{ hoa_don.MA_HOA_DON }}')">
                                    <i class="fas fa-share-alt mr-2"></i> Chia s·∫ª h√≥a ƒë∆°n
                                </a>

                                <a href="#" 
                                class="block px-4 py-2 text-gray-700 text-sm hover:bg-gray-100 rounded flex items-center"
                                onclick="guiHoaDonChoKhach({{ hoa_don.MA_HOA_DON }})">
                                    <i class="fas fa-paper-plane mr-2"></i> G·ª≠i cho kh√°ch thu√™
                                </a>

                                <a href="#" 
                                class="block px-4 py-2 text-gray-700 text-sm hover:bg-gray-100 rounded flex items-center"
                                onclick="thanhToanHoaDon({{ hoa_don.MA_HOA_DON }})">
                                    <i class="fas fa-credit-card mr-2"></i> Thanh to√°n
                                </a>

                                <a href="{% url 'hoadon:sua_hoa_don' hoa_don.MA_HOA_DON %}" 
                                class="block px-4 py-2 text-gray-700 text-sm hover:bg-gray-100 rounded flex items-center">
                                    <i class="fas fa-edit mr-2"></i> Ch·ªânh s·ª≠a h√≥a ƒë∆°n
                                </a>

                                <a href="#" 
                                    class="block px-4 py-2 text-red-600 text-sm hover:bg-red-50 rounded flex items-center" 
                                    onclick="xoaHoaDon({{ hoa_don.MA_HOA_DON }})">
                                    <i class="fas fa-trash mr-2 text-red-600"></i> X√≥a h√≥a ƒë∆°n
                                </a>
                            </div>
                        </td>

                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Advanced Pagination for Invoices -->
        {% include 'admin/components/pagination_invoice.html' with page_obj=hoa_dons current_page_size=current_page_size total_count=total_invoices %}
        </div>

        <!-- Modal -->
        <div id="hoaDonModal" tabindex="-1" role="dialog" aria-modal="true" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300 ease-in-out" onclick="if(event.target === this) toggleHoaDonModal(false)">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-center relative px-6 py-4 bg-blue-600 rounded-t-xl">
                    <h4 id="hoaDonModalLabel" class="text-white text-xl font-semibold text-center flex-grow">
                        Ch·ªânh s·ª≠a h√≥a ƒë∆°n
                    </h4>
                    <button type="button" aria-label="ƒê√≥ng" class="absolute right-6 top-1/2 transform -translate-y-1/2 text-white text-3xl font-bold hover:text-blue-300 focus:outline-none" onclick="toggleHoaDonModal(false)">
                        √ó
                    </button>
                </div>
                <div id="modalContentHoaDon" class="px-8 py-6">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-700 mx-auto mb-4"></div>
                        <p class="text-blue-700">ƒêang t·∫£i th√¥ng tin h√≥a ƒë∆°n...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
<div id="shareInvoiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white w-full max-w-lg rounded-lg shadow-lg p-6 relative">
    <!-- N√∫t ƒë√≥ng -->
    <button onclick="toggleShareInvoiceModal(false)" class="absolute top-2 right-3 text-gray-500 hover:text-black">
      <i class="fas fa-times"></i>
    </button>

    <h2 class="text-xl font-semibold mb-4">Chia s·∫ª h√≥a ƒë∆°n</h2>

    <!-- Link chia s·∫ª & n√∫t sao ch√©p -->
    <div class="flex items-center bg-gray-100 rounded px-3 py-2 mb-4">
      <input id="shareInvoiceLink" type="text" readonly class="w-full border rounded px-3 py-1 text-sm" />
      <button onclick="copyInvoiceShareLink()" 
              class="text-blue-600 hover:text-blue-800 text-sm font-medium ml-3">Sao ch√©p</button>
    </div>

    <!-- M√£ QR -->
    <div class="text-center mb-4">
      <img id="invoiceQRCode" src="" alt="QR Code" class="mx-auto border rounded" />
    </div>
  </div>
</div>
<script>
  function toggleShareInvoiceModal(show, url = '') {
    const modal = document.getElementById('shareInvoiceModal');
    if (show) {
      const shareLink = url.startsWith('http') ? url : window.location.origin + url;
      document.getElementById('shareInvoiceLink').value = shareLink;
      generateInvoiceQRCode(shareLink);
      modal.classList.remove('hidden');
    } else {
      modal.classList.add('hidden');
    }
  }

  function copyInvoiceShareLink() {
    const input = document.getElementById('shareInvoiceLink');
    input.select();
    document.execCommand('copy');
    alert('ƒê√£ sao ch√©p li√™n k·∫øt h√≥a ƒë∆°n!');
  }

  function generateInvoiceQRCode(link) {
    const qrImg = document.getElementById('invoiceQRCode');
    qrImg.src = `https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl=${encodeURIComponent(link)}`;
  }

  // ======================= FILTER FUNCTIONS =======================
  
  document.addEventListener('DOMContentLoaded', function() {
    initializeFilterSystem();
    loadAreaOptions();
    
    // Load current filter state from URL
    loadCurrentFilters();
  });
  
  function initializeFilterSystem() {
    // Toggle filter section
    const toggleBtn = document.getElementById('toggleFilter');
    const filterContent = document.getElementById('filterContent');
    const filterIcon = document.getElementById('filterIcon');
    
    toggleBtn.addEventListener('click', function() {
      const isHidden = filterContent.classList.contains('hidden');
      if (isHidden) {
        filterContent.classList.remove('hidden');
        filterIcon.classList.add('rotate-180');
        toggleBtn.querySelector('span').textContent = 'Thu g·ªçn';
      } else {
        filterContent.classList.add('hidden');
        filterIcon.classList.remove('rotate-180');
        toggleBtn.querySelector('span').textContent = 'M·ªü r·ªông';
      }
    });
    

    
    // Real-time search
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        updateFilterSummary();
      }, 300);
    });
    
    // Update summary on filter change
    ['statusFilter', 'typeFilter', 'sortFilter', 'minAmount', 'maxAmount'].forEach(id => {
      document.getElementById(id).addEventListener('change', updateFilterSummary);
    });
  }
  
  async function loadAreaOptions() {
    try {
      const response = await fetch('/admin/api/khu-vuc-list/');
      const data = await response.json();
      
      const areaSelect = document.getElementById('areaFilter');
      areaSelect.innerHTML = '<option value="">T·∫•t c·∫£ khu v·ª±c</option>';
      
      data.khu_vuc_list.forEach(area => {
        const option = document.createElement('option');
        option.value = area.MA_KHU_VUC;
        option.textContent = area.TEN_KHU_VUC;
        areaSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading areas:', error);
    }
  }
  
  async function loadRoomOptions(areaId) {
    const roomSelect = document.getElementById('roomFilter');
    roomSelect.innerHTML = '<option value="">T·∫•t c·∫£ ph√≤ng</option>';
    
    if (!areaId) return;
    
    try {
      const response = await fetch('/admin/api/phong-theo-khu-vuc/?khu_vuc=' + areaId);
      const data = await response.json();
      
      data.phong_tros.forEach(room => {
        const option = document.createElement('option');
        option.value = room.MA_PHONG;
        option.textContent = room.TEN_PHONG || `Ph√≤ng ${room.MA_PHONG}`;
        roomSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading rooms:', error);
    }
  }
  
  function applyFilters() {
    const filters = getCurrentFilters();
    const url = new URL(window.location);
    
    // Clear existing filter params
    ['search', 'area', 'room', 'status', 'type', 'sort', 'min_amount', 'max_amount'].forEach(param => {
      url.searchParams.delete(param);
    });
    
    // Add new filter params
    Object.keys(filters).forEach(key => {
      if (filters[key]) {
        url.searchParams.set(key, filters[key]);
      }
    });
    
    // Preserve month and year
    const currentMonth = url.searchParams.get('month');
    const currentYear = url.searchParams.get('year');
    
    showLoadingState();
    window.location.href = url.toString();
  }
  
  function clearFilters() {
    // Reset all filter inputs
    document.getElementById('searchInput').value = '';
    document.getElementById('areaFilter').value = '';
    document.getElementById('roomFilter').innerHTML = '<option value="">T·∫•t c·∫£ ph√≤ng</option>';
    document.getElementById('statusFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('sortFilter').value = 'date_desc';
    document.getElementById('minAmount').value = '';
    document.getElementById('maxAmount').value = '';
    
    // Update summary
    updateFilterSummary();
    
    // Apply cleared filters
    applyFilters();
  }
  
  function getCurrentFilters() {
    return {
      search: document.getElementById('searchInput').value.trim(),
      area: document.getElementById('areaFilter').value,
      room: document.getElementById('roomFilter').value,
      status: document.getElementById('statusFilter').value,
      type: document.getElementById('typeFilter').value,
      sort: document.getElementById('sortFilter').value,
      min_amount: document.getElementById('minAmount').value,
      max_amount: document.getElementById('maxAmount').value
    };
  }
  
  function loadCurrentFilters() {
    const url = new URL(window.location);
    
    // Load filters from URL params
    const filters = {
      search: url.searchParams.get('search') || '',
      area: url.searchParams.get('area') || '',
      room: url.searchParams.get('room') || '',
      status: url.searchParams.get('status') || '',
      type: url.searchParams.get('type') || '',
      sort: url.searchParams.get('sort') || 'date_desc',
      min_amount: url.searchParams.get('min_amount') || '',
      max_amount: url.searchParams.get('max_amount') || ''
    };
    
    // Set form values
    Object.keys(filters).forEach(key => {
      const element = document.getElementById(key === 'search' ? 'searchInput' : 
                                           key === 'area' ? 'areaFilter' :
                                           key === 'room' ? 'roomFilter' :
                                           key === 'status' ? 'statusFilter' :
                                           key === 'type' ? 'typeFilter' :
                                           key === 'sort' ? 'sortFilter' :
                                           key === 'min_amount' ? 'minAmount' :
                                           key === 'max_amount' ? 'maxAmount' : key);
      if (element && filters[key]) {
        element.value = filters[key];
      }
    });
    
    // Load rooms if area is selected
    if (filters.area) {
      loadRoomOptions(filters.area).then(() => {
        if (filters.room) {
          document.getElementById('roomFilter').value = filters.room;
        }
      });
    }
    
    updateFilterSummary();
  }
  
  function updateFilterSummary() {
    const filters = getCurrentFilters();
    const activeCount = Object.values(filters).filter(v => v && v !== 'date_desc').length;
    
    const summary = document.getElementById('filterSummary');
    const activeFiltersDiv = document.getElementById('activeFilters');
    const countSpan = document.getElementById('filterCount');
    
    countSpan.textContent = activeCount;
    
    if (activeCount > 0) {
      summary.classList.remove('hidden');
      showActiveFilterTags(filters);
    } else {
      summary.classList.add('hidden');
      activeFiltersDiv.classList.add('hidden');
    }
  }
  
  function showActiveFilterTags(filters) {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const container = activeFiltersDiv.querySelector('.flex');
    
    // Clear existing tags except label
    const existingTags = container.querySelectorAll('.filter-tag');
    existingTags.forEach(tag => tag.remove());
    
    const filterLabels = {
      search: 'T√¨m ki·∫øm',
      area: 'Khu v·ª±c',
      room: 'Ph√≤ng',
      status: 'Tr·∫°ng th√°i',
      type: 'Lo·∫°i',
      sort: 'S·∫Øp x·∫øp',
      min_amount: 'T·ª´',
      max_amount: 'ƒê·∫øn'
    };
    
    let hasActiveTags = false;
    
    Object.keys(filters).forEach(key => {
      if (filters[key] && filters[key] !== 'date_desc') {
        hasActiveTags = true;
        const tag = document.createElement('span');
        tag.className = 'filter-tag inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full border border-blue-200';
        
        let displayValue = filters[key];
        if (key === 'min_amount' || key === 'max_amount') {
          displayValue = new Intl.NumberFormat('vi-VN').format(filters[key]) + 'ƒë';
        }
        
        tag.innerHTML = `
          <span class="mr-1 font-medium">${filterLabels[key]}:</span>
          <span>${displayValue}</span>
          <button onclick="removeFilter('${key}')" class="ml-2 text-blue-600 hover:text-blue-800">
            <i class="fas fa-times text-xs"></i>
          </button>
        `;
        container.appendChild(tag);
      }
    });
    
    if (hasActiveTags) {
      activeFiltersDiv.classList.remove('hidden');
    } else {
      activeFiltersDiv.classList.add('hidden');
    }
  }
  
  function removeFilter(filterKey) {
    const elementMap = {
      search: 'searchInput',
      area: 'areaFilter',
      room: 'roomFilter',
      status: 'statusFilter',
      type: 'typeFilter',
      sort: 'sortFilter',
      min_amount: 'minAmount',
      max_amount: 'maxAmount'
    };
    
    const element = document.getElementById(elementMap[filterKey]);
    if (element) {
      element.value = filterKey === 'sort' ? 'date_desc' : '';
      if (filterKey === 'area') {
        document.getElementById('roomFilter').innerHTML = '<option value="">T·∫•t c·∫£ ph√≤ng</option>';
      }
    }
    
    updateFilterSummary();
    applyFilters();
  }
  
  function exportWithFilters() {
    const filters = getCurrentFilters();
    const url = new URL('/admin/hoa-don/export/', window.location.origin);
    
    // Add filter params
    Object.keys(filters).forEach(key => {
      if (filters[key]) {
        url.searchParams.set(key, filters[key]);
      }
    });
    
    // Add month/year
    const currentUrl = new URL(window.location);
    const month = currentUrl.searchParams.get('month');
    const year = currentUrl.searchParams.get('year');
    if (month) url.searchParams.set('month', month);
    if (year) url.searchParams.set('year', year);
    
    window.open(url.toString(), '_blank');
  }

  // ======================= PAGINATION FUNCTIONS =======================
  
  /**
   * Thay ƒë·ªïi s·ªë l∆∞·ª£ng item m·ªói trang
   */
  function changePageSize(newSize) {
    showLoadingState();
    const url = new URL(window.location);
    url.searchParams.set('page_size', newSize);
    url.searchParams.set('page', '1'); // Reset v·ªÅ trang 1 khi thay ƒë·ªïi page size
    
    // Preserve month and year parameters
    const month = url.searchParams.get('month');
    const year = url.searchParams.get('year');
    if (month) url.searchParams.set('month', month);
    if (year) url.searchParams.set('year', year);
    
    window.location.href = url.toString();
  }

  /**
   * Hi·ªÉn th·ªã loading state khi chuy·ªÉn trang
   */
  function showLoadingState() {
    // T·∫°o overlay loading
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loadingOverlay';
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-25 z-50 flex items-center justify-center';
    loadingOverlay.innerHTML = `
      <div class="bg-white rounded-lg p-6 shadow-xl flex items-center space-x-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
        <span class="text-gray-700 font-medium">ƒêang t·∫£i h√≥a ƒë∆°n...</span>
      </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    // Auto remove sau 5s ƒë·ªÉ tr√°nh stuck
    setTimeout(() => {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.remove();
    }, 5000);
  }

  /**
   * ƒêi ƒë·∫øn trang c·ª• th·ªÉ
   */
  function goToPage(pageNumber) {
    showLoadingState();
    const url = new URL(window.location);
    url.searchParams.set('page', pageNumber);
    
    // Preserve other parameters
    const month = url.searchParams.get('month');
    const year = url.searchParams.get('year');
    const pageSize = url.searchParams.get('page_size');
    if (month) url.searchParams.set('month', month);
    if (year) url.searchParams.set('year', year);
    if (pageSize) url.searchParams.set('page_size', pageSize);
    
    window.location.href = url.toString();
  }

  /**
   * Th√™m loading cho t·∫•t c·∫£ pagination links
   */
  function addLoadingToPaginationLinks() {
    const paginationLinks = document.querySelectorAll('nav[aria-label="Pagination"] a, .sm\\:hidden a[href*="page="]');
    paginationLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        // Ch·ªâ show loading n·∫øu kh√¥ng ph·∫£i c√πng trang
        const url = new URL(this.href);
        const targetPage = url.searchParams.get('page');
        const currentPage = {{ hoa_dons.number|default:1 }};
        
        if (targetPage != currentPage) {
          showLoadingState();
        }
      });
    });
  }

  /**
   * Hi·ªÉn th·ªã th√¥ng tin ph√¢n trang ƒë·∫πp h∆°n tr√™n mobile
   */
  function updateMobilePaginationInfo() {
    const currentPage = {{ hoa_dons.number|default:1 }};
    const totalPages = {{ hoa_dons.paginator.num_pages|default:1 }};
    const startIndex = {{ hoa_dons.start_index|default:0 }};
    const endIndex = {{ hoa_dons.end_index|default:0 }};
    const totalCount = {{ total_invoices|default:0 }};
    
    // C√≥ th·ªÉ s·ª≠ d·ª•ng ƒë·ªÉ c·∫≠p nh·∫≠t UI ƒë·ªông n·∫øu c·∫ßn
    console.log(`üìÑ Ph√¢n trang h√≥a ƒë∆°n: Trang ${currentPage}/${totalPages}, Hi·ªÉn th·ªã ${startIndex}-${endIndex}/${totalCount}`);
  }

  // G·ªçi khi trang load xong
  document.addEventListener('DOMContentLoaded', function() {
    updateMobilePaginationInfo();
    addLoadingToPaginationLinks();
    
    // Th√™m keyboard shortcuts cho pagination
    document.addEventListener('keydown', function(e) {
      // Ch·ªâ ho·∫°t ƒë·ªông khi kh√¥ng focus v√†o input/textarea
      if (document.activeElement.tagName.toLowerCase() === 'input' || 
          document.activeElement.tagName.toLowerCase() === 'textarea') {
        return;
      }
      
      const currentPage = {{ hoa_dons.number|default:1 }};
      const totalPages = {{ hoa_dons.paginator.num_pages|default:1 }};
      
      // Arrow Left = Previous Page
      if (e.key === 'ArrowLeft' && currentPage > 1) {
        e.preventDefault();
        goToPage(currentPage - 1);
      }
      
      // Arrow Right = Next Page  
      if (e.key === 'ArrowRight' && currentPage < totalPages) {
        e.preventDefault();
        goToPage(currentPage + 1);
      }
      
      // Home = First Page
      if (e.key === 'Home') {
        e.preventDefault();
        goToPage(1);
      }
      
      // End = Last Page
      if (e.key === 'End') {
        e.preventDefault();
        goToPage(totalPages);
      }
    });
  });
</script>
<script src="{% static 'js/admin/hoadon/hoadon.js' %}"></script>
{% endblock %}