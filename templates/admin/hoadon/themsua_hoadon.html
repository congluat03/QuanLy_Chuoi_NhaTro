{% extends 'admin/admin_layout.html' %}
{% load static %}

{% block content_body %}
<!-- Hóa đơn dịch vụ -->
<div class="bg-white shadow-lg rounded-lg p-6 mb-6">
    <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-cog mr-2 text-blue-600"></i> Thông tin thiết lập dịch vụ
    </h4>
    <div class="overflow-x-auto">
        {% if chi_so_dich_vu %}
            <table class="w-full table-auto border-collapse text-sm font-sans">
                <thead class="bg-blue-50 text-blue-800">
                    <tr>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[5%]">#</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Tên dịch vụ</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Chỉ số cũ</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Chỉ số mới</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Số dịch vụ</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Thành tiền</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[20%]">Chức năng</th>
                    </tr>
                </thead>
                <tbody>
                    {% for dich_vu in chi_so_dich_vu %}
                        <tr id="dichvu-{{ dich_vu.MA_CHI_SO }}" class="hover:bg-gray-100 transition duration-200 border-b border-gray-200">
                            <td class="p-3 text-center text-gray-800 text-sm">{{ forloop.counter }}</td>
                            <td class="p-3 text-center text-gray-800 text-sm">{{ dich_vu.MA_DICH_VU.TEN_DICH_VU }}</td>
                            <td class="p-3 text-center">
                                <input type="number" name="CHISOCU[{{ dich_vu.MA_CHI_SO }}]" value="{{ dich_vu.CHI_SO_CU|default:'0' }}"
                                    class="form-control w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm bg-gray-50"
                                    id="CHISOCU-{{ dich_vu.MA_CHI_SO }}" step="0.01" disabled>
                            </td>
                            <td class="p-3 text-center">
                                <input type="number" name="CHISOMOI[{{ dich_vu.MA_CHI_SO }}]" value="{{ dich_vu.CHI_SO_MOI|default:'0' }}"
                                    class="form-control w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm"
                                    id="CHISOMOI-{{ dich_vu.MA_CHI_SO }}" step="0.01" disabled>
                            </td>
                            <td class="p-3 text-center">
                                <input type="number" name="SODICHVUTONG[{{ dich_vu.MA_CHI_SO }}]" value="{{ dich_vu.so_dich_vu|default:'0' }}"
                                    class="form-control w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm bg-gray-50"
                                    id="SODICHVUTONG-{{ dich_vu.MA_CHI_SO }}" step="0.01" disabled>
                            </td>
                            <td class="p-3 text-center">
                                <input type="number" name="TIENDICHVUGHIDUOC[{{ dich_vu.MA_CHI_SO }}]" value="{{ dich_vu.thanh_tien|default:'0' }}"
                                    class="form-control w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm bg-gray-50"
                                    id="TIENDICHVUGHIDUOC-{{ dich_vu.MA_CHI_SO }}" step="0.01" disabled>
                            </td>
                            <td class="p-3 text-center">
                                <button type="button" class="btn-toggle-status bg-blue-600 text-white text-xs font-medium px-3 py-1.5 rounded-md hover:bg-blue-700 transition duration-200"
                                    id="button-{{ dich_vu.MA_CHI_SO }}" data-status="1"
                                    onclick="chinhSuaChiSoDichVu({{ dich_vu.MA_CHI_SO }}, {{ dich_vu.gia_dich_vu|default:'0' }})">
                                    Chỉnh sửa
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-gray-600 text-center py-4">Không có thông tin dịch vụ.</p>
        {% endif %}
    </div>
</div>

<!-- Khấu trừ -->
<div class="bg-white shadow-lg rounded-lg p-6">
    <h4 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-minus-circle mr-2 text-red-600"></i> Quản lý khấu trừ
    </h4>
    <form id="discount-form" method="POST" action="{% url 'hoadon:them_hoa_don' %}" class="mb-6">
        {% csrf_token %}
        <input type="hidden" name="MA_HOA_DON" value="{{ hoa_don.MA_HOA_DON }}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Cột 1 -->
            <div>
                <div class="mb-4">
                    <label for="NGAYKHAUTRU" class="block text-sm font-medium text-gray-700 mb-1">Ngày khấu trừ</label>
                    <input name="NGAYKHAUTRU" id="NGAYKHAUTRU" type="date" class="w-full border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        value="{{ form_data.NGAYKHAUTRU|default:'' }}" required>
                </div>
                <div class="mb-4">
                    <label for="LOAI_KHAU_TRU" class="block text-sm font-medium text-gray-700 mb-1">Loại điều chỉnh</label>
                    <select name="LOAI_KHAU_TRU" id="LOAI_KHAU_TRU" class="w-full border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>Chọn loại điều chỉnh</option>
                        <option value="Cộng" {% if form_data.LOAI_KHAU_TRU == 'Cộng' %}selected{% endif %}>Cộng</option>
                        <option value="Trừ" {% if form_data.LOAI_KHAU_TRU == 'Trừ' %}selected{% endif %}>Trừ</option>
                    </select>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-blue-600 text-white font-medium px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200">Lưu thông tin</button>
                </div>
            </div>
            <!-- Cột 2 -->
            <div>
                <div class="mb-4">
                    <label for="SO_TIEN_KT" class="block text-sm font-medium text-gray-700 mb-1">Tiền khấu trừ</label>
                    <input name="SO_TIEN_KT" id="SO_TIEN_KT" type="number" step="1000" class="w-full border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        value="{{ form_data.SO_TIEN_KT|default:'' }}" required>
                </div>
                <div class="mb-4">
                    <label for="LY_DO_KHAU_TRU" class="block text-sm font-medium text-gray-700 mb-1">Lý do khấu trừ</label>
                    <textarea name="LY_DO_KHAU_TRU" id="LY_DO_KHAU_TRU" class="w-full border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="4" required>{{ form_data.LY_DO_KHAU_TRU|default:'' }}</textarea>
                </div>
            </div>
        </div>
    </form>

    <!-- Bảng khấu trừ -->
    <div id="discount-info">
        {% if khau_tru %}
            <table class="w-full table-auto border-collapse text-sm font-sans">
                <thead class="bg-blue-50 text-blue-800">
                    <tr>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[5%]">#</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Loại điều chỉnh</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[20%]">Tiền khấu trừ</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[30%]">Lý do</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Ngày khấu trừ</th>
                        <th class="p-3 font-semibold text-center text-xs md:text-sm w-[15%]">Chức năng</th>
                    </tr>
                </thead>
                <tbody id="discount-details">
                    {% for item in khau_tru %}
                        <tr id="khautru-{{ item.MA_KHAU_TRU }}" class="hover:bg-gray-100 transition duration-200 border-b border-gray-200">
                            <td class="p-3 text-center text-gray-800 text-sm">{{ forloop.counter }}</td>
                            <td class="p-3 text-center">
                                <select id="loai_khau_tru_{{ item.MA_KHAU_TRU }}" class="w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm bg-transparent" disabled>
                                    <option value="Cộng" {% if item.LOAI_KHAU_TRU == 'Cộng' %}selected{% endif %}>Cộng</option>
                                    <option value="Trừ" {% if item.LOAI_KHAU_TRU == 'Trừ' %}selected{% endif %}>Trừ</option>
                                </select>
                            </td>
                            <td class="p-3 text-center">
                                <input id="so_tien_kt_{{ item.MA_KHAU_TRU }}" type="number" step="1000" value="{{ item.SO_TIEN_KT|floatformat:2 }}"
                                    class="w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm bg-transparent" readonly>
                            </td>
                            <td class="p-3 text-center">
                                <input id="ly_do_khau_tru_{{ item.MA_KHAU_TRU }}" type="text" value="{{ item.LY_DO_KHAU_TRU }}"
                                    class="w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm bg-transparent" readonly>
                            </td>
                            <td class="p-3 text-center">
                                <input id="ngay_khau_tru_{{ item.MA_KHAU_TRU }}" type="date" value="{{ item.NGAYKHAUTRU|date:'Y-m-d' }}"
                                    class="w-full text-center border border-gray-300 rounded-md py-1 px-2 text-sm bg-transparent" readonly>
                            </td>
                            <td class="p-3 text-center">
                                <button class="bg-blue-600 text-white text-xs font-medium px-3 py-1.5 rounded-md hover:bg-blue-700 transition duration-200"
                                    id="edit-{{ item.MA_KHAU_TRU }}" onclick="editDiscount({{ item.MA_KHAU_TRU }})">
                                    <i class="fa fa-edit mr-1"></i> <span id="action-btn-{{ item.MA_KHAU_TRU }}">Chỉnh sửa</span>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-gray-600 text-center py-4">Không có thông tin khấu trừ.</p>
        {% endif %}
    </div>
</div>

<script>
    function chinhSuaChiSoDichVu(maChiSo, giaDichVu) {
        const button = document.getElementById(`button-${maChiSo}`);
        const chiSoCuInput = document.getElementById(`CHISOCU-${maChiSo}`);
        const chiSoMoiInput = document.getElementById(`CHISOMOI-${maChiSo}`);
        const soDichVuInput = document.getElementById(`SODICHVUTONG-${maChiSo}`);
        const thanhTienInput = document.getElementById(`TIENDICHVUGHIDUOC-${maChiSo}`);
        const status = button.getAttribute('data-status');

        if (status === '1') {
            chiSoMoiInput.disabled = false;
            chiSoMoiInput.focus();
            button.innerText = 'Lưu';
            button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            button.classList.add('bg-green-600', 'hover:bg-green-700');
            button.setAttribute('data-status', '0');

            chiSoMoiInput.addEventListener('input', () => {
                const chiSoCu = parseFloat(chiSoCuInput.value) || 0;
                const chiSoMoi = parseFloat(chiSoMoiInput.value) || 0;
                const soDichVu = chiSoMoi - chiSoCu;
                soDichVuInput.value = soDichVu.toFixed(2);
                thanhTienInput.value = (soDichVu * giaDichVu).toFixed(2);
            });
        } else {
            chiSoMoiInput.disabled = true;
            button.innerText = 'Chỉnh sửa';
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-blue-600', 'hover:bg-blue-700');
            button.setAttribute('data-status', '1');

            // Gửi AJAX để lưu
            fetch(`/api/chi-so-dich-vu/${maChiSo}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    CHI_SO_MOI: chiSoMoiInput.value,
                    SO_DICH_VU: soDichVuInput.value,
                    THANH_TIEN: thanhTienInput.value
                })
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    alert('Cập nhật chỉ số dịch vụ thành công!');
                } else {
                    alert('Lỗi: ' + data.message);
                }
            });
        }
    }

    function editDiscount(maKhauTru) {
        const button = document.getElementById(`edit-${maKhauTru}`);
        const loaiInput = document.getElementById(`loai_khau_tru_${maKhauTru}`);
        const tienInput = document.getElementById(`so_tien_kt_${maKhauTru}`);
        const lyDoInput = document.getElementById(`ly_do_khau_tru_${maKhauTru}`);
        const ngayInput = document.getElementById(`ngay_khau_tru_${maKhauTru}`);
        const actionSpan = document.getElementById(`action-btn-${maKhauTru}`);

        if (loaiInput.disabled) {
            loaiInput.disabled = false;
            tienInput.readOnly = false;
            lyDoInput.readOnly = false;
            ngayInput.readOnly = false;
            actionSpan.innerText = 'Lưu';
            button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            button.classList.add('bg-green-600', 'hover:bg-green-700');
        } else {
            loaiInput.disabled = true;
            tienInput.readOnly = true;
            lyDoInput.readOnly = true;
            ngayInput.readOnly = true;
            actionSpan.innerText = 'Chỉnh sửa';
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-blue-600', 'hover:bg-blue-700');

            // Gửi AJAX để lưu
            fetch(`/api/khau-tru/${maKhauTru}/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    LOAI_KHAU_TRU: loaiInput.value,
                    SO_TIEN_KT: tienInput.value,
                    LY_DO_KHAU_TRU: lyDoInput.value,
                    NGAYKHAUTRU: ngayInput.value
                })
            }).then(response => response.json()).then(data => {
                if (data.success) {
                    alert('Cập nhật khấu trừ thành công!');
                } else {
                    alert('Lỗi: ' + data.message);
                }
            });
        }
    }
</script>
{% endblock %}