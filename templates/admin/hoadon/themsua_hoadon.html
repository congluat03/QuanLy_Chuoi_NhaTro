{% extends 'admin/admin_layout.html' %}
{% load static %}

{% block title %}{% if hoa_don %}Sửa hóa đơn{% else %}Lập hóa đơn mới{% endif %}{% endblock %}

{% block content_body %}
<div class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            {% if hoa_don %}Sửa hóa đơn #{{ hoa_don.MA_HOA_DON }}{% else %}Lập hóa đơn mới{% endif %}
                        </h1>
                        <p class="text-gray-600">Quản lý hóa đơn thanh toán theo phòng</p>
                    </div>
                </div>
                <a href="{% url 'hoadon:hoadon_list' %}" 
                   class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Quay lại
                </a>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="px-6 py-4">
            {% for message in messages %}
            <div class="p-4 mb-3 rounded-lg border-l-4 {% if message.tags == 'error' %}bg-red-50 border-red-400 text-red-800{% else %}bg-green-50 border-green-400 text-green-800{% endif %}">
                <div class="flex">
                    <div class="flex-shrink-0">
                        {% if message.tags == 'error' %}
                        <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        {% else %}
                        <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        {% endif %}
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">{{ message }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Main Layout -->
        <div class="max-w-screen-xl mx-auto flex h-screen">
            <!-- Left Sidebar - 30% -->
            <div class="w-[30%] bg-white border-r border-gray-200 flex flex-col rounded-l-xl shadow-lg">
                <!-- Filter Section -->
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"></path>
                        </svg>
                        Bộ lọc phòng
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label for="khu_vuc" class="block text-sm font-medium text-gray-700 mb-2">
                                Khu vực
                            </label>
                            <select id="khu_vuc" name="khu_vuc"
                                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-sm">
                                <option value="">Chọn khu vực</option>
                                {% for kv in khu_vucs %}
                                <option value="{{ kv.MA_KHU_VUC }}">{{ kv.TEN_KHU_VUC }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="thang_hoa_don" class="block text-sm font-medium text-gray-700 mb-2">
                                Tháng hóa đơn
                            </label>
                            <input type="month" id="thang_hoa_don" name="thang_hoa_don" 
                                   value="{% now 'Y-m' %}"
                                   class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 text-sm">
                        </div>
                    </div>
                </div>

                <!-- Room List -->
                <div class="flex-1 overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h4 class="text-sm font-medium text-gray-700 uppercase tracking-wide">Phòng có hợp đồng hoạt động</h4>
                        <p class="text-xs text-gray-500 mt-1">Chỉ hiển thị phòng có hợp đồng đang hoạt động</p>
                    </div>
                    <div id="room_list_container" class="flex-1 overflow-y-auto">
                        <div id="room_list" class="p-4">
                            {% if hoa_don or phong %}
                            <div class="room-card bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:border-blue-300 hover:shadow-md transition-all duration-200 cursor-pointer"
                                 data-ma-phong="{% if hoa_don and hoa_don.MA_PHONG %}{{ hoa_don.MA_PHONG.MA_PHONG }}{% else %}{{ phong.MA_PHONG|default:'' }}{% endif %}">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-900">{% if hoa_don and hoa_don.MA_PHONG %}{{ hoa_don.MA_PHONG.TEN_PHONG|default:"Phòng "|add:hoa_don.MA_PHONG.MA_PHONG }}{% else %}{{ phong.TEN_PHONG|default:"Phòng "|add:phong.MA_PHONG }}{% endif %}</h4>
                                            <p class="text-sm text-gray-500">Mã phòng: {% if hoa_don and hoa_don.MA_PHONG %}{{ hoa_don.MA_PHONG.MA_PHONG }}{% else %}{{ phong.MA_PHONG|default:'' }}{% endif %}</p>
                                        </div>
                                    </div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></span>
                                        Đã chọn
                                    </span>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center py-12 text-gray-500">
                                <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                                <p class="text-sm">Vui lòng chọn khu vực để xem danh sách phòng</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Content - 70% -->
            <div class="w-[70%] bg-gray-50 flex flex-col overflow-auto rounded-r-xl shadow-lg">
                <!-- Content Header -->
                <div class="bg-white border-b border-gray-200 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Form lập hóa đơn</h3>
                            <p class="text-sm text-gray-600" id="selected_room_info">
                                {% if hoa_don %}
                                    Đã chọn: {% if hoa_don.MA_PHONG %}{{ hoa_don.MA_PHONG.TEN_PHONG|default:"Phòng "|add:hoa_don.MA_PHONG.MA_PHONG }}{% else %}Không xác định{% endif %}
                                {% elif phong %}
                                    Đã chọn: {{ phong.TEN_PHONG|default:"Phòng "|add:phong.MA_PHONG }}
                                {% else %}
                                    Chưa chọn phòng
                                {% endif %}
                            </p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="invoice_status_badge" class="{% if not hoa_don and not phong %}hidden{% endif %} px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                                Sẵn sàng lập hóa đơn
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Form Content -->
                <div class="flex-1 overflow-y-auto">
                    <form method="post" id="hoaDonForm" class="h-full"
                          action="{% if hoa_don %}{% url 'hoadon:sua_hoa_don' ma_hoa_don=hoa_don.MA_HOA_DON %}{% else %}{% url 'hoadon:them_hoa_don_post'%}{% endif %}">
                        {% csrf_token %}
                        <input type="hidden" id="ma_phong" name="MA_PHONG" value="{% if hoa_don and hoa_don.MA_PHONG %}{{ hoa_don.MA_PHONG.MA_PHONG }}{% else %}{{ phong.MA_PHONG|default:'' }}{% endif %}">
                        <input type="hidden" name="MA_HOP_DONG" id="MA_HOP_DONG" value="{{ hop_dong_hieu_luc.MA_HOP_DONG|default:'' }}">

                        <div id="main_content" class="p-6">
                            <!-- Empty State -->
                            <div id="empty_state" class="{% if hoa_don or phong %}hidden{% endif %} flex flex-col items-center justify-center h-96 text-gray-500">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Chưa chọn phòng</h3>
                                <p class="text-sm text-gray-600 text-center max-w-md">
                                    Vui lòng chọn một phòng từ danh sách bên trái để bắt đầu lập hóa đơn
                                </p>
                            </div>

                            <!-- Invoice Form -->
                            <div id="invoice_form" class="{% if not hoa_don and not phong %}hidden{% endif %} space-y-6">
                                <!-- Thông tin cơ bản hóa đơn -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                        Thông tin hóa đơn
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="LOAI_HOA_DON" class="block text-sm font-medium text-gray-700 mb-2">
                                                Loại hóa đơn <span class="text-red-500">*</span>
                                            </label>
                                            <select name="LOAI_HOA_DON" id="LOAI_HOA_DON" required
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="Hóa đơn bắt đầu" {% if form_data.LOAI_HOA_DON == 'Hóa đơn bắt đầu' %}selected{% endif %}>Hóa đơn bắt đầu hợp đồng</option>
                                                <option value="Hóa đơn hàng tháng" {% if form_data.LOAI_HOA_DON == 'Hóa đơn hàng tháng' or not form_data.LOAI_HOA_DON %}selected{% endif %}>Hóa đơn hàng tháng</option>
                                                <option value="Hóa đơn kết thúc" {% if form_data.LOAI_HOA_DON == 'Hóa đơn kết thúc' %}selected{% endif %}>Hóa đơn kết thúc hợp đồng</option>
                                                <option value="Hóa đơn khác" {% if form_data.LOAI_HOA_DON == 'Hóa đơn khác' %}selected{% endif %}>Hóa đơn khác</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="NGAY_LAP_HDON" class="block text-sm font-medium text-gray-700 mb-2">
                                                Ngày lập hóa đơn <span class="text-red-500">*</span>
                                            </label>
                                            <input name="NGAY_LAP_HDON" id="NGAY_LAP_HDON" type="date" required
                                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                   value="{{ form_data.NGAY_LAP_HDON|default:'' }}">
                                        </div>
                                        <input type="hidden" name="TRANG_THAI_HDON" value="Chưa thanh toán">
                                    </div>
                                </div>

                                <!-- Chi tiết dịch vụ -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-semibold text-gray-800">
                                            <i class="fas fa-concierge-bell text-green-500 mr-2"></i>
                                            Chi tiết dịch vụ
                                            <span id="service_status_indicator" class="ml-3 hidden">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    Cần ghi chỉ số
                                                </span>
                                            </span>
                                        </h4>
                                        <div class="flex items-center space-x-2">
                                            <button type="button" id="go_to_record_btn" class="hidden px-3 py-1.5 bg-orange-600 text-white text-xs font-medium rounded-lg hover:bg-orange-700 transition duration-200">
                                                <i class="fas fa-pen mr-1"></i>
                                                Ghi chỉ số
                                            </button>
                                            <button type="button" id="reload_services_btn" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 transition duration-200">
                                                <i class="fas fa-sync-alt mr-1"></i>
                                                Tải lại
                                            </button>
                                        </div>
                                    </div>
                                    <div id="service_cards_container" class="space-y-2"></div>
                                </div>

                                <!-- Quản lý khấu trừ -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-semibold text-gray-800">
                                            <i class="fas fa-minus-circle text-red-500 mr-2"></i>
                                            Quản lý khấu trừ
                                        </h4>
                                        <button type="button" id="add_deduction_btn" class="px-3 py-1.5 bg-green-600 text-white text-xs font-medium rounded-lg hover:bg-green-700 transition duration-200">
                                            <i class="fas fa-plus mr-1"></i>
                                            Thêm
                                        </button>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gray-50 border-b border-gray-200">
                                                <tr>
                                                    <th class="px-3 py-3 text-left font-medium text-gray-700">Loại</th>
                                                    <th class="px-3 py-3 text-center font-medium text-gray-700">Số tiền</th>
                                                    <th class="px-3 py-3 text-center font-medium text-gray-700">Ngày</th>
                                                    <th class="px-3 py-3 text-left font-medium text-gray-700">Lý do</th>
                                                    <th class="px-3 py-3 text-center font-medium text-gray-700">Hành động</th>
                                                </tr>
                                            </thead>
                                            <tbody id="deduction_details" class="divide-y divide-gray-200">
                                                {% if khau_tru %}
                                                {% for item in khau_tru %}
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-3 py-3">
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if item.LOAI_KHAU_TRU == 'Cộng' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                            {{ item.LOAI_KHAU_TRU }}
                                                        </span>
                                                        <input type="hidden" name="khautru[{{ forloop.counter0 }}][LOAI_KHAU_TRU]" value="{{ item.LOAI_KHAU_TRU }}">
                                                        {% if item.MA_KHAU_TRU %}<input type="hidden" name="khautru[{{ forloop.counter0 }}][MA_KHAU_TRU]" value="{{ item.MA_KHAU_TRU }}">{% endif %}
                                                    </td>
                                                    <td class="px-3 py-3 text-center">
                                                        <span class="font-medium">{{ item.SO_TIEN_KT|floatformat:0 }}đ</span>
                                                        <input type="hidden" name="khautru[{{ forloop.counter0 }}][SO_TIEN_KT]" value="{{ item.SO_TIEN_KT }}">
                                                    </td>
                                                    <td class="px-3 py-3 text-center">
                                                        <span class="text-sm text-gray-600">{{ item.NGAYKHAUTRU|date:'d/m/Y' }}</span>
                                                        <input type="hidden" name="khautru[{{ forloop.counter0 }}][NGAYKHAUTRU]" value="{{ item.NGAYKHAUTRU|date:'Y-m-d' }}">
                                                    </td>
                                                    <td class="px-3 py-3">
                                                        <span class="text-sm">{{ item.LY_DO_KHAU_TRU }}</span>
                                                        <input type="hidden" name="khautru[{{ forloop.counter0 }}][LY_DO_KHAU_TRU]" value="{{ item.LY_DO_KHAU_TRU }}">
                                                    </td>
                                                    <td class="px-3 py-3 text-center">
                                                        <button type="button" onclick="editDeduction({{ forloop.counter0 }})" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 mr-1">
                                                            Sửa
                                                        </button>
                                                        <button type="button" onclick="deleteDeduction({{ forloop.counter0 }})" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                                            Xóa
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% else %}
                                                <tr>
                                                    <td colspan="5" class="px-3 py-8 text-center text-gray-500">
                                                        <p>Chưa có khấu trừ nào</p>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Tổng kết hóa đơn -->
                                <div class="bg-white border border-gray-200 rounded-lg p-6">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                                        <i class="fas fa-calculator text-purple-500 mr-2"></i>
                                        Tổng kết hóa đơn
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="TIEN_PHONG" class="block text-sm font-medium text-gray-700 mb-2">Tiền phòng</label>
                                            <div class="relative">
                                                <input name="TIEN_PHONG" id="TIEN_PHONG" type="number" step="0.01"
                                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       value="{{ hop_dong_hieu_luc.GIA_THUE|default:'0.00'|floatformat:2 }}">
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <span class="text-gray-500 text-sm">VNĐ</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="TIEN_DICH_VU" class="block text-sm font-medium text-gray-700 mb-2">Tiền dịch vụ</label>
                                            <div class="relative">
                                                <input name="TIEN_DICH_VU" id="TIEN_DICH_VU" type="number" step="0.01" readonly
                                                       class="w-full px-4 py-3 border border-gray-300 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed"
                                                       value="{{ form_data.TIEN_DICH_VU|default:'0.00'|floatformat:2 }}">
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <span class="text-gray-500 text-sm">VNĐ</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="TIEN_KHAU_TRU" class="block text-sm font-medium text-gray-700 mb-2">Tiền khấu trừ</label>
                                            <div class="relative">
                                                <input name="TIEN_KHAU_TRU" id="TIEN_KHAU_TRU" type="number" step="0.01" readonly
                                                       class="w-full px-4 py-3 border border-gray-300 bg-gray-50 rounded-lg text-gray-600 cursor-not-allowed"
                                                       value="{{ form_data.TIEN_KHAU_TRU|default:'0.00'|floatformat:2 }}">
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <span class="text-gray-500 text-sm">VNĐ</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-span-2">
                                            <label for="TONG_TIEN" class="block text-sm font-medium text-gray-700 mb-2">Tổng tiền</label>
                                            <div class="relative">
                                                <input name="TONG_TIEN" id="TONG_TIEN" type="number" step="0.01" readonly
                                                       class="w-full px-4 py-3 border-2 border-blue-300 bg-blue-50 rounded-lg text-blue-800 font-semibold text-lg cursor-not-allowed"
                                                       value="{{ form_data.TONG_TIEN|default:'0.00'|floatformat:2 }}">
                                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <span class="text-blue-600 font-medium">VNĐ</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sticky Footer -->
                        <div id="form_footer" class="{% if not hoa_don and not phong %}hidden{% endif %} bg-white border-t border-gray-200 px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <span id="total_amount_display">Tổng tiền: {{ form_data.TONG_TIEN|default:'0' |floatformat:0 }} VNĐ</span>
                                </div>
                                <div class="flex gap-4">
                                    <button type="button" onclick="history.back()" 
                                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
                                        Hủy
                                    </button>
                                    <button type="submit" id="btn_luu" 
                                            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-save mr-2"></i>
                                        {% if hoa_don %}Cập nhật hóa đơn{% else %}Lưu hóa đơn{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Deduction Modal -->
<div id="deduction_modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4" id="modal_title">Thêm khấu trừ</h3>
        
        <div class="space-y-4">
            <div>
                <label for="modal_LOAI_KHAU_TRU" class="block text-sm font-medium text-gray-700 mb-2">
                    Loại điều chỉnh <span class="text-red-500">*</span>
                </label>
                <select id="modal_LOAI_KHAU_TRU" required
                        class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    <option value="">Chọn loại</option>
                    <option value="Cộng">Cộng thêm</option>
                    <option value="Trừ">Khấu trừ</option>
                </select>
            </div>
            
            <div>
                <label for="modal_SO_TIEN_KT" class="block text-sm font-medium text-gray-700 mb-2">
                    Số tiền <span class="text-red-500">*</span>
                </label>
                <input id="modal_SO_TIEN_KT" type="number" step="1000" min="0" required
                       class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                       placeholder="Nhập số tiền">
            </div>
            
            <div>
                <label for="modal_NGAYKHAUTRU" class="block text-sm font-medium text-gray-700 mb-2">
                    Ngày <span class="text-red-500">*</span>
                </label>
                <input id="modal_NGAYKHAUTRU" type="date" required
                       class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
            </div>
            
            <div>
                <label for="modal_LY_DO_KHAU_TRU" class="block text-sm font-medium text-gray-700 mb-2">
                    Lý do <span class="text-red-500">*</span>
                </label>
                <textarea id="modal_LY_DO_KHAU_TRU" rows="3" required
                          class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                          placeholder="Nhập lý do khấu trừ"></textarea>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end space-x-3">
            <button type="button" id="cancel_deduction" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-200">
                Hủy
            </button>
            <button type="button" id="save_deduction" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200">
                Lưu
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentSelectedRoom = null;
    
    // Event handlers
    $('#khu_vuc').change(function() {
        const khuVucId = $(this).val();
        if (khuVucId) {
            loadPhongTro(khuVucId);
        } else {
            resetForm();
        }
    });

    function loadPhongTro(khuVucId) {
        $.ajax({
            url: '{% url "admin_hoadon:lay_phong_theo_khu_vuc_hoa_don" %}',
            data: { 'khu_vuc_id': khuVucId },
            success: function(data) {
                const roomList = $('#room_list');
                roomList.empty();
                
                if (data.phong_tros && data.phong_tros.length > 0) {
                    $.each(data.phong_tros, function(index, phong) {
                        const roomCard = createRoomCard(phong);
                        roomList.append(roomCard);
                    });
                } else {
                    roomList.append(`
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <p class="text-sm">Không có phòng nào đủ điều kiện</p>
                            <p class="text-xs text-gray-400 mt-1">Phòng cần có hợp đồng đang hoạt động</p>
                        </div>
                    `);
                }
            },
            error: function() {
                showNotification('Có lỗi khi tải danh sách phòng trọ', 'error');
            }
        });
    }

    function createRoomCard(phong) {
        return `
            <div class="room-card bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:border-green-300 hover:shadow-md transition-all duration-200 cursor-pointer"
                 data-ma-phong="${phong.MA_PHONG}" 
                 onclick="selectRoom(${phong.MA_PHONG}, '${phong.TEN_PHONG || 'Phòng ' + phong.MA_PHONG}')">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">${phong.TEN_PHONG || 'Phòng ' + phong.MA_PHONG}</h4>
                            <p class="text-sm text-gray-500">Mã phòng: ${phong.MA_PHONG}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></span>
                            Đang hoạt động
                        </span>
                    </div>
                </div>
            </div>
        `;
    }

    // Global function để chọn phòng
    window.selectRoom = function(maPhong, tenPhong) {
        // Remove previous selection
        $('.room-card').removeClass('border-green-500 bg-green-50');
        
        // Add selection to current room
        $(`.room-card[data-ma-phong="${maPhong}"]`).addClass('border-green-500 bg-green-50');
        
        // Update hidden inputs
        $('#MA_PHONG').val(maPhong);
        currentSelectedRoom = { maPhong, tenPhong };
        
        // Update UI
        $('#selected_room_info').text(`Đã chọn: ${tenPhong}`);
        $('#empty_state').addClass('hidden');
        $('#invoice_form').removeClass('hidden');
        $('#form_footer').removeClass('hidden');
        $('#invoice_status_badge').removeClass('hidden');
        
        // Load service data
        loadServiceData(maPhong);
    };

    function loadServiceData(maPhong) {
        const thangHoaDon = $('#NGAY_LAP_HDON').val();
        let url = `/admin/api/thong-tin-phong-hoa-don/${maPhong}/`;
        if (thangHoaDon) {
            url += `?thang_hoa_don=${thangHoaDon.substring(0, 7)}`;
        }
        
        $.ajax({
            url: url,
            success: function(data) {
                if (data.success) {
                    populateInvoiceForm(data);
                } else {
                    // Nếu lỗi do không có dịch vụ, hiển thị empty state với thông báo
                    if (data.error && data.error.includes('chưa có dịch vụ nào được áp dụng')) {
                        $('#empty_services').removeClass('hidden');
                        $('#empty_services h3').text('Chưa có dịch vụ nào');
                        $('#empty_services p').text(data.error);
                    }
                    showNotification(data.error || 'Có lỗi khi tải thông tin phòng', 'error');
                }
            },
            error: function() {
                showNotification('Có lỗi khi tải thông tin dịch vụ', 'error');
            }
        });
    }

    function populateInvoiceForm(data) {
        // Thông tin cơ bản - đảm bảo format đúng cho input number
        $('#TIEN_PHONG').val(parseFloat(data.hop_dong.GIA_THUE || 0).toString().replace(',', '.'));
        
        // Đảm bảo MA_HOP_DONG không bị undefined hoặc null
        if (data.hop_dong.MA_HOP_DONG) {
            $('#MA_HOP_DONG').val(data.hop_dong.MA_HOP_DONG);
        } else {
            showNotification('Không tìm thấy hợp đồng hiệu lực cho phòng này', 'error');
            return;
        }
        
        // Thông tin dịch vụ - force reload
        populateServiceTable(data.dich_vu_list, true);
        
        // Tính toán tổng tiền
        calculateTotals();
    }

    function populateServiceTable(dichVuList) {
        
        const container = $('#service_cards_container');
        // Không clear container nếu đang có dữ liệu và không force reload hoặc đang editing deduction
        if ((container.children().length > 0 && !arguments[1]) || isEditingDeduction) {
            console.log('Skipping service table repopulation - editing deduction or data exists');
            return;
        }
        container.empty();
        
        let hasIncompleteService = false;
        
        if (dichVuList && dichVuList.length > 0) {
            $('#empty_services').addClass('hidden');
            
            dichVuList.forEach((dv, index) => {
                const isFixedService = dv.LOAI_DICH_VU === 'Cố định' || dv.LOAI_DICH_VU === 'Co dinh';
                const needsReading = !isFixedService && (dv.CHI_SO_MOI === null || dv.CHI_SO_MOI === undefined || dv.CHI_SO_MOI === '');
                
                if (needsReading) {
                    hasIncompleteService = true;
                }
                
                let cardHtml = '';
                
                if (isFixedService) {
                    // Card cho dịch vụ cố định
                    cardHtml = `
                        <div class="service-card bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg p-3 shadow-sm hover:shadow-md transition-all duration-200"
                             data-service-type="fixed" data-service-id="${dv.MA_DICH_VU}">
                            <div class="flex items-center justify-between">
                                <!-- Left: Service info -->
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2">
                                            <h5 class="font-semibold text-gray-900 text-sm">${dv.TEN_DICH_VU}</h5>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                                Cố định
                                            </span>
                                        </div>
                                        <p class="text-xs text-gray-600">${parseFloat(dv.GIA_DICH_VU || 0).toLocaleString('vi-VN')}đ/${dv.DON_VI_TINH || 'đơn vị'}</p>
                                    </div>
                                </div>
                                
                                <!-- Center: Input -->
                                <div class="flex items-center space-x-3 px-4">
                                    <div class="text-xs text-gray-600">SL:</div>
                                    <input type="number" name="chi_so_dich_vu[${index}][SO_DICH_VU]" 
                                           value="${parseFloat(dv.SO_LUONG || 1).toString().replace(',', '.')}" min="1" step="1"
                                           class="w-16 px-2 py-1 text-center border border-green-300 rounded focus:ring-2 focus:ring-green-500 focus:border-green-500 text-sm"
                                           oninput="updateFixedServiceCalculation(${index}, ${dv.GIA_DICH_VU})"
                                           ${dv.SO_LUONG ? 'readonly' : ''}>
                                </div>
                                
                                <!-- Right: Total amount -->
                                <div class="text-right flex-shrink-0">
                                    <div class="text-sm font-bold text-green-600" id="thanh_tien_${index}">
                                        ${parseFloat(dv.THANH_TIEN || dv.GIA_DICH_VU || 0).toLocaleString('vi-VN')}đ
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden inputs -->
                            <input type="hidden" name="chi_so_dich_vu[${index}][MA_DICH_VU]" value="${dv.MA_DICH_VU}">
                            <input type="hidden" name="chi_so_dich_vu[${index}][CHI_SO_CU]" value="0">
                            <input type="hidden" name="chi_so_dich_vu[${index}][CHI_SO_MOI]" value="0">
                            <input type="hidden" name="chi_so_dich_vu[${index}][THANH_TIEN]" value="${dv.THANH_TIEN || dv.GIA_DICH_VU || 0}" id="hidden_thanh_tien_${index}">
                            ${dv.MA_CHI_SO ? `<input type="hidden" name="chi_so_dich_vu[${index}][MA_CHI_SO]" value="${dv.MA_CHI_SO}">` : ''}
                        </div>
                    `;
                } else {
                    // Card cho dịch vụ theo chỉ số
                    cardHtml = `
                        <div class="service-card bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-lg p-3 shadow-sm hover:shadow-md transition-all duration-200 ${needsReading ? 'border-yellow-400 bg-gradient-to-r from-yellow-50 to-amber-50' : ''}"
                             data-service-type="meter" data-service-id="${dv.MA_DICH_VU}">
                            <!-- Header row -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="flex items-center space-x-2">
                                            <h5 class="font-semibold text-gray-900 text-sm">${dv.TEN_DICH_VU}</h5>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                                                Theo chỉ số
                                            </span>
                                            ${needsReading ? `
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700">
                                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                                    </svg>
                                                    Cần nhập
                                                </span>
                                            ` : ''}
                                        </div>
                                        <p class="text-xs text-gray-600">${parseFloat(dv.GIA_DICH_VU || 0).toLocaleString('vi-VN')}đ/${dv.DON_VI_TINH || 'đơn vị'}</p>
                                    </div>
                                </div>
                                <div class="text-sm font-bold text-blue-600" id="thanh_tien_${index}">
                                    ${parseFloat(dv.THANH_TIEN || 0).toLocaleString('vi-VN')}đ
                                </div>
                            </div>
                            
                            <!-- Input row - Tất cả input trên 1 dòng -->
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs font-medium text-gray-700 whitespace-nowrap">Chỉ số cũ:</label>
                                    <input type="number" name="chi_so_dich_vu[${index}][CHI_SO_CU]" 
                                           value="${parseFloat(dv.CHI_SO_CU || 0).toString().replace(',', '.')}" readonly
                                           class="w-20 px-2 py-1 text-center border border-gray-300 bg-gray-50 rounded text-xs text-gray-600">
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs font-medium text-gray-700 whitespace-nowrap">Chỉ số mới:</label>
                                    <input type="number" name="chi_so_dich_vu[${index}][CHI_SO_MOI]" 
                                           value="${dv.CHI_SO_MOI ? parseFloat(dv.CHI_SO_MOI).toString().replace(',', '.') : ''}" 
                                           class="chi-so-moi w-20 px-2 py-1 text-center border text-xs rounded ${dv.CHI_SO_MOI ? 'border-gray-300 bg-gray-50 text-gray-600' : needsReading ? 'border-yellow-400 bg-yellow-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500' : 'border-blue-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500'}"
                                           oninput="updateMeterServiceCalculation(${index}, ${dv.GIA_DICH_VU})"
                                           placeholder="${needsReading ? 'Nhập' : ''}"
                                           ${dv.CHI_SO_MOI ? 'readonly' : ''}>
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <label class="text-xs font-medium text-gray-700 whitespace-nowrap">Tiêu thụ:</label>
                                    <input type="number" name="chi_so_dich_vu[${index}][SO_DICH_VU]" 
                                           value="${parseFloat(dv.SO_DICH_VU || 0).toString().replace(',', '.')}" readonly
                                           class="w-20 px-2 py-1 text-center border border-gray-300 bg-gray-50 rounded text-xs text-gray-600">
                                </div>
                            </div>
                            
                            <!-- Hidden inputs -->
                            <input type="hidden" name="chi_so_dich_vu[${index}][MA_DICH_VU]" value="${dv.MA_DICH_VU}">
                            <input type="hidden" name="chi_so_dich_vu[${index}][THANH_TIEN]" value="${dv.THANH_TIEN || 0}" id="hidden_thanh_tien_${index}">
                            ${dv.MA_CHI_SO ? `<input type="hidden" name="chi_so_dich_vu[${index}][MA_CHI_SO]" value="${dv.MA_CHI_SO}">` : ''}
                        </div>
                    `;
                }
                
                container.append(cardHtml);
            });
            
            // Hiển thị/ẩn các indicator và nút
            if (hasIncompleteService) {
                $('#service_status_indicator').removeClass('hidden');
                $('#go_to_record_btn').removeClass('hidden');
            } else {
                $('#service_status_indicator').addClass('hidden');
                $('#go_to_record_btn').addClass('hidden');
            }
        } else {
            // Hiển thị empty state đã có sẵn với thông báo phù hợp
            $('#empty_services').removeClass('hidden');
            $('#empty_services h3').text('Chưa có dịch vụ nào');
            $('#empty_services p').text('Khu vực này chưa có dịch vụ nào được áp dụng. Vui lòng thiết lập dịch vụ cho khu vực trước khi lập hóa đơn.');
            $('#service_status_indicator').addClass('hidden');
            $('#go_to_record_btn').addClass('hidden');
        }
    }

    // Tính toán cho dịch vụ theo chỉ số
    window.updateMeterServiceCalculation = function(index, GIA_DICH_VU) {
        const card = document.querySelector(`[data-service-type="meter"]:nth-of-type(${index + 1})`);
        if (!card) return;
        
        const chiSoCu = parseFloat(card.querySelector('input[name*="[CHI_SO_CU]"]').value) || 0;
        const chiSoMoiInput = card.querySelector('input[name*="[CHI_SO_MOI]"]');
        const chiSoMoi = parseFloat(chiSoMoiInput.value) || 0;
        const soDichVuInput = card.querySelector('input[name*="[SO_DICH_VU]"]');
        const thanhTienDisplay = card.querySelector(`#thanh_tien_${index}`);
        const hiddenThanhTien = card.querySelector(`#hidden_thanh_tien_${index}`);
        
        // Lấy giá dịch vụ từ text content
        const giaText = card.querySelector('p.text-xs.text-gray-600').textContent;
        const giaDichVu = GIA_DICH_VU;
        
        // Tính toán tiêu thụ và thành tiền
        const soDichVu = Math.max(0, chiSoMoi - chiSoCu);
        const thanhTien = soDichVu * giaDichVu;
        
        // Cập nhật UI
        soDichVuInput.value = soDichVu;
        thanhTienDisplay.textContent = thanhTien.toLocaleString('vi-VN') + 'đ';
        hiddenThanhTien.value = thanhTien;
        
       
        
        calculateTotals();
    };
    
    // Tính toán cho dịch vụ cố định
    window.updateFixedServiceCalculation = function(index, GIA_DICH_VU) {
        const card = document.querySelector(`[data-service-type="fixed"]:nth-of-type(${index + 1})`);
        if (!card) return;
        
        const soLuongInput = card.querySelector('input[name*="[SO_DICH_VU]"]');
        const soLuong = parseFloat(soLuongInput.value) || 1;
        const thanhTienDisplay = card.querySelector(`#thanh_tien_${index}`);
        const hiddenThanhTien = card.querySelector(`#hidden_thanh_tien_${index}`);
        
        // Lấy giá dịch vụ từ text content
        const giaText = card.querySelector('p.text-xs.text-gray-600').textContent;
        const giaDichVu = GIA_DICH_VU;
        
        // Tính toán thành tiền
        const thanhTien = soLuong * giaDichVu;
        
        // Cập nhật UI
        thanhTienDisplay.textContent = thanhTien.toLocaleString('vi-VN') + 'đ';
        hiddenThanhTien.value = thanhTien;
        
        // Đảm bảo số lượng không nhỏ hơn 1
        if (soLuong < 1) {
            soLuongInput.value = 1;
            const newThanhTien = 1 * giaDichVu;
            thanhTienDisplay.textContent = newThanhTien.toLocaleString('vi-VN') + 'đ';
            hiddenThanhTien.value = newThanhTien;
        }
        
        calculateTotals();
    };

    // Calculate totals when inputs change
    $(document).on('input', '#TIEN_PHONG', function() {
        calculateTotals();
    });

    function calculateTotals() {
        let tienPhong = parseFloat($('#TIEN_PHONG').val()) || 0;
        
        // Tính tiền dịch vụ từ hidden inputs
        let tienDichVu = 0;
        $('input[id^="hidden_thanh_tien_"]').each(function() {
            tienDichVu += parseFloat($(this).val()) || 0;
        });
        
        // Tính khấu trừ (nếu có)
        let tienKhauTru = parseFloat($('#TIEN_KHAU_TRU').val()) || 0;
        
        let tongTien = tienPhong + tienDichVu + tienKhauTru;
        
        $('#TIEN_DICH_VU').val(tienDichVu.toFixed(2).replace(',', '.'));
        $('#TONG_TIEN').val(tongTien.toFixed(2).replace(',', '.'));
        
        // Cập nhật display trong footer
        $('#total_amount_display').text(`Tổng tiền: ${tongTien.toLocaleString('vi-VN')} VNĐ`);
    }

    function resetForm() {
        $('#room_list').html(`
            <div class="text-center py-12 text-gray-500">
                <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <p class="text-sm">Vui lòng chọn khu vực để xem danh sách phòng</p>
            </div>
        `);
        $('#empty_state').removeClass('hidden');
        $('#invoice_form').addClass('hidden');
        $('#form_footer').addClass('hidden');
        $('#invoice_status_badge').addClass('hidden');
        $('#selected_room_info').text('Chưa chọn phòng');
        
        currentSelectedRoom = null;
    }

    function showNotification(message, type = 'success') {
        const alertClass = type === 'error' ? 'bg-red-50 border-red-400 text-red-800' : 'bg-green-50 border-green-400 text-green-800';
        const iconClass = type === 'error' ? 'text-red-400' : 'text-green-400';
        const iconPath = type === 'error' ? 
            'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z' :
            'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z';
        
        const notification = $(`
            <div class="p-4 mb-3 rounded-lg border-l-4 ${alertClass}">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 ${iconClass}" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="${iconPath}" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                </div>
            </div>
        `);
        
        $('.border-l-4').remove();
        $('.max-w-6xl').first().prepend(`<div class="px-6 py-4">${notification.prop('outerHTML')}</div>`);
        
        setTimeout(() => {
            $('.border-l-4').parent().fadeOut();
        }, 5000);
    }

    // Handle go to record button
    $('#go_to_record_btn').click(function() {
        if (currentSelectedRoom && currentSelectedRoom.maPhong) {
            const thangHoaDon = $('#NGAY_LAP_HDON').val();
            let url = `/admin/dichvu/ghi-so/${currentSelectedRoom.maPhong}/`;
            if (thangHoaDon) {
                url += `?thang=${thangHoaDon.substring(0, 7)}`;
            }
            
            // Store current form data in sessionStorage for returning
            const formData = {
                maPhong: currentSelectedRoom.maPhong,
                tenPhong: currentSelectedRoom.tenPhong,
                thangHoaDon: thangHoaDon,
                returnUrl: window.location.href
            };
            sessionStorage.setItem('invoice_form_data', JSON.stringify(formData));
            
            showNotification('Chuyển đến trang ghi chỉ số dịch vụ...', 'success');
            setTimeout(() => {
                window.location.href = url;
            }, 1000);
        }
    });

    // Validation form trước khi submit
    $('#hoaDonForm').submit(function(e) {
        if (!currentSelectedRoom) {
            e.preventDefault();
            showNotification('Vui lòng chọn phòng trước khi lưu.', 'error');
            return;
        }
        
        // Kiểm tra MA_HOP_DONG
        const maHopDong = $('#MA_HOP_DONG').val();
        if (!maHopDong || maHopDong.trim() === '') {
            e.preventDefault();
            showNotification('Không tìm thấy hợp đồng hiệu lực cho phòng này. Vui lòng kiểm tra lại.', 'error');
            return;
        }
        
        // Kiểm tra xem có dịch vụ nào cần ghi chỉ số không
        let hasIncompleteService = false;
        $('.chi-so-moi').each(function() {
            const $input = $(this);
            const card = $input.closest('.service-card');
            const isFixedService = card.attr('data-service-type') === 'fixed';
            
            if (!isFixedService && (!$input.val() || $input.val() === '')) {
                hasIncompleteService = true;
                return false;
            }
        });
        
        if (hasIncompleteService) {
            e.preventDefault();
            showNotification('Vui lòng ghi đầy đủ chỉ số dịch vụ trước khi lập hóa đơn. Click nút "Ghi chỉ số" để chuyển đến trang ghi chỉ số.', 'error');
            // Highlight the incomplete services
            $('.chi-so-moi').each(function() {
                const $input = $(this);
                const card = $input.closest('.service-card');
                if (!$input.val() || $input.val() === '') {
                    $input.addClass('border-red-400 bg-red-50');
                    card.addClass('border-red-400');
                    $input.focus();
                }
            });
            return;
        }

        // Show loading state
        $('#btn_luu').prop('disabled', true).html(`
            <svg class="animate-spin w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Đang lưu...
        `);
    });
    
    // ==========================================================================
    // DEDUCTION MANAGEMENT FUNCTIONS
    // ==========================================================================
    let deductionData = []; // Lưu trữ dữ liệu khấu trừ tạm thời
    let editingDeductionIndex = -1;
    let isEditingDeduction = false;
    
    // Khởi tạo dữ liệu khấu trừ có sẵn
    function initializeDeductions() {
        // Load existing deductions from template
        $('#deduction_details tr').each(function(index) {
            if ($(this).find('td').length > 1) { // Skip empty rows
                const loai = $(this).find('input[name*="[LOAI_KHAU_TRU]"]').val();
                const soTien = $(this).find('input[name*="[SO_TIEN_KT]"]').val();
                const ngay = $(this).find('input[name*="[NGAYKHAUTRU]"]').val();
                const lyDo = $(this).find('input[name*="[LY_DO_KHAU_TRU]"]').val();
                const maKhauTru = $(this).find('input[name*="[MA_KHAU_TRU]"]').val();
                
                if (loai && soTien && ngay && lyDo) {
                    deductionData.push({
                        loai: loai,
                        soTien: parseFloat(soTien),
                        ngay: ngay,
                        lyDo: lyDo,
                        maKhauTru: maKhauTru || null
                    });
                }
            }
        });
    }
    
    // Call initialize on page load
    initializeDeductions();
    
    // Modal handlers
    $('#add_deduction_btn').click(function() {
        editingDeductionIndex = -1;
        showDeductionModal();
    });
    
    $('#cancel_deduction').click(function() {
        hideDeductionModal();
    });
    
    $('#save_deduction').click(function() {
        saveDeduction();
    });
    
    function showDeductionModal(data = null) {
        isEditingDeduction = true;
        if (data) {
            // Edit mode
            $('#modal_title').text('Sửa khấu trừ');
            $('#modal_LOAI_KHAU_TRU').val(data.loai);
            $('#modal_SO_TIEN_KT').val(parseFloat(data.soTien).toString().replace(',', '.'));
            $('#modal_NGAYKHAUTRU').val(data.ngay);
            $('#modal_LY_DO_KHAU_TRU').val(data.lyDo);
        } else {
            // Add mode
            $('#modal_title').text('Thêm khấu trừ');
            $('#modal_LOAI_KHAU_TRU').val('');
            $('#modal_SO_TIEN_KT').val('');
            $('#modal_NGAYKHAUTRU').val(new Date().toISOString().split('T')[0]);
            $('#modal_LY_DO_KHAU_TRU').val('');
        }
        $('#deduction_modal').removeClass('hidden');
    }
    
    function hideDeductionModal() {
        $('#deduction_modal').addClass('hidden');
        editingDeductionIndex = -1;
        isEditingDeduction = false;
    }
    
    function saveDeduction() {
        const loai = $('#modal_LOAI_KHAU_TRU').val();
        const soTien = parseFloat($('#modal_SO_TIEN_KT').val());
        const ngay = $('#modal_NGAYKHAUTRU').val();
        const lyDo = $('#modal_LY_DO_KHAU_TRU').val();
        
        // Validation
        if (!loai || isNaN(soTien) || !ngay || !lyDo) {
            showNotification('Vui lòng điền đầy đủ thông tin', 'error');
            return;
        }
        
        if (soTien <= 0) {
            showNotification('Số tiền phải lớn hơn 0', 'error');
            return;
        }
        
        const deductionItem = {
            loai: loai,
            soTien: soTien,
            ngay: ngay,
            lyDo: lyDo,
            maKhauTru: null // New items don't have ID yet
        };
        
        if (editingDeductionIndex >= 0) {
            // Update existing
            if (editingDeductionIndex < deductionData.length && deductionData[editingDeductionIndex].maKhauTru) {
                deductionItem.maKhauTru = deductionData[editingDeductionIndex].maKhauTru;
            }
            deductionData[editingDeductionIndex] = deductionItem;
        } else {
            // Add new
            deductionData.push(deductionItem);
        }
        
        updateDeductionTable(); 
        calculateTotals();
        hideDeductionModal();
        {% comment %} showNotification(editingDeductionIndex >= 0 ? 'Cập nhật khấu trừ thành công' : 'Thêm khấu trừ thành công'); {% endcomment %}
    }
    
    function updateDeductionTable() {
        const tbody = $('#deduction_details');
        tbody.empty();
        
        if (deductionData.length === 0) {
            tbody.append(`
                <tr>
                    <td colspan="5" class="px-3 py-8 text-center text-gray-500">
                        <p>Chưa có khấu trừ nào</p>
                    </td>
                </tr>
            `);
            $('#TIEN_KHAU_TRU').val(0);
            return;
        }
        
        let totalDeduction = 0;
        deductionData.forEach((item, index) => {
            const adjustedAmount = item.loai === 'Cộng' ? item.soTien : -item.soTien;
            totalDeduction += adjustedAmount;
            
            const rowHtml = `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${item.loai === 'Cộng' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${item.loai}
                        </span>
                        <input type="hidden" name="khautru[${index}][LOAI_KHAU_TRU]" value="${item.loai}">
                        ${item.maKhauTru ? `<input type="hidden" name="khautru[${index}][MA_KHAU_TRU]" value="${item.maKhauTru}">` : ''}
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="font-medium">${item.soTien.toLocaleString('vi-VN')}đ</span>
                        <input type="hidden" name="khautru[${index}][SO_TIEN_KT]" value="${item.soTien}">
                    </td>
                    <td class="px-3 py-3 text-center">
                        <span class="text-sm text-gray-600">${formatDate(item.ngay)}</span>
                        <input type="hidden" name="khautru[${index}][NGAYKHAUTRU]" value="${item.ngay}">
                    </td>
                    <td class="px-3 py-3">
                        <span class="text-sm">${item.lyDo}</span>
                        <input type="hidden" name="khautru[${index}][LY_DO_KHAU_TRU]" value="${item.lyDo}">
                    </td>
                    <td class="px-3 py-3 text-center">
                        <button type="button" onclick="editDeduction(${index})" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 mr-1">
                            Sửa
                        </button>
                        <button type="button" onclick="deleteDeduction(${index})" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                            Xóa
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(rowHtml);
        });
        
        $('#TIEN_KHAU_TRU').val(totalDeduction.toFixed(2).replace(',', '.'));
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN');
    }
    
    // Global functions for edit/delete buttons
    window.editDeduction = function(index) {
        if (index < 0 || index >= deductionData.length) {
            showNotification('Khấu trừ không tồn tại', 'error');
            return;
        }
        editingDeductionIndex = index;
        showDeductionModal(deductionData[index]);
    };
    
    window.deleteDeduction = function(index) {
        if (index < 0 || index >= deductionData.length) {
            showNotification('Khấu trừ không tồn tại', 'error');
            return;
        }
        
        if (confirm('Bạn có chắc chắn muốn xóa khấu trừ này?')) {
            deductionData.splice(index, 1);
            updateDeductionTable();
            calculateTotals();
            showNotification('Xóa khấu trừ thành công');
        }
    };
});
</script>
{% endblock %}