{% extends 'admin/admin_layout.html' %}
{% load static %}
{% load custom_filters %}

{% block content_body %}
<div class="mx-auto w-full md:w-[85%] py-6">
    <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-8">
        <!-- Header Dashboard -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Dashboard Quản Lý Chuỗi Nhà Trọ</h1>
                <p class="text-gray-600 mt-1">Tổng quan hoạt động kinh doanh toàn hệ thống</p>
            </div>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div class="text-right">
                    <div class="text-sm text-gray-500">Cập nhật lúc</div>
                    <div class="text-lg font-semibold text-gray-900">{{ "now"|date:"H:i d/m/Y" }}</div>
                </div>
                <button onclick="refreshDashboard()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-sync-alt mr-2"></i>Làm mới
                </button>
            </div>
        </div>

       

        <!-- Thống kê tổng quan -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Tổng số phòng -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Tổng số phòng</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-2">{{ stats.tong_so_phong }}</p>
                        <div class="flex items-center mt-2">
                            <span class="text-sm text-green-600">
                                <i class="fas fa-arrow-up mr-1"></i>{{ stats.tang_phong_thang_nay }} phòng tháng này
                            </span>
                        </div>
                    </div>
                    <div class="p-3 rounded-full bg-blue-100">
                        <i class="fas fa-building text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Tỷ lệ công suất -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Công suất thuê</h3>
                        <p class="text-3xl font-bold text-green-600 mt-2">{{ stats.ty_le_cong_suat }}%</p>
                        <div class="flex items-center mt-2">
                            <span class="text-sm text-gray-600">{{ stats.phong_dang_o }}/{{ stats.tong_so_phong }} phòng</span>
                        </div>
                    </div>
                    <div class="p-3 rounded-full bg-green-100">
                        <i class="fas fa-chart-pie text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Doanh thu tháng -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Doanh thu tháng</h3>
                        <p class="text-3xl font-bold text-yellow-600 mt-2">{{ stats.doanh_thu_thang|currency_vn_short }}</p>
                        <div class="flex items-center mt-2">
                            <span class="text-sm {% if stats.tang_giam_doanh_thu >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                <i class="fas {% if stats.tang_giam_doanh_thu >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %} mr-1"></i>
                                {{ stats.tang_giam_doanh_thu }}% so với tháng trước
                            </span>
                        </div>
                    </div>
                    <div class="p-3 rounded-full bg-yellow-100">
                        <i class="fas fa-coins text-yellow-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Công nợ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Công nợ</h3>
                        <p class="text-3xl font-bold text-red-600 mt-2">{{ stats.tong_cong_no|currency_vn_short }}</p>
                        <div class="flex items-center mt-2">
                            <span class="text-sm text-red-600">{{ stats.so_khach_no }} khách đang nợ</span>
                        </div>
                    </div>
                    <div class="p-3 rounded-full bg-red-100">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>
         <!-- Quick Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                <i class="fas fa-users text-blue-500 text-lg mb-2"></i>
                <div class="text-lg font-bold text-gray-900">{{ stats.tong_khach_thue }}</div>
                <div class="text-xs text-gray-500">Khách thuê</div>
            </div>
            
            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                <i class="fas fa-file-contract text-green-500 text-lg mb-2"></i>
                <div class="text-lg font-bold text-gray-900">{{ stats.tong_hop_dong_hoat_dong }}</div>
                <div class="text-xs text-gray-500">Hợp đồng</div>
            </div>
            
            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                <i class="fas fa-file-invoice text-yellow-500 text-lg mb-2"></i>
                <div class="text-lg font-bold text-gray-900">{{ stats.tong_hoa_don_thang }}</div>
                <div class="text-xs text-gray-500">Hóa đơn tháng</div>
            </div>
            
            <div class="bg-white p-4 rounded-lg border border-gray-200 text-center">
                <i class="fas fa-handshake text-purple-500 text-lg mb-2"></i>
                <div class="text-lg font-bold text-gray-900">{{ stats.tong_phieu_thu_thang }}</div>
                <div class="text-xs text-gray-500">Phiếu thu</div>
            </div>                
        </div>

        <!-- Thống kê chi tiết theo khu vực -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 max-h-[500px] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">Thống Kê Chi Tiết Theo Khu Vực</h2>
                    <div class="flex space-x-2">
                        <button class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full">Tháng này</button>                     
                    </div>
                </div>
            </div>
            
            <div class="relative">
                <table class="w-full table-fixed">
                    <thead class="bg-blue-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/6">
                                <i class="fas fa-map-marker-alt mr-2"></i>Khu vực
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/8">
                                <i class="fas fa-door-open mr-1"></i>Tổng phòng
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/8">
                                <i class="fas fa-home mr-1"></i>Đang ở
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/8">
                                <i class="fas fa-door-closed mr-1"></i>Trống
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/8">
                                <i class="fas fa-chart-line mr-1"></i>Công suất
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/8">
                                <i class="fas fa-money-bill-wave mr-1"></i>Doanh thu
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/8">
                                <i class="fas fa-exclamation-circle mr-1"></i>Công nợ
                            </th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-blue-800 uppercase tracking-wider w-1/8">
                                <i class="fas fa-cog mr-1"></i>Thao tác
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for kv_stat in stats.khu_vuc_stats %}
                        <tr class="hover:bg-blue-25 transition-colors group">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full mr-3"></div>
                                    <div>
                                        <div class="text-sm font-semibold text-gray-900">{{ kv_stat.ten_khu_vuc }}</div>
                                        <div class="text-xs text-gray-500">{{ kv_stat.dia_chi }}</div>
                                        <div class="text-xs text-gray-400">{{ kv_stat.so_quan_ly }} quản lý</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-lg font-bold text-gray-900">{{ kv_stat.tong_phong }}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex flex-col items-center">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
                                        {{ kv_stat.phong_dang_o }}
                                    </span>
                                    {% if kv_stat.hop_dong_sap_het_han > 0 %}
                                    <span class="text-xs text-orange-600 mt-1">{{ kv_stat.hop_dong_sap_het_han }} sắp hết hạn</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                                    {{ kv_stat.phong_trong }}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-chart-line mr-1 {% if kv_stat.ty_le_thue >= 80 %}text-green-600{% elif kv_stat.ty_le_thue >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}"></i>
                                    <span class="text-sm font-bold {% if kv_stat.ty_le_thue >= 80 %}text-green-600{% elif kv_stat.ty_le_thue >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                        {{ kv_stat.ty_le_thue }}%
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex flex-col items-center">
                                    <span class="text-lg font-bold text-blue-600">{{ kv_stat.doanh_thu_thang|currency_vn_short }}</span>
                                    <span class="text-xs {% if kv_stat.tang_giam_doanh_thu >= 0 %}text-green-600{% else %}text-red-600{% endif %} mt-1">
                                        {% if kv_stat.tang_giam_doanh_thu >= 0 %}+{% endif %}{{ kv_stat.tang_giam_doanh_thu }}%
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if kv_stat.cong_no > 0 %}
                                    <div class="flex flex-col items-center">
                                        <span class="text-sm font-bold text-red-600">{{ kv_stat.cong_no|currency_vn_short }}</span>
                                        <span class="text-xs text-red-500">{{ kv_stat.so_khach_no }} khách</span>
                                    </div>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                        <i class="fas fa-check mr-1"></i>Đã thu hết
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <a href="{% url 'phongtro:phongtro_list' %}?ma_khu_vuc={{ kv_stat.ma_khu_vuc }}" 
                                    class="text-blue-600 hover:text-blue-800 transition" title="Xem phòng">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'hopdong:hopdong_list' %}?ma_khu_vuc={{ kv_stat.ma_khu_vuc }}" 
                                    class="text-green-600 hover:text-green-800 transition" title="Xem hợp đồng">
                                        <i class="fas fa-file-contract"></i>
                                    </a>
                                    <a href="{% url 'hoadon:hoadon_list' %}?ma_khu_vuc={{ kv_stat.ma_khu_vuc }}" 
                                    class="text-yellow-600 hover:text-yellow-800 transition" title="Xem hóa đơn">
                                        <i class="fas fa-file-invoice"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-gradient-to-r from-blue-50 to-indigo-50 font-semibold border-t-2 border-blue-200 sticky bottom-0 z-10">
                        <tr>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full mr-3"></div>
                                    <div class="text-base font-bold text-blue-900">TỔNG TOÀN HỆ THỐNG</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-xl font-bold text-blue-900">{{ stats.tong_tat_ca_phong }}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-xl font-bold text-green-700">{{ stats.tong_phong_dang_o }}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-xl font-bold text-red-700">{{ stats.tong_phong_trong }}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-chart-line mr-1 {% if stats.ty_le_cong_suat >= 80 %}text-green-600{% elif stats.ty_le_cong_suat >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}"></i>
                                    <span class="text-lg font-bold {% if stats.ty_le_cong_suat >= 80 %}text-green-600{% elif stats.ty_le_cong_suat >= 60 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ stats.ty_le_cong_suat }}%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-xl font-bold text-blue-900">{{ stats.tong_doanh_thu_thang|currency_vn_short }}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="text-xl font-bold text-red-700">{{ stats.tong_cong_no_he_thong|currency_vn_short }}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <i class="fas fa-chart-bar text-blue-600 text-lg"></i>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Biểu đồ và thống kê bổ sung -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Biểu đồ doanh thu 6 tháng -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">Doanh Thu 6 Tháng Gần Đây</h3>
                </div>
                <div class="p-6">
                    <div class="flex items-end justify-between h-64 space-x-2">
                        {% for thang in stats.doanh_thu_6_thang %}
                        <div class="flex-1 flex flex-col items-center">
                            <div class="w-full bg-gray-200 rounded-t-lg relative overflow-hidden" style="height: 200px;">
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-blue-500 to-blue-400 rounded-t-lg transition-all duration-1000"
                                    style="height: {{ thang.ty_le }}%"></div>
                            </div>
                            <div class="mt-3 text-center">
                                <div class="text-xs text-gray-600 font-medium">T{{ thang.thang }}/{{ thang.nam }}</div>
                                <div class="text-xs font-bold text-gray-900">{{ thang.doanh_thu|currency_vn_short }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Top KPIs -->
            <div class="space-y-6">
                <!-- Hợp đồng sắp hết hạn -->
                <div class="bg-white rounded-xl shadow-sm border border-orange-200">
                    <div class="p-4 border-b border-orange-200 bg-orange-50">
                        <h3 class="text-sm font-semibold text-orange-900 flex items-center">
                            <i class="fas fa-clock text-orange-600 mr-2"></i>
                            Hợp đồng sắp hết hạn
                        </h3>
                    </div>
                    <div class="p-4">
                        {% if stats.hop_dong_sap_het_han %}
                            <div class="space-y-3 max-h-48 overflow-y-auto">
                                {% for hd in stats.hop_dong_sap_het_han %}
                                <div class="flex justify-between items-center p-2 bg-orange-50 rounded-lg">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ hd.phong_ten }}</div>
                                        <div class="text-xs text-gray-600">{{ hd.khach_thue_ten }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs font-semibold text-orange-600">{{ hd.con_lai_ngay }} ngày</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-gray-500 text-center py-4 text-sm">Không có hợp đồng nào sắp hết hạn</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Top khách nợ nhiều nhất -->
                <div class="bg-white rounded-xl shadow-sm border border-red-200">
                    <div class="p-4 border-b border-red-200 bg-red-50">
                        <h3 class="text-sm font-semibold text-red-900 flex items-center">
                            <i class="fas fa-user-times text-red-600 mr-2"></i>
                            Khách nợ nhiều nhất
                        </h3>
                    </div>
                    <div class="p-4">
                        {% if stats.top_khach_no %}
                            <div class="space-y-3">
                                {% for khach in stats.top_khach_no %}
                                <div class="flex justify-between items-center p-2 bg-red-50 rounded-lg">
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ khach.ho_ten }}</div>
                                        <div class="text-xs text-gray-600">{{ khach.phong_ten }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-red-600">{{ khach.so_tien_no|currency_vn_short }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-gray-500 text-center py-4 text-sm">Tất cả khách đã thanh toán đủ</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard interactions
document.addEventListener('DOMContentLoaded', function() {
    // Animate progress bars
    setTimeout(() => {
        const progressBars = document.querySelectorAll('[style*="width:"]');
        progressBars.forEach(bar => {
            if (bar.classList.contains('h-2') || bar.classList.contains('h-3')) {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = width;
                }, 200);
            }
        });
    }, 500);
    
    // Animate chart bars
    setTimeout(() => {
        const chartBars = document.querySelectorAll('[style*="height:"]');
        chartBars.forEach(bar => {
            if (bar.parentElement.style.height === '200px') {
                const height = bar.style.height;
                bar.style.height = '0%';
                setTimeout(() => {
                    bar.style.height = height;
                }, Math.random() * 500 + 200);
            }
        });
    }, 1000);
});

function refreshDashboard() {
    location.reload();
}

// Tooltip cho các icon
tippy('[title]', {
    theme: 'light-border',
    animation: 'fade',
});
</script>
{% endblock %}