{% load static %}
{% extends 'admin/admin_layout.html' %}
{% block content_body %}
<div class="container">
    <div class="profile-grid">
        <!-- H·ªì s∆° qu·∫£n l√Ω -->
        <div class="profile-card">
            <h2 class="card-title">H·ªì s∆° qu·∫£n l√Ω</h2>
            {% if request.user.nguoi_quan_ly.ANH_QL %}
                <img src="data:image/jpeg;base64,{{ request.user.nguoi_quan_ly.ANH_QL }}" alt="·∫¢nh qu·∫£n l√Ω" class="profile-image">
            {% else %}
                <img src="{% static 'images/default_profile.png' %}" alt="·∫¢nh m·∫∑c ƒë·ªãnh" class="profile-image">
            {% endif %}
            <h3 class="profile-name">{{ request.user.nguoi_quan_ly.TEN_QUAN_LY }}</h3>
            <p class="profile-role">Qu·∫£n l√Ω h·ªá th·ªëng nh√† tr·ªç</p>

            <div class="profile-details">
                <div class="detail-item">
                    <span class="detail-label">Ng√†y sinh:</span>
                    <span>{{ request.user.nguoi_quan_ly.NGAY_SINH_QL|date:'d/m/Y'|default:'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Email:</span>
                    <span>{{ request.user.email|default:'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                    <span>{{ request.user.nguoi_quan_ly.SDT_QUAN_LY|default:'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">ƒê·ªãa ch·ªâ:</span>
                    <span>{{ request.user.nguoi_quan_ly.DIA_CHI_QL|default:'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Gi·ªõi t√≠nh:</span>
                    <span>{{ request.user.nguoi_quan_ly.GIOI_TINH_QL|default:'N/A' }}</span>
                </div>
            </div>

            <div class="account-info">
                <h3 class="section-title">Th√¥ng tin t√†i kho·∫£n</h3>
                <div class="detail-item">
                    <span class="detail-label">T√™n t√†i kho·∫£n:</span>
                    <span class="detail-value">{{ request.user.username }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Tr·∫°ng th√°i t√†i kho·∫£n:</span>
                    <span class="detail-value">{{ request.user.is_active|yesno:'Ho·∫°t ƒë·ªông,Kh√¥ng ho·∫°t ƒë·ªông' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Quy·ªÅn h·∫°n:</span>
                    <span class="detail-value">{{ request.user.get_user_permissions|join:', '|default:'Qu·∫£n l√Ω' }}</span>
                </div>
                <button class="change-password-btn" data-modal-toggle="changePasswordModal">ƒê·ªïi m·∫≠t kh·∫©u</button>
            </div>
        </div>

        <!-- Th√¥ng tin nh√† tr·ªç -->
        <div class="info-card">
            <div class="info-section">
                <h2 class="section-title">üè† Th√¥ng tin nh√† tr·ªç</h2>
                {% if request.user.nguoi_quan_ly.ds_nhatro.exists %}
                    {% with nt=request.user.nguoi_quan_ly.ds_nhatro.first %}
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">T√™n nh√† tr·ªç:</span>
                            <span>{{ nt.TEN_NHA_TRO|default:'N/A' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">V√πng mi·ªÅn:</span>
                            <span>{{ nt.VUNG_MIEN|default:'N/A' }}</span>
                        </div>
                    </div>
                    {% endwith %}
                {% else %}
                    <p class="no-data">Ch∆∞a c√≥ th√¥ng tin nh√† tr·ªç.</p>
                {% endif %}
            </div>

            <div class="info-section">
                <h2 class="section-title">üìç Khu v·ª±c qu·∫£n l√Ω</h2>
                {% if request.user.nguoi_quan_ly.ds_nhatro.exists and request.user.nguoi_quan_ly.ds_nhatro.first.ds_khuvuc.exists %}
                    <div class="area-list">
                        {% for kv in request.user.nguoi_quan_ly.ds_nhatro.first.ds_khuvuc.all %}
                        <div class="area-item">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Khu v·ª±c:</span>
                                    <span>{{ kv.TEN_KHU_VUC|default:'N/A' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ƒê∆°n v·ªã h√†nh ch√≠nh c·∫•p 1:</span>
                                    <span>{{ kv.DV_HANH_CHINH_CAP1|default:'N/A' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ƒê∆°n v·ªã h√†nh ch√≠nh c·∫•p 2:</span>
                                    <span>{{ kv.DV_HANH_CHINH_CAP2|default:'N/A' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ƒê∆°n v·ªã h√†nh ch√≠nh c·∫•p 3:</span>
                                    <span>{{ kv.DV_HANH_CHINH_CAP3|default:'N/A' }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Tr·∫°ng th√°i:</span>
                                    <span>{{ kv.TRANG_THAI_KV|default:'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-data">Kh√¥ng c√≥ khu v·ª±c qu·∫£n l√Ω n√†o.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal ƒë·ªïi m·∫≠t kh·∫©u -->
    <div id="changePasswordModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u</h3>
                <button class="modal-close" data-modal-toggle="changePasswordModal">√ó</button>
            </div>
            <form action="{% url 'thanhvien:doi_mat_khau' %}" method="POST" class="modal-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="current_password" class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                    <input type="password" id="current_password" name="current_password" required class="form-input">
                </div>
                <div class="form-group">
                    <label for="new_password" class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="new_password" name="new_password" required class="form-input">
                </div>
                <div class="form-group">
                    <label for="new_password_confirmation" class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="new_password_confirmation" name="new_password_confirmation" required class="form-input">
                </div>
                <button type="submit" class="submit-btn">ƒê·ªïi m·∫≠t kh·∫©u</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('[data-modal-toggle]').forEach(button => {
        const modalId = button.getAttribute('data-modal-toggle');
        const modal = document.getElementById(modalId);
        button.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });
    });
    document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', () => {
            const modal = button.closest('.modal');
            modal.classList.add('hidden');
        });
    });
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });
    });
</script>
{% endblock %}